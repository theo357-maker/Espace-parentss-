 <!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Espace Parent - CS la Colombe</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<!-- PWA Meta Tags -->
  <meta name="application-name" content="TheoVêt">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="TheoVêt">
  <meta name="description" content="Solution complète de gestion de commerce de vêtements">
  <meta name="format-detection" content="telephone=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="msapplication-TileColor" content="#3498db">
  <meta name="msapplication-tap-highlight" content="no">
  <meta name="theme-color" content="#3498db">
<!-- Service Worker et mise à jour -->
<meta name="version" content="2.1.0">
<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">


  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="icon-192x192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icon-192x192.png">
  <link rel="apple-touch-icon" sizes="72x72" href="icon-72x72.png">
  <link rel="apple-touch-icon" sizes="167x167" href="icon-167x167.png">

  <!-- Manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- Styles et Bibliothèques -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<!-- Scripts de mise à jour -->
<script src="update-system.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>

    <style>
        :root {
            --primary: #3498db; --secondary: #2c3e50; --success: #27ae60;
            --danger: #e74c3c; --warning: #f39c12; --info: #1abc9c;
            --light: #ecf0f1; --dark: #34495e;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f5f6fa; }
        .hidden { display: none !important; }

        /* --- Styles Communs --- */
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .login-card { background: white; padding: 2rem; border-radius: 10px; width: 90%; max-width: 400px; text-align: center; }
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: 250px; background: white; box-shadow: 2px 0 10px rgba(0,0,0,0.08); flex-shrink: 0; transition: transform 0.3s ease; }
        .sidebar.collapsed { transform: translateX(-100%); }
        .nav-menu { list-style: none; padding: 1rem 0; margin: 0; }
        .nav-menu li { position: relative; }
        .nav-menu li a { display: flex; align-items: center; gap: 12px; padding: 14px 20px; color: var(--dark); text-decoration: none; font-weight: 500; }
        .nav-menu li a.active, .nav-menu li a:hover { background: #eaf5fc; color: var(--primary); }
        .main-content { flex: 1; display: flex; flex-direction: column; }
        .app-header { background: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        .content-area { padding: 1.5rem; flex: 1; }
        .page { display: none; }
        .page.active { display: block; }

/* Styles pour les badges de notification */
.notification-dot {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 12px;
    height: 12px;
    background-color: var(--danger);
    border-radius: 50%;
    animation: pulse 1.5s infinite;
    border: 2px solid white;
}

.notification-dot.small {
    width: 8px;
    height: 8px;
    top: 5px;
    right: 5px;
}

/* Animation pour les nouvelles notifications */
@keyframes highlight {
    0% { background-color: rgba(52, 152, 219, 0.1); }
    100% { background-color: transparent; }
}

.new-notification {
    animation: highlight 2s ease-in-out;
}

/* Styles pour les notifications en plein écran */
.fullscreen-notification {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 99999;
    padding: 20px;
    color: white;
    text-align: center;
}

/* Ajoutez dans la section CSS de parent.html */
.communique-card.expiring-soon {
    animation: pulse-border-expiring 2s infinite;
    border-left-color: var(--warning);
}

@keyframes pulse-border-expiring {
    0% { border-left-color: var(--warning); }
    50% { border-left-color: #ff9f43; }
    100% { border-left-color: var(--warning); }
}

/* Ajoutez dans le CSS existant */

.file-preview {
    margin: 1rem 0;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid var(--info);
}



/* Styles pour les notifications de mise à jour */
.update-toast {
  position: fixed;
  top: 20px;
  right: 20px;
  background: white;
  border-left: 4px solid #3498db;
  border-radius: 8px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.15);
  padding: 15px 20px;
  min-width: 300px;
  max-width: 400px;
  z-index: 9999;
  transform: translateX(120%);
  transition: transform 0.3s ease;
}

.update-toast.show {
  transform: translateX(0);
}

.update-toast.success {
  border-left-color: #27ae60;
}

.update-toast.warning {
  border-left-color: #f39c12;
}

.update-toast.danger {
  border-left-color: #e74c3c;
}

.update-toast.info {
  border-left-color: #3498db;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

.update-available {
  animation: pulse 2s infinite;
}


.file-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.5rem;
}

.file-icon {
    font-size: 2rem;
    color: var(--info);
}

.file-details h5 {
    margin: 0;
    color: var(--dark);
}

.file-details small {
    color: #666;
}

.file-preview-img {
    max-width: 100%;
    max-height: 300px;
    border: 1px solid #ddd;
    border-radius: 5px;
    margin-top: 1rem;
}

.fullscreen-notification h3 {
    font-size: 1.5rem;
    margin-bottom: 1rem;
    color: white;
}

.fullscreen-notification p {
    font-size: 1.1rem;
    margin-bottom: 2rem;
    max-width: 500px;
}

/* Badge sur l'icône de l'application */
.app-badge {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--danger);
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: bold;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    z-index: 9999;
}
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 500; color: white; }
        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        .btn-warning { background: var(--warning); }
        .btn-info { background: var(--info); }
        .btn-sm { padding: 6px 12px; font-size: 0.85rem; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 1.5rem; }
        .form-row { display: flex; gap: 1rem; }
        .alert { padding: 1rem; border-radius: 5px; margin-bottom: 1rem; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-error { background: #f8d7da; color: #721c24; }
        .alert-info { background: #d1ecf1; color: #0c5460; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 1.5rem; border-radius: 10px; width: 90%; max-width: 400px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .close-modal { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 500; }
        .badge-success { background-color: var(--success); color: white; }
        .badge-warning { background-color: var(--warning); color: white; }
        .badge-danger { background-color: var(--danger); color: white; }
        
        /* --- Styles pour le profil --- */
        .parent-profile { display: flex; align-items: center; gap: 1rem; }
        .parent-photo { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }
        .parent-photo-placeholder { width: 40px; height: 40px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; color: #999; }
        .photo-upload { text-align: center; margin: 1rem 0; }
        .photo-preview { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); margin: 0 auto 1rem; display: block; }
        .photo-placeholder { width: 100px; height: 100px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; color: #999; }
        .file-input { display: none; }
        .upload-btn { background: var(--info); color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; }
        
        /* --- Styles pour le reçu --- */
        .receipt { max-width: 500px; margin: 0 auto; background: white; padding: 1.5rem; border: 1px solid #ddd; font-family: Arial, sans-serif; font-size: 0.9rem; }
        .receipt-header { text-align: center; margin-bottom: 1.5rem; }
        .receipt-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 0.5rem; }
        .receipt-details { margin-bottom: 1.5rem; }
        .receipt-row { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        .receipt-divider { border-top: 1px solid #ddd; margin: 1rem 0; }
        .receipt-footer { text-align: center; margin-top: 1.5rem; font-size: 0.8rem; color: #666; }
        
        /* --- Styles pour l'activation de compte --- */
        .activation-steps { display: flex; justify-content: space-between; margin-bottom: 2rem; position: relative; }
        .activation-steps::before { content: ''; position: absolute; top: 20px; left: 0; right: 0; height: 2px; background: #ddd; z-index: 1; }
        .step { text-align: center; position: relative; z-index: 2; flex: 1; }
        .step-number { width: 40px; height: 40px; border-radius: 50%; background: #ddd; display: flex; align-items: center; justify-content: center; margin: 0 auto 0.5rem; font-weight: bold; }
        .step.active .step-number { background: var(--primary); color: white; }
        .step.completed .step-number { background: var(--success); color: white; }
        .step-label { font-size: 0.8rem; color: #666; }
        .step.active .step-label { color: var(--primary); font-weight: 500; }
        
        .child-item { background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid var(--primary); }
        .child-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .child-actions { display: flex; gap: 0.5rem; }
        
        /* --- Styles pour le tableau des notes --- */
        .grade-red { background-color: #ffebee; color: #c62828; font-weight: bold; }
        .grade-green { background-color: #e8f5e8; color: #2e7d32; font-weight: bold; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.9rem; }
        th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; font-weight: 600; }
        tr:hover { background-color: #f8f9fa; }

        /* --- Styles pour les présences et incidents --- */
        .presence-section { margin-bottom: 2rem; }
        .presence-controls { background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; }
        .presence-controls-row { display: flex; gap: 1rem; align-items: end; flex-wrap: wrap; }
        .presence-controls .form-group { margin-bottom: 0; flex: 1; min-width: 150px; }
        
        .attendance-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 0.5rem; margin-top: 1rem; }
        .attendance-day { padding: 0.8rem 0.5rem; border-radius: 8px; text-align: center; font-size: 0.8rem; font-weight: 500; border: 2px solid transparent; }
        .attendance-present { background-color: #e8f5e8; color: #2e7d32; border-color: #c8e6c9; }
        .attendance-absent { background-color: #ffebee; color: #c62828; border-color: #ffcdd2; }
        .attendance-late { background-color: #fff3e0; color: #ef6c00; border-color: #ffe0b2; }
        .attendance-empty { background-color: #f8f9fa; color: #6c757d; border: 1px dashed #dee2e6; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1.5rem 0; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 8px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .stat-number { font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem; }
        .stat-label { font-size: 0.9rem; color: #666; }
        
        .incident-item { border-left: 4px solid var(--warning); padding: 1.5rem; margin-bottom: 1rem; background: white; border-radius: 0 8px 8px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .incident-item.severity-eleve { border-left-color: var(--danger); }
        .incident-item.severity-moyen { border-left-color: var(--warning); }
        .incident-item.severity-faible { border-left-color: var(--info); }
        
        .incident-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.8rem; flex-wrap: wrap; gap: 0.5rem; }
        .incident-type { font-weight: bold; color: var(--dark); font-size: 1.1rem; }
        .incident-date { color: #666; font-size: 0.9rem; background: #f8f9fa; padding: 0.3rem 0.8rem; border-radius: 15px; }
        .incident-description { margin: 1rem 0; line-height: 1.5; color: #444; }
        .incident-severity { display: inline-block; padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.8rem; font-weight: bold; margin-right: 0.5rem; }
        .severity-eleve { background-color: var(--danger); color: white; }
        .severity-moyen { background-color: var(--warning); color: white; }
        .severity-faible { background-color: var(--info); color: white; }
        
        .no-data { text-align: center; padding: 3rem; color: #666; }
        .no-data i { font-size: 3rem; margin-bottom: 1rem; color: #ddd; }
        
        .loading { text-align: center; padding: 2rem; color: #666; }
        .loading i { font-size: 2rem; margin-bottom: 1rem; color: var(--primary); animation: spin 1s linear infinite; }
        
        /* --- Styles pour les horaires de classe --- */
        .class-schedule-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .class-schedule-table th, .class-schedule-table td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        .class-schedule-table th { background-color: var(--primary); color: white; font-weight: 600; }
        .class-schedule-table .hour-header { background-color: var(--info); color: white; }
        .class-schedule-table .day-header { background-color: var(--warning); color: white; }
        .schedule-controls { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .schedule-selector { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 1.5rem; }
        .no-schedule { text-align: center; padding: 2rem; color: #666; }
        .schedule-info { background: #e8f4fd; padding: 1rem; border-radius: 5px; margin-bottom: 1rem; }
        .timetable-section { margin-bottom: 2rem; }
        .timetable-section:last-child { margin-bottom: 0; }
        
        /* --- Styles pour les devoirs --- */
        .homework-list { margin-top: 1.5rem; }
        .homework-item { 
            border-left: 4px solid var(--info); 
            margin-bottom: 1rem; 
            padding: 1.5rem; 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .homework-item.overdue { border-left-color: var(--danger); }
        .homework-item.due-soon { border-left-color: var(--warning); }
        .homework-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
        .homework-title { font-size: 1.2rem; font-weight: 600; color: var(--dark); margin-bottom: 0.5rem; }
        .homework-meta { color: #666; font-size: 0.9rem; margin-bottom: 0.5rem; }
        .homework-description { margin-bottom: 1rem; line-height: 1.5; }
        .submission-status { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        .submission-pending { background-color: #fff3e0; color: #ef6c00; }
        .submission-submitted { background-color: #e8f5e8; color: #2e7d32; }
        .submission-overdue { background-color: #ffebee; color: #c62828; }
        .submission-graded { background-color: #e3f2fd; color: #1565c0; }
        
        .tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 1.5rem; }
        .tab { padding: 10px 20px; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab.active { border-bottom: 2px solid var(--primary); color: var(--primary); font-weight: 500; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* --- Styles pour les cotes primaires --- */
        .primary-grades-table th, .primary-grades-table td {
            text-align: center;
            padding: 10px;
        }
        
        .primary-grades-table th {
            background-color: var(--primary);
            color: white;
        }
        
        .period-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .period-btn {
            padding: 8px 16px;
            border: 2px solid var(--primary);
            background: white;
            color: var(--primary);
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .period-btn.active {
            background: var(--primary);
            color: white;
        }
        
        .period-btn:hover {
            background: var(--primary);
            color: white;
        }
        
        /* --- Styles pour les sous-onglets --- */
        .sub-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
        }
        
        .sub-tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-weight: 500;
            transition: all 0.3s ease;
            border-radius: 8px 8px 0 0;
        }
        
        .sub-tab.active {
            border-bottom: 2px solid var(--primary);
            color: var(--primary);
            background: white;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
        }
        
        .sub-tab:hover:not(.active) {
            background: #e9ecef;
        }
        
        .sub-tab-content {
            display: none;
            padding: 1.5rem;
            background: white;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        .sub-tab-content.active {
            display: block;
        }
        
        /* --- Styles pour les devoirs primaires --- */
        .primary-homework-item {
            border-left: 4px solid var(--info);
            margin-bottom: 1rem;
            padding: 1.5rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .primary-homework-item .homework-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .primary-homework-item .homework-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }
        
        .primary-homework-item .homework-meta {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .primary-homework-item .homework-description {
            margin-bottom: 1rem;
            line-height: 1.5;
        }
        
        /* --- Styles pour les notifications --- */
        .notification-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            animation: pulse 1.5s infinite;
        }

/* --- Styles pour les communiqués --- */
.communique-card {
    background: white;
    border-left: 4px solid var(--primary);
    margin-bottom: 1.5rem;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.communique-card.urgent {
    border-left-color: var(--danger);
    animation: pulse-border 2s infinite;
}

.communique-card.paid {
    border-left-color: var(--success);
    opacity: 0.8;
}

.communique-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.communique-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--dark);
    margin-bottom: 0.5rem;
}

.communique-meta {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 1rem;
}

.communique-meta span {
    margin-right: 1rem;
}

.communique-meta .badge {
    margin-right: 0.5rem;
}

.communique-content {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    margin: 1rem 0;
    font-family: 'Times New Roman', serif;
    line-height: 1.6;
}

.communique-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #eee;
    flex-wrap: wrap;
    gap: 1rem;
}

.communique-actions {
    display: flex;
    gap: 0.5rem;
}

@keyframes pulse-border {
    0% { border-left-color: var(--danger); }
    50% { border-left-color: #ff6b6b; }
    100% { border-left-color: var(--danger); }
}

/* Modal pour l'affichage complet du communiqué */
.communique-full-modal .modal-content {
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
}

.communique-full-content {
    font-family: 'Times New Roman', serif;
    line-height: 1.8;
}

.communique-full-header {
    text-align: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--primary);
}

.communique-full-logo {
    max-width: 120px;
    margin-bottom: 1rem;
}

.communique-full-title {
    font-size: 1.5rem;
    font-weight: bold;
    margin: 1rem 0;
    color: var(--dark);
}

.communique-full-date {
    text-align: right;
    font-style: italic;
    color: #666;
    margin-bottom: 2rem;
}

.communique-full-signature {
    margin-top: 3rem;
    text-align: right;
    padding-top: 1rem;
    border-top: 1px solid #ddd;
}

.signature-line {
    border-top: 1px solid #000;
    margin-top: 3rem;
    width: 300px;
    margin-left: auto;
}
        
        /* Notification Toast */
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-left: 4px solid var(--primary);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            padding: 15px 20px;
            min-width: 300px;
            max-width: 400px;
            z-index: 9999;
            transform: translateX(120%);
            transition: transform 0.3s ease;
        }
        
        .notification-toast.show {
            transform: translateX(0);
        }
        
        .notification-toast.success {
            border-left-color: var(--success);
        }
        
        .notification-toast.warning {
            border-left-color: var(--warning);
        }
        
        .notification-toast.danger {
            border-left-color: var(--danger);
        }
        
        .notification-toast.info {
            border-left-color: var(--info);
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .notification-title {
            font-weight: 600;
            font-size: 1rem;
        }
        
        .notification-close {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 1.2rem;
        }
        
        .notification-body {
            font-size: 0.9rem;
            color: #555;
        }
        
        .notification-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Menu mobile --- */
        .menu-toggle { display: none; background: none; border: none; font-size: 1.5rem; color: var(--dark); cursor: pointer; }
        
        @media (max-width: 768px) {
            .sidebar { position: fixed; height: 100%; z-index: 1000; }
            .menu-toggle { display: block; }
            .login-card { padding: 1.5rem; }
            .content-area { padding: 1rem; }
            .card { padding: 1rem; }
            .form-row { flex-direction: column; gap: 0.5rem; }
            .presence-controls-row { flex-direction: column; }
            .presence-controls .form-group { min-width: 100%; }
            .attendance-grid { grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); }
            .stats-grid { grid-template-columns: 1fr; }
            .incident-header { flex-direction: column; align-items: flex-start; }
            .tabs { flex-wrap: wrap; }
            .tab { flex: 1; text-align: center; min-width: 120px; }
            .period-selector { justify-content: center; }
            .period-btn { flex: 1; min-width: 120px; text-align: center; }
            .sub-tabs { flex-direction: column; }
            .sub-tab { border-radius: 8px; margin-bottom: 2px; }
            .sub-tab.active { border-bottom: 2px solid var(--primary); border-radius: 8px 8px 0 0; }
            .notification-toast {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <!-- Écran de connexion -->
    <div id="login-overlay" class="login-overlay">
        <div class="login-card">
            <h3>Espace Parent</h3>
            <p>Veuillez vous connecter pour continuer.</p>
            
            <!-- Formulaire de connexion -->
            <form id="login-form" style="margin-top: 1.5rem;">
                <div class="form-group">
                    <input type="text" id="login-matricule" class="form-control" placeholder="Matricule parent" required>
                </div>
                <div class="form-group">
                    <input type="password" id="login-password" class="form-control" placeholder="Mot de passe" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Connexion</button>
            </form>
            
            <p style="margin-top: 1rem;">
                <a href="#" id="show-activation-link">Activer mon compte</a>
            </p>
        </div>
        
        <!-- Formulaire d'activation de compte -->
        <div id="activation-card" class="login-card hidden">
            <h3>Activation du Compte Parent</h3>
            <p>Créez votre compte en associant le(s) matricule(s) de votre(vos) enfant(s)</p>
            
            <div class="activation-steps">
                <div class="step active" id="step-1">
                    <div class="step-number">1</div>
                    <div class="step-label">Informations</div>
                </div>
                <div class="step" id="step-2">
                    <div class="step-number">2</div>
                    <div class="step-label">Vérification</div>
                </div>
                <div class="step" id="step-3">
                    <div class="step-number">3</div>
                    <div class="step-label">Compte créé</div>
                </div>
            </div>
            
            <!-- Étape 1: Informations de base -->
            <div id="activation-step-1">
                <form id="activation-form-step1">
                    <div class="form-group">
                        <label>Votre nom complet</label>
                        <input type="text" id="parent-fullname" class="form-control" placeholder="Votre nom complet" required>
                    </div>
                    <div class="form-group">
                        <label>Votre email</label>
                        <input type="email" id="parent-email" class="form-control" placeholder="Votre adresse email" required>
                    </div>
                    <div class="form-group">
                        <label>Votre téléphone</label>
                        <input type="tel" id="parent-phone" class="form-control" placeholder="Votre numéro de téléphone" required>
                    </div>
                    <div class="form-group">
                        <label>Matricule de votre enfant</label>
                        <input type="text" id="child-matricule" class="form-control" placeholder="Matricule de l'élève" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Vérifier le matricule</button>
                </form>
                
                <p style="margin-top: 1rem;">
                    <a href="#" id="show-login-link">Retour à la connexion</a>
                </p>
            </div>
            
            <!-- Étape 2: Vérification et ajout d'enfants -->
            <div id="activation-step-2" class="hidden">
                <div class="alert alert-info">
                    <p><strong>Vérification réussie !</strong></p>
                    <p id="child-info">Élève trouvé: <span id="child-name"></span> - <span id="child-class"></span></p>
                </div>
                
                <div id="children-list">
                    <h4>Enfants associés à votre compte</h4>
                    <div id="children-container">
                        <!-- Les enfants seront ajoutés dynamiquement ici -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Ajouter un autre matricule (optionnel)</label>
                    <div class="form-row">
                        <input type="text" id="additional-matricule" class="form-control" placeholder="Matricule d'un autre enfant">
                        <button type="button" id="add-child-btn" class="btn btn-info">Ajouter</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Créer votre mot de passe</label>
                    <input type="password" id="parent-password" class="form-control" placeholder="Votre mot de passe" required>
                </div>
                
                <div class="form-group">
                    <label>Confirmer le mot de passe</label>
                    <input type="password" id="parent-password-confirm" class="form-control" placeholder="Confirmer le mot de passe" required>
                </div>
                
                <button type="button" id="create-account-btn" class="btn btn-success" style="width: 100%;">Créer mon compte</button>
                
                <p style="margin-top: 1rem;">
                    <a href="#" id="back-to-step1">Retour à l'étape précédente</a>
                </p>
            </div>
            
            <!-- Étape 3: Compte créé -->
            <div id="activation-step-3" class="hidden">
                <div class="alert alert-success">
                    <h4>Compte créé avec succès !</h4>
                    <p>Votre compte parent a été créé avec les informations suivientes :</p>
                </div>
                
                <div style="text-align: left; margin: 1rem 0;">
                    <p><strong>Matricule parent:</strong> <span id="created-parent-matricule"></span></p>
                    <p><strong>Nom:</strong> <span id="created-parent-name"></span></p>
                    <p><strong>Email:</strong> <span id="created-parent-email"></span></p>
                    <p><strong>Enfants associés:</strong> <span id="created-children-count"></span></p>
                </div>
                
                <p>Vous pouvez maintenant vous connecter avec votre matricule parent et votre mot de passe.</p>
                
                <button type="button" id="go-to-login-btn" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">Se connecter</button>
            </div>
        </div>
    </div>

    <!-- Contenu de l'application -->
    <div id="app-root" class="app-container hidden">
        <nav class="sidebar">
            <div style="padding: 1.5rem; text-align: center; border-bottom: 1px solid #eee;">
                <i class="fas fa-user-friends" style="font-size: 2rem; color: var(--primary);"></i>
                <h3 style="margin-top: 0.5rem;">Espace Parent</h3>
            </div>
            <ul class="nav-menu">
                <li><a href="#" class="active" data-page="dashboard"><i class="fas fa-tachometer-alt fa-fw"></i> Tableau de bord</a></li>
                <li><a href="#" data-page="grades"><i class="fas fa-chart-line fa-fw"></i> Cotes et Notes</a></li>
                <li><a href="#" data-page="presence-incidents"><i class="fas fa-clipboard-check fa-fw"></i> Présence & Incidents</a></li>

<li><a href="#" data-page="communiques"><i class="fas fa-newspaper fa-fw"></i> Communiqués</a></li>
                <li><a href="#" data-page="payments"><i class="fas fa-money-bill-wave fa-fw"></i> Paiements</a></li>
                <li><a href="#" data-page="homework"><i class="fas fa-book-open fa-fw"></i> Devoirs</a></li>
                <li><a href="#" data-page="timetable"><i class="fas fa-clock fa-fw"></i> Temps Horaire</a></li>
                <li><a href="#" data-page="children"><i class="fas fa-child fa-fw"></i> Mes Enfants</a></li>
                <li><a href="#" data-page="profile"><i class="fas fa-user fa-fw"></i> Mon Profil</a></li>
                <li><a href="#" data-page="communication"><i class="fas fa-envelope fa-fw"></i> Messagerie</a></li>
                <li><a href="#" data-page="notifications"><i class="fas fa-bell fa-fw"></i> Notifications</a></li>
            </ul>
        </nav>
        <div class="main-content">
            <header class="app-header">
                <button class="menu-toggle" id="menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h2 id="page-title">Tableau de bord</h2>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div class="parent-profile">
                        <div id="parent-photo-container">
                            <!-- La photo sera insérée ici dynamiquement -->
                        </div>
                        <span id="parent-name"></span>
                    </div>
                    <div style="position: relative;">
                        <button id="notification-bell" class="btn btn-info">
                            <i class="fas fa-bell"></i>
                            <span id="notification-count" class="hidden" style="position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 0.7rem; display: flex; align-items: center; justify-content: center;">0</span>
                        </button>
                    </div>
                    <button id="logout-btn" class="btn btn-danger">Déconnexion</button>
                </div>
            </header>
            <main class="content-area">
                <div id="global-alert" class="alert hidden"></div>

                <!-- Page: Tableau de bord -->
                <div id="dashboard-page" class="page active">
                    <div class="card">
                        <h3>Bienvenue dans votre espace parent</h3>
                        <p>Vous pouvez suivre la scolarité de vos enfants, gérer les paiements et communiquer avec l'établissement.</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="child-selector"><strong>Sélectionner un enfant pour voir ses informations :</strong></label>
                        <select id="child-selector" class="form-control"></select>
                    </div>
                    <div id="child-dashboard-content" class="hidden">
                        <div class="card">
                            <h3><i class="fas fa-chart-line"></i> Notes de l'Enfant</h3>
                            <div id="grades-container">
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>N°</th>
                                                <th>Matière</th>
                                                <th>Type d'évaluation</th>
                                                <th>Points maximum</th>
                                                <th>Points obtenus</th>
                                                <th>Pourcentage</th>
                                                <th>Enseignant</th>
                                                <th>Date</th>
                                            </tr>
                                        </thead>
                                        <tbody id="child-grades-table-body">
                                            <!-- Les notes de l'enfant seront chargées ici -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <h3><i class="fas fa-calendar-check"></i> Dernières Présences</h3>
                            <div id="attendance-container"></div>
                        </div>
                        <div class="card">
                            <h3><i class="fas fa-book-open"></i> Devoirs Récents</h3>
                            <div id="homework-container"></div>
                        </div>
                    </div>
                </div>

<!-- Page: Communiqués -->
<div id="communiques-page" class="page">
    <div class="card">
        <div class="form-row" style="justify-content: space-between; align-items: center;">
            <h3><i class="fas fa-newspaper"></i> Mes Communiqués</h3>
            <button id="refresh-communiques-btn" class="btn btn-primary btn-sm">
                <i class="fas fa-sync-alt"></i> Actualiser
            </button>
        </div>
        
        <div class="form-group">
            <label for="communique-child-selector"><strong>Filtrer par enfant :</strong></label>
            <select id="communique-child-selector" class="form-control">
                <option value="all">Tous mes enfants</option>
                <!-- Les enfants seront chargés dynamiquement -->
            </select>
        </div>
        
        <div class="form-group">
            <label for="communique-type-filter"><strong>Filtrer par type de frais :</strong></label>
            <select id="communique-type-filter" class="form-control">
                <option value="all">Tous les frais</option>
                <option value="Frais scolaires">Frais scolaires</option>
                <option value="Frais de l'état">Frais de l'état</option>
                <option value="visite">Visite</option>
                <option value="achat pull">Achat pull</option>
                <option value="Frais d'inscription">Frais d'inscription</option>
                <option value="Autres">Autres</option>
            </select>
        </div>
        
        <div id="communiques-list-container">
            <!-- Liste des communiqués personnalisés pour chaque enfant -->
        </div>
    </div>
</div>

                <!-- Page: Cotes et Notes (Regroupement) -->
                <div id="grades-page" class="page">
                    <div class="card">
                        <h3><i class="fas fa-chart-line"></i> Cotes et Notes des Enfants</h3>
                        <p>Consultez les notes et cotes publiées par les enseignants pour vos enfants.</p>
                    </div>
                    
                    <!-- Sous-onglets pour les différents niveaux -->
                    <div class="sub-tabs">
                        <div class="sub-tab active" data-sub-tab="secondary-grades">
                            <i class="fas fa-graduation-cap"></i> Notes Secondaire
                        </div>
                        <div class="sub-tab" data-sub-tab="primary-grades">
                            <i class="fas fa-chart-bar"></i> Cotes Primaire
                        </div>
                        <div class="sub-tab" data-sub-tab="kindergarten-grades">
                            <i class="fas fa-baby"></i> Cotes Maternelle
                        </div>
                    </div>
                    
                    <!-- Sous-onglet: Notes Secondaire -->
                    <div id="secondary-grades-tab" class="sub-tab-content active">
                        <div class="form-group">
                            <label for="secondary-grades-child-selector"><strong>Sélectionner un enfant du secondaire :</strong></label>
                            <select id="secondary-grades-child-selector" class="form-control"></select>
                        </div>
                        
                        <div id="secondary-grades-content" class="hidden">
                            <div class="loading" id="secondary-grades-loading">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Chargement des notes...</p>
                            </div>
                            <div id="secondary-grades-container">
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>N°</th>
                                                <th>Matière</th>
                                                <th>Type d'évaluation</th>
                                                <th>Points maximum</th>
                                                <th>Points obtenus</th>
                                                <th>Pourcentage</th>
                                                <th>Enseignant</th>
                                                <th>Date</th>
                                            </tr>
                                        </thead>
                                        <tbody id="secondary-grades-table-body">
                                            <!-- Les notes secondaires seront chargées ici -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sous-onglet: Cotes Primaire -->
                    <div id="primary-grades-tab" class="sub-tab-content">
                        <div class="form-group">
                            <label for="primary-grades-child-selector"><strong>Sélectionner un enfant du primaire :</strong></label>
                            <select id="primary-grades-child-selector" class="form-control"></select>
                        </div>
                        
                        <div id="primary-grades-content" class="hidden">
                            <div class="period-selector">
                                <button class="period-btn active" data-period="1ère période">1ère Période</button>
                                <button class="period-btn" data-period="2ème période">2ème Période</button>
                                <button class="period-btn" data-period="3ème période">3ème Période</button>
                                <button class="period-btn" data-period="4ème période">4ème Période</button>
                                <button class="period-btn" data-period="5ème période">5ème Période</button>
                            </div>
                            
                            <div class="loading" id="primary-grades-loading">
                                <i class="fas fa-spinner"></i>
                                <p>Chargement des cotes...</p>
                            </div>
                            
                            <div id="primary-grades-container">
                                <div class="table-container">
                                    <table class="primary-grades-table">
                                        <thead>
                                            <tr>
                                                <th>N°</th>
                                                <th>Nom du cours</th>
                                                <th>Cote Maximum (CM)</th>
                                                <th>Cote Obtenue (CO)</th>
                                                <th>Date de réception</th>
                                                <th>Nom de l'enseignant</th>
                                            </tr>
                                        </thead>
                                        <tbody id="primary-grades-table-body">
                                            <!-- Les cotes du primaire seront chargées ici -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div id="primary-grades-summary" class="card hidden" style="margin-top: 1.5rem;">
                                <h4>Résumé des Cotes</h4>
                                <div id="primary-grades-stats">
                                    <!-- Les statistiques des cotes seront affichées ici -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sous-onglet: Cotes Maternelle -->
                    <div id="kindergarten-grades-tab" class="sub-tab-content">
                        <div class="form-group">
                            <label for="kindergarten-grades-child-selector"><strong>Sélectionner un enfant de la maternelle :</strong></label>
                            <select id="kindergarten-grades-child-selector" class="form-control"></select>
                        </div>
                        
                        <div id="kindergarten-grades-content" class="hidden">
                            <div class="loading" id="kindergarten-grades-loading">
                                <i class="fas fa-spinner"></i>
                                <p>Chargement des cotes...</p>
                            </div>
                            
                            <div id="kindergarten-grades-container">
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>N°</th>
                                                <th>Compétence</th>
                                                <th>Niveau</th>
                                                <th>Appréciation</th>
                                                <th>Date d'évaluation</th>
                                                <th>Enseignant</th>
                                            </tr>
                                        </thead>
                                        <tbody id="kindergarten-grades-table-body">
                                            <!-- Les cotes maternelles seront chargées ici -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page: Présence & Incidents -->
                <div id="presence-incidents-page" class="page">
                    <div class="card">
                        <h3><i class="fas fa-clipboard-check"></i> Suivi des Présences et Incidents</h3>
                        <p>Consultez les présences publiées et les incidents signalés pour vos enfants.</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="presence-child-selector"><strong>Sélectionner un enfant :</strong></label>
                        <select id="presence-child-selector" class="form-control"></select>
                    </div>
                    
                    <div id="presence-incidents-content" class="hidden">
                        <!-- Section Présences -->
                        <div class="card presence-section">
                            <h3><i class="fas fa-calendar-alt"></i> Présences Mensuelles</h3>
                            
                            <div class="presence-controls">
                                <div class="presence-controls-row">
                                    <div class="form-group">
                                        <label>Mois</label>
                                        <select id="presence-month" class="form-control">
                                            <option value="0">Janvier</option>
                                            <option value="1">Février</option>
                                            <option value="2">Mars</option>
                                            <option value="3">Avril</option>
                                            <option value="4">Mai</option>
                                            <option value="5">Juin</option>
                                            <option value="6">Juillet</option>
                                            <option value="7">Août</option>
                                            <option value="8">Septembre</option>
                                            <option value="9">Octobre</option>
                                            <option value="10">Novembre</option>
                                            <option value="11">Décembre</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Année</label>
                                        <select id="presence-year" class="form-control">
                                            <!-- Les années seront chargées dynamiquement -->
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>&nbsp;</label>
                                        <button id="load-presence-btn" class="btn btn-primary" style="width: 100%;">
                                            <i class="fas fa-sync-alt"></i> Charger les présences
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="presence-stats">
                                <!-- Les statistiques seront affichées ici -->
                            </div>
                            
                            <div id="monthly-presence-container">
                                <div class="no-data">
                                    <i class="fas fa-calendar"></i>
                                    <p>Sélectionnez un mois et une année pour voir les présences de votre enfant.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Section Incidents -->
                        <div class="card presence-section">
                            <h3><i class="fas fa-exclamation-triangle"></i> Incidents Signalés</h3>
                            <div id="incidents-list-container">
                                <div class="loading">
                                    <i class="fas fa-spinner"></i>
                                    <p>Chargement des incidents...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page: Paiements -->
                <div id="payments-page" class="page">
                    <h2>Gestion des Paiements</h2>
                    <div class="form-group">
                        <label for="payment-child-selector"><strong>Sélectionner un enfant :</strong></label>
                        <select id="payment-child-selector" class="form-control"></select>
                    </div>
                    <div id="payment-content" class="hidden">
                        <div class="card">
                            <h3>Statut des Paiements</h3>
                            <div id="payment-status-container"></div>
                        </div>
                        <div class="card">
                            <h3>Paiement en ligne</h3>
                            <form id="online-payment-form">
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <label>Matricule de l'élève</label>
                                        <input type="text" id="payment-student-id" class="form-control" readonly>
                                    </div>
                                    <div class="form-group" style="flex: 2;">
                                        <label>Nom complet de l'élève</label>
                                        <input type="text" id="payment-student-name" class="form-control" readonly>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <label>Classe</label>
                                        <input type="text" id="payment-student-class" class="form-control" readonly>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label>Mois de paiement</label>
                                        <select id="payment-month" class="form-control" required>
                                            <option value="janvier">Janvier</option>
                                            <option value="février">Février</option>
                                            <option value="mars">Mars</option>
                                            <option value="avril">Avril</option>
                                            <option value="mai">Mai</option>
                                            <option value="juin">Juin</option>
                                            <option value="juillet">Juillet</option>
                                            <option value="août">Août</option>
                                            <option value="septembre">Septembre</option>
                                            <option value="octobre">Octobre</option>
                                            <option value="novembre">Novembre</option>
                                            <option value="décembre">Décembre</option>
                                        </select>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label>Montant (FCFA)</label>
                                        <input type="number" id="payment-amount" class="form-control" placeholder="30000" required>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">Valider le paiement</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Page: Devoirs (Regroupement) -->
                <div id="homework-page" class="page">
                    <div class="card">
                        <h3>Devoirs des Enfants</h3>
                        <p>Consultez les devoirs assignés à vos enfants selon leur niveau scolaire.</p>
                    </div>
                    
                    <!-- Sous-onglets pour les différents niveaux -->
                    <div class="sub-tabs">
                        <div class="sub-tab active" data-sub-tab="secondary-homework">
                            <i class="fas fa-graduation-cap"></i> Devoirs Secondaire
                        </div>
                        <div class="sub-tab" data-sub-tab="primary-homework">
                            <i class="fas fa-book"></i> Devoirs Primaire
                        </div>
                        <div class="sub-tab" data-sub-tab="kindergarten-homework">
                            <i class="fas fa-baby"></i> Devoirs Maternelle
                        </div>
                    </div>
                    
                    <!-- Sous-onglet: Devoirs Secondaire -->
                    <div id="secondary-homework-tab" class="sub-tab-content active">
                        <div class="form-group">
                            <label for="secondary-homework-child-selector"><strong>Sélectionner un enfant du secondaire :</strong></label>
                            <select id="secondary-homework-child-selector" class="form-control"></select>
                        </div>
                        
                        <div id="secondary-homework-content" class="hidden">
                            <div class="tabs">
                                <div class="tab active" data-tab="pending">Devoirs en cours</div>
                                <div class="tab" data-tab="submitted">Devoirs rendus</div>
                            </div>
                            
                            <div id="pending-tab" class="tab-content active">
                                <div class="loading" id="pending-homework-loading">
                                    <i class="fas fa-spinner"></i>
                                    <p>Chargement des devoirs en cours...</p>
                                </div>
                                <div id="pending-homework-container">
                                    <!-- Les devoirs en cours seront chargés dynamiquement ici -->
                                </div>
                            </div>
                            
                            <div id="submitted-tab" class="tab-content">
                                <div class="loading" id="submitted-homework-loading">
                                    <i class="fas fa-spinner"></i>
                                    <p>Chargement des devoirs rendus...</p>
                                </div>
                                <div id="submitted-homework-container">
                                    <!-- Les devoirs rendus seront chargés dynamiquement ici -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sous-onglet: Devoirs Primaire -->
                    <div id="primary-homework-tab" class="sub-tab-content">
                        <div class="form-group">
                            <label for="primary-homework-child-selector"><strong>Sélectionner un enfant du primaire :</strong></label>
                            <select id="primary-homework-child-selector" class="form-control"></select>
                        </div>
                        
                        <div id="primary-homework-content" class="hidden">
                            <div class="loading" id="primary-homework-loading">
                                <i class="fas fa-spinner"></i>
                                <p>Chargement des devoirs...</p>
                            </div>
                            <div id="primary-homework-container">
                                <!-- Les devoirs du primaire seront chargés dynamiquement ici -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sous-onglet: Devoirs Maternelle -->
                    <div id="kindergarten-homework-tab" class="sub-tab-content">
                        <div class="form-group">
                            <label for="kindergarten-homework-child-selector"><strong>Sélectionner un enfant de la maternelle :</strong></label>
                            <select id="kindergarten-homework-child-selector" class="form-control"></select>
                        </div>
                        
                        <div id="kindergarten-homework-content" class="hidden">
                            <div class="loading" id="kindergarten-homework-loading">
                                <i class="fas fa-spinner"></i>
                                <p>Chargement des devoirs...</p>
                            </div>
                            <div id="kindergarten-homework-container">
                                <!-- Les devoirs de la maternelle seront chargés dynamiquement ici -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Page: Temps Horaire -->
                <div id="timetable-page" class="page">
                    <div class="card">
                        <h3>Temps Horaire des Enfants</h3>
                        <p>Consultez les horaires de classe de vos enfants.</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="timetable-child-selector"><strong>Sélectionner un enfant :</strong></label>
                        <select id="timetable-child-selector" class="form-control"></select>
                    </div>
                    
                    <div id="timetable-content" class="hidden">
                        <div class="schedule-controls">
                            <div class="form-group" style="flex: 1;">
                                <label>Sélectionner le mois</label>
                                <input type="month" id="timetable-month" class="form-control">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>Sélectionner la semaine</label>
                                <select id="timetable-week" class="form-control">
                                    <option value="">-- Toutes les semaines --</option>
                                    <option value="1">Semaine 1</option>
                                    <option value="2">Semaine 2</option>
                                    <option value="3">Semaine 3</option>
                                    <option value="4">Semaine 4</option>
                                    <option value="5">Semaine 5</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 1; display: flex; align-items: flex-end;">
                                <button id="load-timetable-btn" class="btn btn-primary">
                                    <i class="fas fa-search"></i> Rechercher
                                </button>
                            </div>
                        </div>
                        
                        <div id="timetable-container">
                            <div class="loading" id="timetable-loading">
                                <i class="fas fa-spinner"></i>
                                <p>Chargement de l'horaire...</p>
                            </div>
                            <div id="timetable-display">
                                <!-- Le contenu de l'horaire sera chargé dynamiquement ici -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Page: Mes Enfants -->
                <div id="children-page" class="page">
                    <div class="card">
                        <div class="form-row" style="justify-content: space-between; align-items: center;">
                            <h3>Mes Enfants</h3>
                            <button id="add-child-account-btn" class="btn btn-primary">Ajouter un enfant</button>
                        </div>
                        
                        <div id="children-list-container">
                            <!-- Liste des enfants associés au compte -->
                        </div>
                    </div>
                </div>
                
                <!-- Page: Mon Profil -->
                <div id="profile-page" class="page">
                    <div class="card">
                        <h3>Mon Profil</h3>
                        
                        <!-- Photo de profil -->
                        <div class="photo-upload">
                            <div id="profile-photo-preview" class="photo-placeholder">
                                <i class="fas fa-user"></i>
                            </div>
                            <input type="file" id="profile-photo" class="file-input" accept="image/*">
                            <button type="button" class="upload-btn" onclick="document.getElementById('profile-photo').click()">
                                <i class="fas fa-upload"></i> Changer la photo
                            </button>
                        </div>
                        
                        <form id="profile-form">
                            <div class="form-group">
                                <label>Matricule Parent</label>
                                <input type="text" id="profile-matricule" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label>Nom Complet</label>
                                <input type="text" id="profile-fullname" class="form-control" required>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" id="profile-email" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label>Téléphone</label>
                                    <input type="tel" id="profile-phone" class="form-control" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Nouveau mot de passe (laisser vide pour ne pas changer)</label>
                                <input type="password" id="profile-new-password" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Confirmer le nouveau mot de passe</label>
                                <input type="password" id="profile-confirm-password" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Notifications Push</label>
                                <div style="margin-top: 10px;">
                                    <button type="button" id="enable-notifications-btn" class="btn btn-info btn-sm">
                                        <i class="fas fa-bell"></i> Activer les notifications
                                    </button>
                                    <button type="button" id="test-notification-btn" class="btn btn-warning btn-sm">
                                        <i class="fas fa-paper-plane"></i> Tester une notification
                                    </button>
                                </div>
                                <div id="notification-status" style="margin-top: 10px; font-size: 0.9rem;"></div>
                            </div>
                            <button type="submit" class="btn btn-primary">Mettre à jour le profil</button>
                        </form>
                    </div>
                </div>
                
                <!-- Page: Messagerie -->
                <div id="communication-page" class="page">
                    <div class="card">
                        <h3>Messagerie</h3>
                        <p>Module de messagerie en développement.</p>
                    </div>
                </div>
                
                <!-- Page: Notifications -->
                <div id="notifications-page" class="page">
                    <div class="card">
                        <div class="form-row" style="justify-content: space-between; align-items: center;">
                            <h3>Mes Notifications</h3>
                            <button id="clear-all-notifications-btn" class="btn btn-danger btn-sm">Tout effacer</button>
                        </div>
                        
                        <div class="form-group">
                            <label>Filtrer par type</label>
                            <select id="notification-filter" class="form-control">
                                <option value="all">Toutes les notifications</option>
                                <option value="grades">Nouvelles notes</option>
                                <option value="homework">Devoirs</option>
                                <option value="incidents">Incidents</option>
                                <option value="payments">Paiements</option>
                                <option value="messages">Messages</option>
                                <option value="announcements">Annonces</option>
                            </select>
                        </div>
                        
                        <div id="notifications-list-container">
                            <!-- Liste des notifications -->
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modale pour le code de paiement -->
    <div id="payment-code-modal" class="modal hidden">
        <div class="modal-content" style="text-align: center; max-width: 450px;">
            <div class="modal-header">
                <h3>Code de Paiement Généré</h3>
                <button class="close-modal">&times;</button>
            </div>
            <p>Présentez ce code au secrétariat pour finaliser le paiement.</p>
            <div id="generated-code" style="font-size: 1.5rem; font-weight: bold; color: var(--primary); background: #f0f0f0; padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 2px dashed var(--primary);"></div>
            
            <div id="receipt-preview" style="text-align: left; margin: 1rem 0;">
                <!-- Prévisualisation du reçu -->
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button class="btn btn-primary" onclick="closeModal('payment-code-modal')">Fermer</button>
                <button id="download-receipt-btn" class="btn btn-success">Télécharger le reçu</button>
            </div>
        </div>
    </div>

    <!-- Modale pour ajouter un enfant -->
    <div id="add-child-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Ajouter un enfant</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="add-child-form">
                <div class="form-group">
                    <label>Matricule de l'enfant</label>
                    <input type="text" id="new-child-matricule" class="form-control" placeholder="Matricule de l'élève" required>
                </div>
                <div class="alert alert-info hidden" id="child-verification-result">
                    <!-- Résultat de la vérification -->
                </div>
                <div class="form-group">
                    <label>Relation avec l'enfant</label>
                    <select id="child-relation" class="form-control" required>
                        <option value="parent">Parent</option>
                        <option value="tuteur">Tuteur</option>
                        <option value="autre">Autre</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Ajouter l'enfant</button>
            </form>
        </div>
    </div>

<!-- Modal pour l'affichage complet du communiqué -->
<div id="communique-full-modal" class="modal hidden communique-full-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Communiqué de Paiement</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div id="communique-full-content" class="communique-full-content">
          html
<!-- Modifiez le bouton d'impression dans le modal -->
<div style="text-align: center; margin-top: 1.5rem;">
    <button id="print-communique-btn" class="btn btn-primary">
        <i class="fas fa-print"></i> Imprimer
    </button>
    <button class="btn btn-secondary" onclick="closeModal('communique-full-modal')">
        Fermer
    </button>
</div>

    </div>
</div>

    
<script type="module">
// 1. INITIALISATION DE FIREBASE
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
import { getFirestore, collection, getDocs, query, where, addDoc, serverTimestamp, doc, updateDoc, orderBy, getDoc, setDoc, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
import { getMessaging, getToken, onMessage, isSupported, deleteToken } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-messaging.js";

const firebaseConfig = {
  apiKey: "AIzaSyBn7VIddclO7KtrXb5sibCr9SjVLjOy-qI",
  authDomain: "theo1d.firebaseapp.com",
  projectId: "theo1d",
  storageBucket: "theo1d.firebasestorage.app",
  messagingSenderId: "269629842962",
  appId: "1:269629842962:web:a80a12b04448fe1e595acb",
  measurementId: "G-TNSG1XFMDZ"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
let messaging = null;

// Initialiser Firebase Messaging
initializeFirebaseMessaging();

async function initializeFirebaseMessaging() {
    const isMessagingSupported = await isSupported();
    if (isMessagingSupported) {
        try {
            messaging = getMessaging(app);
            console.log("✅ Firebase Messaging initialisé");
            
            // Configurer les notifications en arrière-plan
            setupBackgroundNotifications();
        } catch (error) {
            console.error("❌ Erreur d'initialisation Firebase Messaging:", error);
        }
    } else {
        console.log("❌ Firebase Messaging n'est pas supporté");
    }
}

// 2. CONFIGURATION CLOUDINARY
const CLOUDINARY_CONFIG = {
    cloudName: 'diwn8sxtn',
    uploadPreset: 'cs_lacolombe'
};

// 3. FONCTION UPLOAD CLOUDINARY
async function uploadToCloudinary(file, folder = 'cs-lacolombe') {
    if (!file) return null;
    
    try {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_CONFIG.uploadPreset);
        formData.append('folder', folder);
        formData.append('tags', 'school_management');
        
        const response = await fetch(
            `https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloudName}/image/upload`,
            { 
                method: 'POST', 
                body: formData 
            }
        );
        
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        
        const data = await response.json();
        return data.secure_url;
        
    } catch (error) {
        console.error("❌ Erreur upload Cloudinary:", error);
        throw new Error(`Échec de l'upload Cloudinary: ${error.message}`);
    }
}

let currentParent = null;
let childrenList = [];
let parentPhotoFile = null;
let currentPrimaryPeriod = '1ère période';

// Variables pour les notifications
let notificationCounts = {
    dashboard: 0,
    grades: 0,
    'presence-incidents': 0,
    communiques: 0,
    payments: 0,
    homework: 0,
    timetable: 0,
    children: 0,
    profile: 0,
    communication: 0,
    notifications: 0
};

// === CONFIGURATION DES NOTIFICATIONS FIREBASE ===

async function setupBackgroundNotifications() {
    if (!messaging) {
        console.log("❌ Firebase Messaging non disponible");
        return;
    }

    try {
        // Vérifier la permission de notification
        if (Notification.permission === 'default') {
            const permission = await Notification.requestPermission();
            console.log('Permission de notification:', permission);
        }

        // Enregistrer le Service Worker pour les notifications d'arrière-plan
        if ('serviceWorker' in navigator) {
            const registration = await navigator.serviceWorker.register('./firebase-messaging-sw.js', {
                scope: '/'
            });
            console.log('✅ Service Worker Firebase enregistré:', registration.scope);
            
            // Configurer Firebase Messaging avec le Service Worker
            messaging = getMessaging(app);
            
            // Obtenir le token FCM
            const currentToken = await getToken(messaging, {
                vapidKey: 'BFc44CIL4VykUiY8_17s_HbUm5pRqhNhlFcy35H0XKuyFIq-2472MTfMZBfKMxW81DCHTkRB4xy_WaH-f3Ik2TM',
                serviceWorkerRegistration: registration
            });
            
            if (currentToken) {
                console.log('✅ Token FCM obtenu:', currentToken.substring(0, 30) + '...');
                await saveFCMToken(currentToken);
                
                // Écouter les messages en arrière-plan
                onBackgroundMessage();
            } else {
                console.log('❌ Aucun token FCM disponible');
                requestNotificationsPermission();
            }
        } else {
            console.log('❌ Service Worker non supporté');
        }
        
    } catch (error) {
        console.error('❌ Erreur configuration notifications:', error);
    }
}

async function saveFCMToken(token) {
    if (!currentParent) return;
    
    try {
        await updateDoc(doc(db, 'parents', currentParent.matricule), {
            fcmToken: token,
            notificationEnabled: true,
            lastTokenUpdate: serverTimestamp()
        });
        console.log('✅ Token FCM sauvegardé pour le parent:', currentParent.matricule);
    } catch (error) {
        console.error('❌ Erreur sauvegarde token:', error);
    }
}

async function requestNotificationsPermission() {
    if (!messaging) return;
    
    try {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
            console.log('✅ Permission de notification accordée');
            
            // Obtenir le token après l'autorisation
            const token = await getToken(messaging);
            if (token) {
                await saveFCMToken(token);
                showToast('Notifications activées avec succès!', 'success');
            }
        } else {
            console.log('❌ Permission de notification refusée');
        }
    } catch (error) {
        console.error('❌ Erreur demande permission:', error);
    }
}

// Écouter les messages en arrière-plan
function onBackgroundMessage() {
    if (!messaging) return;
    
    onMessage(messaging, (payload) => {
        console.log('📨 Message reçu en premier plan:', payload);
        
        // Afficher la notification
        showNotificationInApp(payload.notification?.title, payload.notification?.body, payload.data);
        
        // Mettre à jour le badge
        updateNotificationCount(1);
    });
}

// Afficher une notification dans l'application
function showNotificationInApp(title, body, data = {}) {
    if (!title || !body) return;
    
    // Créer un toast de notification
    const toast = document.createElement('div');
    toast.className = `notification-toast ${data.type || 'info'}`;
    toast.innerHTML = `
        <div class="notification-header">
            <div class="notification-title">${title}</div>
            <button class="notification-close">&times;</button>
        </div>
        <div class="notification-body">${body}</div>
        ${data.page ? `<div class="notification-actions">
            <button class="btn btn-primary btn-sm" onclick="navigateToPage('${data.page}', '${data.childId || ''}')">
                Voir
            </button>
        </div>` : ''}
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('show');
    }, 100);
    
    // Fermer le toast
    toast.querySelector('.notification-close').addEventListener('click', () => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    });
    
    // Fermer automatiquement après 10 secondes
    setTimeout(() => {
        if (toast.parentNode) {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }
    }, 10000);
}

// Navigation depuis les notifications
window.navigateToPage = function(page, childId = '') {
    const link = document.querySelector(`.nav-menu a[data-page="${page}"]`);
    if (link) {
        link.click();
        
        // Sélectionner l'enfant si spécifié
        if (childId) {
            setTimeout(() => {
                const selectorId = getSelectorForPage(page);
                const selector = document.getElementById(selectorId);
                if (selector) {
                    selector.value = childId;
                    selector.dispatchEvent(new Event('change'));
                }
            }, 500);
        }
    }
};

function getSelectorForPage(page) {
    const selectors = {
        'dashboard': 'child-selector',
        'grades': 'secondary-grades-child-selector',
        'presence-incidents': 'presence-child-selector',
        'homework': 'secondary-homework-child-selector',
        'communiques': 'communique-child-selector'
    };
    return selectors[page] || '';
}

// Mettre à jour le compteur de notifications
function updateNotificationCount(countChange = 0) {
    const notificationCount = document.getElementById('notification-count');
    let currentCount = parseInt(notificationCount.textContent) || 0;
    
    if (countChange !== 0) {
        currentCount += countChange;
        if (currentCount < 0) currentCount = 0;
        notificationCount.textContent = currentCount;
    }
    
    if (currentCount > 0) {
        notificationCount.classList.remove('hidden');
        // Mettre à jour le badge de l'application
        updateAppBadge(currentCount);
        
        // Animer la cloche
        const bell = document.getElementById('notification-bell');
        bell.style.animation = 'pulse 1.5s infinite';
    } else {
        notificationCount.classList.add('hidden');
        const bell = document.getElementById('notification-bell');
        bell.style.animation = '';
        
        // Réinitialiser le badge de l'application
        updateAppBadge(0);
    }
}

// Mettre à jour le badge de l'application (Badge API)
function updateAppBadge(count) {
    if ('setAppBadge' in navigator) {
        navigator.setAppBadge(count).catch(error => {
            console.error('Erreur badge API:', error);
        });
    }
}

// === ÉCOUTEURS EN TEMPS RÉEL POUR LES NOTIFICATIONS ===

function setupRealTimeListeners() {
    if (!currentParent) return;
    
    console.log('🎯 Configuration des écouteurs temps réel pour:', currentParent.matricule);
    
    try {
        // 1. Écouter les nouvelles notes (Secondaire)
        setupGradesListeners();
        
        // 2. Écouter les nouveaux devoirs
        setupHomeworkListeners();
        
        // 3. Écouter les nouveaux incidents
        setupIncidentsListeners();
        
        // 4. Écouter les nouvelles présences
        setupPresenceListeners();
        
        // 5. Écouter les nouveaux communiqués
        setupCommuniquesListeners();
        
        // 6. Écouter les nouveaux horaires
        setupTimetableListeners();
        
    } catch (error) {
        console.error('❌ Erreur configuration écouteurs:', error);
    }
}

function setupGradesListeners() {
    childrenList.forEach(child => {
        if (child.type === 'secondary') {
            const gradesQuery = query(
                collection(db, 'published_grades'),
                where('className', '==', child.class),
                orderBy('publishedAt', 'desc'),
                limit(1)
            );
            
            onSnapshot(gradesQuery, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const gradeData = change.doc.data();
                        const hasStudentGrade = gradeData.grades?.some(g => 
                            g.studentMatricule === child.matricule
                        );
                        
                        if (hasStudentGrade) {
                            sendNotification(
                                '📊 Nouvelle note publiée',
                                `${child.fullName} a une nouvelle note en ${gradeData.subject}`,
                                {
                                    type: 'grades',
                                    page: 'grades',
                                    childId: child.matricule,
                                    childName: child.fullName,
                                    gradeId: change.doc.id
                                }
                            );
                            updateNotificationBadge('grades', notificationCounts.grades + 1);
                        }
                    }
                });
            });
        }
    });
}

function setupHomeworkListeners() {
    childrenList.forEach(child => {
        if (child.type === 'secondary') {
            const homeworkQuery = query(
                collection(db, 'homework'),
                where('className', '==', child.class),
                orderBy('createdAt', 'desc'),
                limit(1)
            );
            
            onSnapshot(homeworkQuery, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const homework = change.doc.data();
                        sendNotification(
                            '📚 Nouveau devoir assigné',
                            `${child.fullName}: ${homework.subject} - ${homework.title}`,
                            {
                                type: 'homework',
                                page: 'homework',
                                childId: child.matricule,
                                childName: child.fullName,
                                homeworkId: change.doc.id
                            }
                        );
                        updateNotificationBadge('homework', notificationCounts.homework + 1);
                    }
                });
            });
        }
    });
}

function setupIncidentsListeners() {
    childrenList.forEach(child => {
        const incidentsQuery = query(
            collection(db, 'incidents'),
            where('studentMatricule', '==', child.matricule),
            orderBy('createdAt', 'desc'),
            limit(1)
        );
        
        onSnapshot(incidentsQuery, (snapshot) => {
            snapshot.docChanges().forEach(change => {
                if (change.type === 'added') {
                    const incident = change.doc.data();
                    sendNotification(
                        '⚠️ Nouvel incident signalé',
                        `${child.fullName}: ${incident.type || 'Incident'}`,
                        {
                            type: 'incidents',
                            page: 'presence-incidents',
                            childId: child.matricule,
                            childName: child.fullName,
                            incidentId: change.doc.id
                        }
                    );
                    updateNotificationBadge('presence-incidents', notificationCounts['presence-incidents'] + 1);
                }
            });
        });
    });
}

function setupPresenceListeners() {
    childrenList.forEach(child => {
        const today = new Date().toISOString().split('T')[0];
        const presenceQuery = query(
            collection(db, 'student_attendance'),
            where('studentId', '==', child.matricule),
            where('date', '==', today)
        );
        
        onSnapshot(presenceQuery, (snapshot) => {
            snapshot.docChanges().forEach(change => {
                if (change.type === 'added' || change.type === 'modified') {
                    const presence = change.doc.data();
                    if (presence.published === true) {
                        let statusText = '';
                        if (presence.status === 'absent') statusText = 'est absent';
                        else if (presence.status === 'late') statusText = 'est en retard';
                        else if (presence.status === 'present') statusText = 'est présent';
                        
                        if (statusText) {
                            sendNotification(
                                '📅 Mise à jour présence',
                                `${child.fullName} ${statusText} aujourd'hui`,
                                {
                                    type: 'presence',
                                    page: 'presence-incidents',
                                    childId: child.matricule,
                                    childName: child.fullName
                                }
                            );
                        }
                    }
                }
            });
        });
    });
}

function setupCommuniquesListeners() {
    if (!currentParent) return;
    
    const communiquesQuery = query(
        collection(db, 'parent_communique_relations'),
        where('parentId', '==', currentParent.matricule),
        orderBy('createdAt', 'desc'),
        limit(1)
    );
    
    onSnapshot(communiquesQuery, (snapshot) => {
        snapshot.docChanges().forEach(change => {
            if (change.type === 'added') {
                const relation = change.doc.data();
                getDoc(doc(db, 'parent_communiques', relation.communiqueId)).then(communiqueDoc => {
                    if (communiqueDoc.exists()) {
                        const communique = communiqueDoc.data();
                        sendNotification(
                            '📄 Nouveau communiqué de paiement',
                            `Nouveau communiqué pour ${relation.studentNames?.join(', ') || 'vos enfants'}`,
                            {
                                type: 'communiques',
                                page: 'communiques',
                                communiqueId: relation.communiqueId
                            }
                        );
                        updateNotificationBadge('communiques', notificationCounts.communiques + 1);
                    }
                });
            }
        });
    });
}

function setupTimetableListeners() {
    childrenList.forEach(child => {
        const timetableQuery = query(
            collection(db, 'student_schedules'),
            where('studentMatricule', '==', child.matricule),
            orderBy('publishedAt', 'desc'),
            limit(1)
        );
        
        onSnapshot(timetableQuery, (snapshot) => {
            snapshot.docChanges().forEach(change => {
                if (change.type === 'added') {
                    sendNotification(
                        '📅 Nouvel horaire publié',
                        `Nouvel horaire pour ${child.fullName}`,
                        {
                            type: 'timetable',
                            page: 'timetable',
                            childId: child.matricule,
                            childName: child.fullName
                        }
                    );
                    updateNotificationBadge('timetable', notificationCounts.timetable + 1);
                }
            });
        });
    });
}

// === FONCTION POUR ENVOYER LES NOTIFICATIONS FIREBASE ===

async function sendNotification(title, body, data = {}) {
    if (!currentParent?.fcmToken) {
        console.log('❌ Aucun token FCM disponible pour envoyer la notification');
        return;
    }
    
    try {
        const notificationData = {
            to: currentParent.fcmToken,
            notification: {
                title: title,
                body: body,
                icon: 'icon-192x192.png',
                badge: 'icon-72x72.png',
                click_action: window.location.origin
            },
            data: {
                type: data.type || 'general',
                page: data.page || '',
                childId: data.childId || '',
                childName: data.childName || '',
                timestamp: new Date().toISOString(),
                url: window.location.origin
            },
            webpush: {
                fcm_options: {
                    link: window.location.origin
                }
            }
        };
        
        // Envoyer la notification via Firebase Cloud Messaging
        const response = await fetch('https://fcm.googleapis.com/fcm/send', {
            method: 'POST',
            headers: {
                'Authorization': 'key=AAAAfLKJ3xM:APA91bHvQbHlU68Wt8Wk5Jx2KQ5m9X7Z6hYVq1pL8k9m1nQvY9wX9cL8d7f4q6r5s9v0d3e8a7b6c5d4e3f2g1h0i9j8k7l6m5n4o3p2q1r0s9t8u7v6w5x4y3z2a1b0c9d8e7f6',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(notificationData)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        console.log('✅ Notification envoyée via FCM');
        
        // Afficher aussi en local si l'app est ouverte
        if (document.visibilityState === 'visible') {
            showNotificationInApp(title, body, data);
        }
        
    } catch (error) {
        console.error('❌ Erreur envoi notification FCM:', error);
    }
}

// === FONCTIONS UTILITAIRES ===

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `notification-toast ${type}`;
    toast.innerHTML = `
        <div class="notification-header">
            <div class="notification-title">${type === 'success' ? '✅ Succès' : type === 'error' ? '❌ Erreur' : type === 'warning' ? '⚠️ Attention' : 'ℹ️ Information'}</div>
            <button class="notification-close">&times;</button>
        </div>
        <div class="notification-body">${message}</div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('show');
    }, 100);
    
    toast.querySelector('.notification-close').addEventListener('click', () => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    });
    
    setTimeout(() => {
        if (toast.parentNode) {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }
    }, 5000);
}

function showAlert(message, type = 'info') {
    const alertBox = document.getElementById('global-alert');
    alertBox.textContent = message;
    alertBox.className = `alert alert-${type}`;
    alertBox.classList.remove('hidden');
    setTimeout(() => alertBox.classList.add('hidden'), 6000);
}

// === GESTION DE L'AUTHENTIFICATION ===

onAuthStateChanged(auth, async (user) => {
    if (user) {
        const q = query(collection(db, 'parents'), where('uid', '==', user.uid));
        const snap = await getDocs(q);
        if (!snap.empty) {
            currentParent = { id: snap.docs[0].id, ...snap.docs[0].data() };
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('app-root').classList.remove('hidden');
            document.getElementById('parent-name').textContent = currentParent.fullName;
            
            // Afficher la photo de profil
            const photoContainer = document.getElementById('parent-photo-container');
            if (currentParent.photoURL) {
                photoContainer.innerHTML = `<img src="${currentParent.photoURL}" class="parent-photo" alt="Photo de profil">`;
                document.getElementById('profile-photo-preview').innerHTML = `<img src="${currentParent.photoURL}" class="photo-preview">`;
            } else {
                photoContainer.innerHTML = `<div class="parent-photo-placeholder"><i class="fas fa-user"></i></div>`;
            }
            
            await loadParentData();
            
            // Configurer les notifications Firebase
            await setupBackgroundNotifications();
            
            // Configurer les écouteurs en temps réel
            setupRealTimeListeners();
            
        } else {
            await signOut(auth);
            showAlert("Accès refusé.", "error");
        }
    } else {
        document.getElementById('login-overlay').classList.remove('hidden');
        document.getElementById('app-root').classList.add('hidden');
    }
});

// === CHARGEMENT DES DONNÉES PARENT ===

async function loadParentData() {
    const childSelectors = [
        document.getElementById('child-selector'), 
        document.getElementById('presence-child-selector'),
        document.getElementById('payment-child-selector'),
        document.getElementById('timetable-child-selector')
    ];
    
    const secondarySelectors = [
        document.getElementById('secondary-grades-child-selector'),
        document.getElementById('secondary-homework-child-selector')
    ];
    
    const primarySelectors = [
        document.getElementById('primary-grades-child-selector'),
        document.getElementById('primary-homework-child-selector')
    ];
    
    const kindergartenSelectors = [
        document.getElementById('kindergarten-grades-child-selector'),
        document.getElementById('kindergarten-homework-child-selector')
    ];
    
    childSelectors.forEach(s => s.innerHTML = '<option value="">-- Sélectionner un enfant --</option>');
    secondarySelectors.forEach(s => s.innerHTML = '<option value="">-- Sélectionner un enfant du secondaire --</option>');
    primarySelectors.forEach(s => s.innerHTML = '<option value="">-- Sélectionner un enfant du primaire --</option>');
    kindergartenSelectors.forEach(s => s.innerHTML = '<option value="">-- Sélectionner un enfant de la maternelle --</option>');

    if (currentParent && currentParent.children) {
        childrenList = [];
        
        for (const childData of currentParent.children) {
            const childMatricule = childData.matricule || childData;
            const childType = childData.type || 'secondary';
            
            let childDoc;
            if (childType === 'secondary') {
                childDoc = await getDoc(doc(db, 'students', childMatricule));
            } else if (childType === 'primary') {
                childDoc = await getDoc(doc(db, 'primary_students', childMatricule));
            } else {
                childDoc = await getDoc(doc(db, 'kindergarten_students', childMatricule));
            }
            
            if (childDoc.exists()) {
                const childInfo = childDoc.data();
                const childObj = {
                    matricule: childMatricule,
                    type: childType,
                    ...childInfo
                };
                childrenList.push(childObj);
                
                const displayText = `${childInfo.fullName} - ${childInfo.class} (${childType === 'secondary' ? 'Secondaire' : childType === 'primary' ? 'Primaire' : 'Maternelle'})`;
                
                childSelectors.forEach(s => s.innerHTML += `<option value="${childMatricule}">${displayText}</option>`);
                
                if (childType === 'secondary') {
                    secondarySelectors.forEach(s => s.innerHTML += `<option value="${childMatricule}">${childInfo.fullName} - ${childInfo.class}</option>`);
                } else if (childType === 'primary') {
                    primarySelectors.forEach(s => s.innerHTML += `<option value="${childMatricule}">${childInfo.fullName} - ${childInfo.class}</option>`);
                } else {
                    kindergartenSelectors.forEach(s => s.innerHTML += `<option value="${childMatricule}">${childInfo.fullName} - ${childInfo.class}</option>`);
                }
            }
        }
        
        updateChildrenPage();
        updateProfileForm();
        loadYearSelectors();
        
        // Initialiser les onglets devoirs
        setupHomeworkTabs();
        
        // Initialiser la gestion des périodes pour les cotes primaires
        setupPrimaryPeriods();
        
        // Initialiser les sous-onglets
        setupSubTabs();
        
        // Initialiser les sélecteurs pour les communiqués
        initCommuniqueSelectors();
    }
}

// === GESTION DES BOUTONS DE NOTIFICATIONS ===

document.getElementById('enable-notifications-btn').addEventListener('click', async () => {
    await requestNotificationsPermission();
});

document.getElementById('test-notification-btn').addEventListener('click', async () => {
    if (!currentParent) {
        showToast('Veuillez vous connecter d\'abord', 'error');
        return;
    }
    
    try {
        await sendNotification(
            '🔔 Test de notification',
            'Les notifications Firebase fonctionnent correctement!',
            {
                type: 'test',
                page: 'dashboard'
            }
        );
        showToast('Notification de test envoyée', 'success');
    } catch (error) {
        console.error('❌ Erreur envoi notification test:', error);
        showToast('Erreur lors de l\'envoi de la notification', 'error');
    }
});

// === RESTE DU CODE EXISTANT (NON MODIFIÉ) ===

// Les fonctions suivantes restent inchangées :
// - uploadToCloudinary
// - loadCommuniques, viewFullCommunique, printCommuniqueForParent, etc.
// - generateParentMatricule
// - Toutes les fonctions de chargement de données (notes, présences, devoirs, etc.)
// - Les fonctions d'interface utilisateur existantes

// ... (insérez ici le reste de votre code existant inchangé) ...

// === FONCTIONS DE GESTION DES COMMUNIQUÉS ===

// Initialiser les sélecteurs pour les communiqués
function initCommuniqueSelectors() {
    const childSelector = document.getElementById('communique-child-selector');
    
    // Réinitialiser
    childSelector.innerHTML = '<option value="all">Tous mes enfants</option>';
    
    // Ajouter chaque enfant
    childrenList.forEach(child => {
        const displayText = `${child.fullName} - ${child.class} (${child.type === 'secondary' ? 'Sec' : child.type === 'primary' ? 'Prim' : 'Mat'})`;
        childSelector.innerHTML += `<option value="${child.matricule}">${displayText}</option>`;
    });
    
    // Ajouter les événements
    childSelector.addEventListener('change', () => loadCommuniques());
    document.getElementById('communique-type-filter').addEventListener('change', () => loadCommuniques());
    document.getElementById('refresh-communiques-btn').addEventListener('click', () => loadCommuniques());
}

// Charger les communiqués
async function loadCommuniques() {
    const container = document.getElementById('communiques-list-container');
    container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i><p>Chargement des communiqués...</p></div>';

    if (!currentParent || childrenList.length === 0) {
        container.innerHTML = '<div class="no-data"><i class="fas fa-newspaper"></i><p>Aucun enfant associé à votre compte.</p></div>';
        return;
    }
    
    try {
        // 1. Récupérer les relations pour ce parent
        const parentCommuniquesQuery = query(
            collection(db, 'parent_communique_relations'),
            where('parentId', '==', currentParent.matricule),
            orderBy('createdAt', 'desc')
        );
        
        const parentCommuniquesSnap = await getDocs(parentCommuniquesQuery);
        
        console.log(`📄 ${parentCommuniquesSnap.size} relation(s) trouvée(s) pour le parent ${currentParent.matricule}`);
        
        if (parentCommuniquesSnap.empty) {
            container.innerHTML = '<div class="no-data"><i class="fas fa-newspaper"></i><p>Aucun communiqué reçu pour le moment.</p></div>';
            return;
        }
        
        // 2. Récupérer les détails de chaque communiqué non expiré
        let allCommuniques = [];
        
        for (const relationDoc of parentCommuniquesSnap.docs) {
            const relationData = relationDoc.data();
            const communiqueId = relationData.communiqueId;
            
            // Vérifier si le communiqué est expiré
            if (relationData.expirationDate) {
                const expirationDate = new Date(relationData.expirationDate);
                const now = new Date();
                
                if (expirationDate <= now) {
                    console.log(`⚠️ Communiqué ${communiqueId} expiré le ${expirationDate.toLocaleDateString('fr-FR')}`);
                    continue; // Passer au suivant
                }
            }

            // Récupérer le communiqué principal
            const communiqueDoc = await getDoc(doc(db, 'parent_communiques', communiqueId));
            
            if (communiqueDoc.exists()) {
                const communiqueData = communiqueDoc.data();
                
                // Vérifier aussi l'expiration dans le communiqué principal
                if (communiqueData.expirationDate) {
                    const expirationDate = new Date(communiqueData.expirationDate);
                    const now = new Date();
                    
                    if (expirationDate <= now) {
                        console.log(`⚠️ Communiqué principal ${communiqueId} expiré`);
                        continue;
                    }
                }
                
                allCommuniques.push({
                    id: communiqueId,
                    ...communiqueData,
                    relationId: relationDoc.id,
                    parentRelation: relationData,
                    affectedChildren: relationData.studentIds.map((studentId, index) => ({
                        matricule: studentId,
                        name: relationData.studentNames[index] || 'Nom inconnu',
                        class: relationData.studentClasses[index] || 'Classe inconnue'
                    }))
                });
            } else {
                console.warn(`⚠️ Communiqué ${communiqueId} non trouvé pour la relation ${relationDoc.id}`);
            }
        }
        
        if (allCommuniques.length === 0) {
            container.innerHTML = '<div class="no-data"><i class="fas fa-newspaper"></i><p>Aucun communiqué disponible pour le moment.</p></div>';
            return;
        }
        
        // 3. Trier par date (plus récent d'abord)
        allCommuniques.sort((a, b) => {
            const dateA = a.publishedAt?.toDate() || new Date(0);
            const dateB = b.publishedAt?.toDate() || new Date(0);
            return dateB - dateA;
        });
        
        // 4. Appliquer les filtres
        const selectedChild = document.getElementById('communique-child-selector').value;
        const selectedType = document.getElementById('communique-type-filter').value;
        
        let filteredCommuniques = allCommuniques;
        
        if (selectedChild !== 'all') {
            filteredCommuniques = filteredCommuniques.filter(communique => 
                communique.parentRelation.studentIds.includes(selectedChild)
            );
        }
        
        if (selectedType !== 'all') {
            filteredCommuniques = filteredCommuniques.filter(communique => 
                communique.feeType === selectedType
            );
        }
        
        // 5. Afficher les communiqués
        if (filteredCommuniques.length === 0) {
            container.innerHTML = '<div class="no-data"><i class="fas fa-filter"></i><p>Aucun communiqué correspondant aux filtres sélectionnés.</p></div>';
            return;
        }
        
        let html = '';
        
        filteredCommuniques.forEach((communique, index) => {
            const publishedDate = communique.publishedAt ? 
                new Date(communique.publishedAt.toDate()).toLocaleDateString('fr-FR', {
                    day: '2-digit',
                    month: 'long',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : 'Date inconnue';
            
            // Vérifier si c'est urgent
            const deadlineDate = new Date(communique.deadline);
            const now = new Date();
            const daysDiff = Math.ceil((deadlineDate - now) / (1000 * 60 * 60 * 24));
            const isUrgent = daysDiff <= 3 && daysDiff >= 0;
            const isOverdue = daysDiff < 0;
            const isPaid = communique.parentRelation.status === 'paid';
            
            // Calculer les jours avant expiration
            const expirationDate = communique.expirationDate ? new Date(communique.expirationDate) : null;
            const daysUntilExpiration = expirationDate ? Math.ceil((expirationDate - now) / (1000 * 60 * 60 * 24)) : null;
            
            // Classes CSS
            let cardClass = 'communique-card';
            if (isOverdue) cardClass += ' urgent';
            else if (isUrgent) cardClass += ' urgent';
            if (isPaid) cardClass += ' paid';
            if (daysUntilExpiration !== null && daysUntilExpiration <= 2) {
                cardClass += ' expiring-soon';
            }
            
            // Badges
            let statusBadge = '';
            if (isOverdue) {
                statusBadge = '<span class="badge badge-danger">En retard</span>';
            } else if (isUrgent) {
                statusBadge = '<span class="badge badge-warning">Urgent</span>';
            } else if (isPaid) {
                statusBadge = '<span class="badge badge-success">Payé</span>';
            } else {
                statusBadge = '<span class="badge badge-info">En attente</span>';
            }
            
            // Jours restants
            let daysText = '';
            if (isOverdue) {
                daysText = `<span style="color: var(--danger);"><i class="fas fa-exclamation-circle"></i> Retard de ${Math.abs(daysDiff)} jour(s)</span>`;
            } else {
                daysText = `<span style="color: ${isUrgent ? 'var(--warning)' : 'var(--success)'};">⏱️ ${daysDiff} jour(s) restant(s)</span>`;
            }
            
            // Info expiration
            let expirationText = '';
            if (expirationDate && daysUntilExpiration !== null) {
                if (daysUntilExpiration <= 0) {
                    expirationText = '<span style="color: var(--danger);"><i class="fas fa-hourglass-end"></i> Expiré</span>';
                } else if (daysUntilExpiration <= 2) {
                    expirationText = `<span style="color: var(--warning);"><i class="fas fa-hourglass-half"></i> Expire dans ${daysUntilExpiration} jour(s)</span>`;
                } else {
                    expirationText = `<span style="color: var(--info);"><i class="fas fa-hourglass-start"></i> Expire le ${expirationDate.toLocaleDateString('fr-FR')}</span>`;
                }
            }
            
            // Enfants concernés
            const childrenListHTML = communique.affectedChildren.map(child => 
                `<span class="badge badge-secondary">${child.name} (${child.matricule})</span>`
            ).join(' ');
            
            html += `
                <div class="${cardClass}" data-communique-id="${communique.id}" data-expiration="${expirationDate ? expirationDate.toISOString() : ''}">
                    <div class="communique-header">
                        <div style="flex: 1;">
                            <div class="communique-title">
                                ${communique.feeType} - ${communique.month} ${communique.schoolYear}
                            </div>
                            <div class="communique-meta">
                                <span><i class="far fa-calendar"></i> Publié le: ${publishedDate}</span>
                                <span><i class="far fa-clock"></i> Date limite: ${deadlineDate.toLocaleDateString('fr-FR')}</span>
                                <span>${statusBadge}</span>
                                <span>${daysText}</span>
                                ${expirationText ? `<span>${expirationText}</span>` : ''}
                            </div>
                        </div>
                        <div>
                            <span class="badge badge-primary">
                                <i class="fas fa-money-bill-wave"></i> ${parseFloat(communique.amount).toFixed(2)} $
                            </span>
                        </div>
                    </div>
                    
                    <div class="communique-content">
                        <p><strong>Objet :</strong> Rappel concernant le paiement des frais de <strong>${communique.feeType}</strong></p>
                        <p><strong>Enfants concernés :</strong> ${childrenListHTML}</p>
                        ${communique.message ? `<p><strong>Message :</strong> ${communique.message}</p>` : ''}
                    </div>
                    
                    <div class="communique-footer">
                        <div>
                            <strong>Classes concernées :</strong> ${communique.classes.join(', ')}
                        </div>
                        <div class="communique-actions">
                            <button class="btn btn-primary btn-sm" onclick="viewFullCommunique('${communique.id}')">
                                <i class="fas fa-eye"></i> Voir en détail
                            </button>
                            ${!isPaid ? `
                                <button class="btn btn-success btn-sm" onclick="markCommuniqueAsPaid('${communique.id}')">
                                    <i class="fas fa-check"></i> Marquer comme payé
                                </button>
                            ` : ''}
                            <button class="btn btn-info btn-sm" onclick="printCommuniqueForParent('${communique.id}')">
                                <i class="fas fa-print"></i> Imprimer
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
        // Vérifier l'expiration côté client
        setTimeout(checkClientSideExpiration, 100);
        
    } catch (error) {
        console.error('Erreur chargement communiqués:', error);
        container.innerHTML = '<div class="no-data"><i class="fas fa-exclamation-triangle"></i><p>Erreur de chargement des communiqués. Veuillez réessayer.</p></div>';
    }
}

// Vérifier et masquer les communiqués expirés côté client
function checkClientSideExpiration() {
    const now = new Date();
    const communiqueCards = document.querySelectorAll('.communique-card');
    
    communiqueCards.forEach(card => {
        const expirationAttr = card.getAttribute('data-expiration');
        if (expirationAttr) {
            const expirationDate = new Date(expirationAttr);
            
            if (expirationDate <= now) {
                card.style.display = 'none';
                console.log(`🗑️ Côté client: Communiqué ${card.getAttribute('data-communique-id')} masqué (expiré)`);
            }
        }
    });
}

// Afficher un communiqué en détail
async function viewFullCommunique(communiqueId) {
    console.log('🔍 Affichage communiqué:', communiqueId);
    
    try {
        // Récupérer le communiqué
        const communiqueDoc = await getDoc(doc(db, 'parent_communiques', communiqueId));
        
        if (!communiqueDoc.exists()) {
            showAlert('Communiqué non trouvé.', 'error');
            return;
        }
        
        const communiqueData = communiqueDoc.data();
        
        // Récupérer la relation parent-communiqué
        const relationQuery = query(
            collection(db, 'parent_communique_relations'),
            where('parentId', '==', currentParent.matricule),
            where('communiqueId', '==', communiqueId)
        );
        
        const relationSnap = await getDocs(relationQuery);
        
        if (relationSnap.empty) {
            showAlert('Aucune relation trouvée pour ce communiqué.', 'error');
            return;
        }
        
        const relationData = relationSnap.docs[0].data();
        
        // Vérifier si un enfant est sélectionné dans le filtre
        const selectedChild = document.getElementById('communique-child-selector').value;
        
        // Récupérer les détails des enfants concernés
        const childrenDetails = [];
        for (let i = 0; i < relationData.studentIds.length; i++) {
            const studentMatricule = relationData.studentIds[i];
            
            // Si un enfant est sélectionné dans le filtre, ne garder que celui-ci
            if (selectedChild && selectedChild !== 'all' && selectedChild !== studentMatricule) {
                continue;
            }
            
            // Chercher dans les 3 collections d'élèves
            let studentDoc = await getDoc(doc(db, 'students', studentMatricule));
            let studentType = 'secondary';
            
            if (!studentDoc.exists()) {
                studentDoc = await getDoc(doc(db, 'primary_students', studentMatricule));
                studentType = 'primary';
            }
            
            if (!studentDoc.exists()) {
                studentDoc = await getDoc(doc(db, 'kindergarten_students', studentMatricule));
                studentType = 'kindergarten';
            }
            
            if (studentDoc.exists()) {
                const studentData = studentDoc.data();
                childrenDetails.push({
                    matricule: studentMatricule,
                    name: studentData.fullName,
                    class: studentData.class,
                    type: studentType
                });
            }
        }
        
        // Si aucun enfant après filtrage
        if (childrenDetails.length === 0) {
            if (selectedChild && selectedChild !== 'all') {
                showAlert('Cet enfant n\'est pas concerné par ce communiqué.', 'warning');
            } else {
                showAlert('Aucun enfant trouvé pour ce communiqué.', 'error');
            }
            return;
        }
        
        // Dates
        const deadlineDate = new Date(communiqueData.deadline);
        const formattedDeadline = deadlineDate.toLocaleDateString('fr-FR', {
            day: '2-digit',
            month: 'long',
            year: 'numeric'
        });
        
        const today = new Date();
        const formattedToday = today.toLocaleDateString('fr-FR', {
            day: '2-digit',
            month: 'long',
            year: 'numeric'
        });
        
        // Construire le HTML
        let childrenHTML = '';
        childrenDetails.forEach((child, index) => {
            childrenHTML += `
                <div style="margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 5px;">
                    <p><strong>Enfant ${index + 1}:</strong> ${child.name}</p>
                    <p><strong>Matricule:</strong> ${child.matricule}</p>
                    <p><strong>Classe:</strong> ${child.class} (${child.type === 'secondary' ? 'Secondaire' : child.type === 'primary' ? 'Primaire' : 'Maternelle'})</p>
                </div>
            `;
        });
        
        // Calculer le montant par enfant
        const montantParEnfant = selectedChild && selectedChild !== 'all' 
            ? parseFloat(communiqueData.amount).toFixed(2)
            : (parseFloat(communiqueData.amount) / childrenDetails.length).toFixed(2);
        
        const fullContentHTML = `
            <div class="communique-full-header">
                <img src="R.png" alt="Logo CS la Colombe" class="communique-full-logo">
                <div class="communique-full-title">COMMUNIQUE DE PAIEMENT</div>
                <div>Complexe Scolaire la Colombe</div>
                <div>Lubumbashi, République Démocratique du Congo</div>
                <div>Tél: +243 XXX XXX XXX</div>
            </div>
            
            <div class="communique-full-date">
                Lubumbashi, le ${formattedToday}
            </div>
            
            <div style="margin-bottom: 2rem;">
                <p><strong>À l'attention de :</strong> ${currentParent.fullName}</p>
                <p><strong>Matricule parent :</strong> ${currentParent.matricule}</p>
                <p><strong>Email :</strong> ${currentParent.email}</p>
                <p><strong>Téléphone :</strong> ${currentParent.phone}</p>
            </div>
            
            <div style="margin-bottom: 2rem;">
                <h4>Enfants concernés par ce communiqué :</h4>
                ${childrenHTML}
            </div>
            
            <div>
                <p><strong>Objet :</strong> Rappel concernant le paiement des frais de <strong>${communiqueData.feeType}</strong></p>
                
                <p>Cher(s) parent(s), tuteur(s) légal(aux),</p>
                
                <p>L'établissement <strong>Complexe Scolaire la Colombe</strong> vous adresse ce communiqué concernant le règlement des frais de <strong>${communiqueData.feeType}</strong> pour l'année scolaire <strong>${communiqueData.schoolYear}</strong>.</p>
                
                <p>Nous vous rappelons que la date limite pour le paiement du solde des frais de <strong>${communiqueData.feeType}</strong> pour le mois de <strong>${communiqueData.month}</strong> est fixée au <strong>${formattedDeadline}</strong>.</p>
                
                <p><strong>Détail des montants dus :</strong></p>
                
                <ul>
                    ${selectedChild && selectedChild !== 'all'
                        ? `<li>Frais de ${communiqueData.feeType.toLowerCase()} pour ${childrenDetails[0].name} : <strong>$${montantParEnfant}</strong></li>`
                        : childrenDetails.map((child, index) => 
                            `<li>Frais de ${communiqueData.feeType.toLowerCase()} pour ${child.name} (${child.class}) : <strong>$${montantParEnfant}</strong></li>`
                        ).join('')
                    }
                    ${childrenDetails.length > 1 && (!selectedChild || selectedChild === 'all')
                        ? `<li><strong>TOTAL :</strong> $${parseFloat(communiqueData.amount).toFixed(2)}</li>`
                        : ''
                    }
                </ul>
                
                ${communiqueData.message ? `<p><strong>Message additionnel :</strong> ${communiqueData.message}</p>` : ''}
                
                <p>Classes concernées par ce communiqué : ${communiqueData.classes.join(', ')}</p>
                
                <p>Nous vous remercions de votre compréhension et de votre collaboration.</p>
                
                <p>Bonne collaboration,<br>
                La Direction</p>
            </div>
            
            <div class="communique-full-signature">
                <p>Le Directeur</p>
                <div class="signature-line"></div>
            </div>
        `;
        
        document.getElementById('communique-full-content').innerHTML = fullContentHTML;
        
        // Stocker les données pour l'impression
        window.currentCommuniqueForPrint = {
            id: communiqueId,
            data: communiqueData,
            children: childrenDetails,
            parent: currentParent,
            selectedChild: selectedChild,
            montantParEnfant: montantParEnfant
        };
        
        // Afficher le modal
        document.getElementById('communique-full-modal').classList.remove('hidden');
        
    } catch (error) {
        console.error('Erreur affichage communiqué:', error);
        showAlert('Erreur lors de l\'affichage du communiqué: ' + error.message, 'error');
    }
}

// Exposer la fonction au scope global
window.viewFullCommunique = viewFullCommunique;

// Imprimer un communiqué
async function printCommuniqueForParent(communiqueId) {
    try {
        const communiqueDoc = await getDoc(doc(db, 'parent_communiques', communiqueId));
        
        if (!communiqueDoc.exists()) {
            showAlert('Communiqué non trouvé.', 'error');
            return;
        }
        
        const communiqueData = communiqueDoc.data();
        
        // Récupérer la relation
        const relationQuery = query(
            collection(db, 'parent_communique_relations'),
            where('parentId', '==', currentParent.matricule),
            where('communiqueId', '==', communiqueId)
        );
        
        const relationSnap = await getDocs(relationQuery);
        
        if (relationSnap.empty) {
            showAlert('Aucune relation trouvée.', 'error');
            return;
        }
        
        const relationData = relationSnap.docs[0].data();
        
        // Récupérer les enfants
        const childrenDetails = [];
        for (const studentMatricule of relationData.studentIds) {
            // Chercher dans les 3 collections
            let studentDoc = await getDoc(doc(db, 'students', studentMatricule));
            if (!studentDoc.exists()) {
                studentDoc = await getDoc(doc(db, 'primary_students', studentMatricule));
            }
            if (!studentDoc.exists()) {
                studentDoc = await getDoc(doc(db, 'kindergarten_students', studentMatricule));
            }
            
            if (studentDoc.exists()) {
                const studentData = studentDoc.data();
                childrenDetails.push({
                    name: studentData.fullName,
                    matricule: studentMatricule,
                    class: studentData.class
                });
            }
        }
        
        const deadlineDate = new Date(communiqueData.deadline);
        const formattedDeadline = deadlineDate.toLocaleDateString('fr-FR', {
            day: '2-digit',
            month: 'long',
            year: 'numeric'
        });
        
        const today = new Date();
        const formattedToday = today.toLocaleDateString('fr-FR', {
            day: '2-digit',
            month: 'long',
            year: 'numeric'
        });
        
        // Générer le HTML à imprimer
        const printHTML = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>Communiqué de paiement - CS la Colombe</title>
                <style>
                    body { 
                        font-family: 'Times New Roman', serif; 
                        margin: 40px; 
                        font-size: 14px;
                        line-height: 1.6;
                    }
                    .header { 
                        text-align: center; 
                        margin-bottom: 30px; 
                        border-bottom: 2px solid #3498db;
                        padding-bottom: 20px;
                    }
                    .logo { 
                        max-width: 120px; 
                        margin-bottom: 10px; 
                    }
                    .title { 
                        font-size: 18px; 
                        font-weight: bold; 
                        margin: 15px 0; 
                        text-decoration: underline;
                    }
                    .date { 
                        text-align: right; 
                        margin-bottom: 30px; 
                        font-style: italic; 
                        color: #666;
                    }
                    .parent-info {
                        background: #f8f9fa;
                        padding: 15px;
                        border-radius: 5px;
                        margin-bottom: 20px;
                    }
                    .children-info {
                        margin: 20px 0;
                    }
                    .child-card {
                        background: #f1f8ff;
                        padding: 10px;
                        margin: 10px 0;
                        border-left: 4px solid #3498db;
                        border-radius: 0 5px 5px 0;
                    }
                    .signature { 
                        margin-top: 100px; 
                        text-align: right; 
                    }
                    .signature-line { 
                        border-top: 1px solid #000; 
                        margin-top: 50px; 
                        width: 300px; 
                        margin-left: auto; 
                    }
                    strong { font-weight: bold; }
                    ul { padding-left: 20px; }
                    @media print {
                        body { margin: 20px; }
                        .no-print { display: none; }
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <img src="R.png" alt="Logo CS la Colombe" class="logo">
                    <div class="title">COMMUNIQUE DE PAIEMENT</div>
                    <div>Complexe Scolaire la Colombe</div>
                    <div>Lubumbashi, République Démocratique du Congo</div>
                    <div>Tél: +243 XXX XXX XXX</div>
                </div>
                
                <div class="date">
                    Lubumbashi, le ${formattedToday}
                </div>
                
                <div class="parent-info">
                    <p><strong>À l'attention de :</strong> ${currentParent.fullName}</p>
                    <p><strong>Matricule parent :</strong> ${currentParent.matricule}</p>
                    <p><strong>Email :</strong> ${currentParent.email}</p>
                    <p><strong>Téléphone :</strong> ${currentParent.phone}</p>
                </div>
                
                <div class="children-info">
                    <h4>Enfants concernés par ce communiqué :</h4>
                    ${childrenDetails.map((child, index) => `
                        <div class="child-card">
                            <p><strong>Enfant ${index + 1}:</strong> ${child.name}</p>
                            <p><strong>Matricule :</strong> ${child.matricule}</p>
                            <p><strong>Classe :</strong> ${child.class}</p>
                        </div>
                    `).join('')}
                </div>
                
                <div>
                    <p><strong>Objet :</strong> Rappel concernant le paiement des frais de <strong>${communiqueData.feeType}</strong></p>
                    
                    <p>Cher(s) parent(s), tuteur(s) légal(aux),</p>
                    
                    <p>L'établissement <strong>Complexe Scolaire la Colombe</strong> vous adresse ce communiqué concernant le règlement des frais de <strong>${communiqueData.feeType}</strong> pour l'année scolaire <strong>${communiqueData.schoolYear}</strong>.</p>
                    
                    <p>Nous vous rappelons que la date limite pour le paiement du solde des frais de <strong>${communiqueData.feeType}</strong> pour le mois de <strong>${communiqueData.month}</strong> est fixée au <strong>${formattedDeadline}</strong>.</p>
                    
                    <p><strong>Détail des montants dus :</strong></p>
                    
                    <ul>
                        <li>Frais de ${communiqueData.feeType.toLowerCase()} : <strong>$${parseFloat(communiqueData.amount).toFixed(2)}</strong></li>
                    </ul>
                    
                    ${communiqueData.message ? `<p><strong>Message additionnel :</strong> ${communiqueData.message}</p>` : ''}
                    
                    <p>Classes concernées par ce communiqué : ${communiqueData.classes.join(', ')}</p>
                    
                    <p>Nous vous remercions de votre compréhension et de votre collaboration.</p>
                    
                    <p>Bonne collaboration,<br>
                    La Direction</p>
                </div>
                
                <div class="signature">
                    <p>Le Directeur</p>
                    <div class="signature-line"></div>
                </div>
                
                <div class="no-print" style="text-align: center; margin-top: 50px; color: #666; font-size: 12px;">
                    <p>Document généré automatiquement le ${new Date().toLocaleString('fr-FR')}</p>
                    <p>ID du communiqué: ${communiqueId}</p>
                </div>
                
                <script>
                    window.onload = function() {
                        window.print();
                        setTimeout(function() {
                            window.close();
                        }, 1000);
                    }
                <\/script>
            </body>
            </html>
        `;
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(printHTML);
        printWindow.document.close();
        
    } catch (error) {
        console.error('Erreur impression communiqué:', error);
        showAlert('Erreur lors de l\'impression: ' + error.message, 'error');
    }
}

// Marquer un communiqué comme payé
async function markCommuniqueAsPaid(communiqueId) {
    if (!confirm('Voulez-vous marquer ce communiqué comme payé ?')) {
        return;
    }
    
    try {
        // Mettre à jour le statut dans la relation parent-communiqué
        const relationQuery = query(
            collection(db, 'parent_communique_relations'),
            where('parentId', '==', currentParent.matricule),
            where('communiqueId', '==', communiqueId)
        );
        
        const relationSnap = await getDocs(relationQuery);
        
        if (!relationSnap.empty) {
            const relationDoc = relationSnap.docs[0];
            await updateDoc(doc(db, 'parent_communique_relations', relationDoc.id), {
                status: 'paid',
                paidAt: serverTimestamp()
            });
        }
        
        // Marquer aussi dans la collection student_communique_relations
        for (const child of childrenList) {
            const studentRelationRef = doc(db, 'student_communique_relations', `${child.matricule}_${communiqueId}`);
            await updateDoc(studentRelationRef, {
                status: 'paid',
                paidAt: serverTimestamp()
            });
        }
        
        showAlert('Communiqué marqué comme payé avec succès.', 'success');
        
        // Recharger la liste
        loadCommuniques();
        
    } catch (error) {
        console.error('Erreur marquage communiqué:', error);
        showAlert('Erreur lors du marquage: ' + error.message, 'error');
    }
}

// === FONCTIONS DE GÉNÉRATION DE MATRICULE ===

async function generateParentMatricule() {
    try {
        const parentsQuery = query(collection(db, 'parents'));
        const parentsSnap = await getDocs(parentsQuery);
        
        let maxNumber = 0;
        
        parentsSnap.forEach(doc => {
            const matricule = doc.data().matricule;
            if (matricule && matricule.startsWith('P')) {
                const numberPart = matricule.substring(1);
                const number = parseInt(numberPart);
                if (!isNaN(number) && number > maxNumber) {
                    maxNumber = number;
                }
            }
        });
        
        const newNumber = maxNumber + 1;
        return 'P' + newNumber.toString().padStart(3, '0');
        
    } catch (error) {
        console.error("Erreur génération matricule parent:", error);
        return 'P' + Math.floor(Math.random() * 900 + 100).toString();
    }
}

// === FONCTIONS DE CHARGEMENT DES NOTES ===

async function loadSecondaryGrades(studentId) {
    showLoading('secondary-grades-loading');
    const tableBody = document.getElementById('secondary-grades-table-body');
    
    try {
        // Récupérer toutes les notes publiées dans published_grades
        const gradesQuery = query(
            collection(db, 'published_grades'),
            orderBy('publishedAt', 'desc')
        );
        const gradesSnap = await getDocs(gradesQuery);
        
        if (gradesSnap.empty) {
            tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Aucune note disponible pour le moment.</td></tr>';
            hideLoading('secondary-grades-loading');
            return;
        }
        
        let allGrades = [];
        
        gradesSnap.forEach(doc => {
            const gradeData = doc.data();
            
            // Vérifier si cette évaluation concerne la classe de l'enfant
            // Trouver la note spécifique de cet enfant
            const studentGrade = gradeData.grades?.find(g => g.studentMatricule === studentId);
            
            if (studentGrade) {
                const percentage = (studentGrade.grade / gradeData.maxPoints) * 100;
                allGrades.push({
                    subject: gradeData.subject,
                    gradeType: gradeData.gradeType,
                    maxPoints: gradeData.maxPoints,
                    grade: studentGrade.grade,
                    percentage: percentage,
                    teacherName: gradeData.teacherName,
                    evaluationDate: gradeData.evaluationDate,
                    publishedAt: gradeData.publishedAt
                });
            }
        });
        
        if (allGrades.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Aucune note trouvée pour cet enfant.</td></tr>';
            hideLoading('secondary-grades-loading');
            return;
        }
        
        // Trier les notes par date (plus récentes d'abord)
        allGrades.sort((a, b) => {
            const dateA = a.publishedAt ? a.publishedAt.toDate() : new Date(0);
            const dateB = b.publishedAt ? b.publishedAt.toDate() : new Date(0);
            return dateB - dateA;
        });
        
        // Afficher les notes dans le tableau
        let html = '';
        allGrades.forEach((grade, index) => {
            const isGoodGrade = grade.grade >= (grade.maxPoints / 2);
            const gradeClass = isGoodGrade ? 'grade-green' : 'grade-red';
            const evaluationDate = grade.evaluationDate ? 
                grade.evaluationDate.toDate().toLocaleDateString('fr-FR') : 
                'Non spécifiée';
            
            html += `
                <tr>
                    <td>${index + 1}</td>
                    <td><strong>${grade.subject}</strong></td>
                    <td>${grade.gradeType}</td>
                    <td>${grade.maxPoints}</td>
                    <td class="${gradeClass}"><strong>${grade.grade}</strong></td>
                    <td>${grade.percentage.toFixed(1)}%</td>
                    <td>${grade.teacherName}</td>
                    <td>${evaluationDate}</td>
                </tr>
            `;
        });
        
        tableBody.innerHTML = html;
        hideLoading('secondary-grades-loading');
        
        // Marquer les notifications comme lues
        markNotificationsAsRead('grades');
        
    } catch (error) {
        console.error('Erreur chargement notes secondaire:', error);
        tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Erreur de chargement des notes.</td></tr>';
        hideLoading('secondary-grades-loading');
    }
}

async function loadPrimaryGrades(studentId, period) {
    showLoading('primary-grades-loading');
    const tableBody = document.getElementById('primary-grades-table-body');
    const summaryContainer = document.getElementById('primary-grades-summary');
    const statsContainer = document.getElementById('primary-grades-stats');
    
    tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Chargement des cotes...</td></tr>';
    summaryContainer.classList.add('hidden');
    
    try {
        const child = childrenList.find(c => c.matricule === studentId);
        if (!child || child.type !== 'primary') {
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Enfant non trouvé ou non du primaire</td></tr>';
            hideLoading('primary-grades-loading');
            return;
        }
        
        const gradesQuery = query(
            collection(db, 'primary_published_grades'),
            where('studentId', '==', studentId),
            where('period', '==', period)
        );
        
        const gradesSnap = await getDocs(gradesQuery);
        
        if (gradesSnap.empty) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center;">
                        <div class="no-data">
                            <i class="fas fa-chart-bar"></i>
                            <p>Aucune cote publiée pour la ${period}</p>
                        </div>
                    </td>
                </tr>
            `;
            hideLoading('primary-grades-loading');
            return;
        }
        
        let allGrades = [];
        let totalMax = 0;
        let totalObtained = 0;
        
        gradesSnap.forEach(doc => {
            const gradeData = doc.data();
            const publishedDate = gradeData.publishedAt ? 
                new Date(gradeData.publishedAt.toDate()).toLocaleDateString('fr-FR') : 'Non spécifiée';
            
            gradeData.grades.forEach(courseGrade => {
                allGrades.push({
                    courseName: courseGrade.courseName,
                    maxGrade: courseGrade.maxGrade,
                    obtainedGrade: courseGrade.obtainedGrade,
                    teacherName: courseGrade.teacherName,
                    publishedDate: publishedDate
                });
                
                totalMax += courseGrade.maxGrade;
                totalObtained += courseGrade.obtainedGrade;
            });
        });
        
        if (allGrades.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Aucune cote trouvée</td></tr>';
            hideLoading('primary-grades-loading');
            return;
        }
        
        let html = '';
        allGrades.forEach((grade, index) => {
            const percentage = (grade.obtainedGrade / grade.maxGrade) * 100;
            const gradeClass = percentage >= 50 ? 'grade-green' : 'grade-red';
            
            html += `
                <tr>
                    <td>${index + 1}</td>
                    <td>${grade.courseName}</td>
                    <td>${grade.maxGrade}</td>
                    <td class="${gradeClass}">${grade.obtainedGrade}</td>
                    <td>${grade.publishedDate}</td>
                    <td>${grade.teacherName}</td>
                </tr>
            `;
        });
        
        tableBody.innerHTML = html;
        
        // Afficher le résumé
        const overallPercentage = totalMax > 0 ? (totalObtained / totalMax * 100).toFixed(2) : 0;
        const averagePerCourse = allGrades.length > 0 ? (totalObtained / allGrades.length).toFixed(2) : 0;
        
        statsContainer.innerHTML = `
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number">${allGrades.length}</div>
                    <div class="stat-label">Cours évalués</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${totalObtained.toFixed(2)}/${totalMax}</div>
                    <div class="stat-label">Total Points</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${overallPercentage}%</div>
                    <div class="stat-label">Pourcentage</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${averagePerCourse}</div>
                    <div class="stat-label">Moyenne/Cours</div>
                </div>
            </div>
        `;
        
        summaryContainer.classList.remove('hidden');
        hideLoading('primary-grades-loading');
        
        // Marquer les notifications comme lues
        markNotificationsAsRead('grades');
        
    } catch (error) {
        console.error('Erreur chargement cotes primaire:', error);
        tableBody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center;">
                    <div class="no-data">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Erreur de chargement des cotes</p>
                    </div>
                </td>
            </tr>
        `;
        hideLoading('primary-grades-loading');
    }
}

async function loadKindergartenGrades(studentId) {
    showLoading('kindergarten-grades-loading');
    const tableBody = document.getElementById('kindergarten-grades-table-body');
    
    try {
        const child = childrenList.find(c => c.matricule === studentId);
        if (!child || child.type !== 'kindergarten') {
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Enfant non trouvé ou non de la maternelle</td></tr>';
            hideLoading('kindergarten-grades-loading');
            return;
        }
        
        const gradesQuery = query(
            collection(db, 'kindergarten_grades'),
            where('studentId', '==', studentId),
            orderBy('evaluationDate', 'desc')
        );
        
        const gradesSnap = await getDocs(gradesQuery);
        
        if (gradesSnap.empty) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center;">
                        <div class="no-data">
                            <i class="fas fa-baby"></i>
                            <p>Aucune cote publiée pour cet enfant</p>
                        </div>
                    </td>
                </tr>
            `;
            hideLoading('kindergarten-grades-loading');
            return;
        }
        
        let html = '';
        let index = 1;
        
        gradesSnap.forEach(doc => {
            const gradeData = doc.data();
            const evaluationDate = gradeData.evaluationDate ? 
                new Date(gradeData.evaluationDate.toDate()).toLocaleDateString('fr-FR') : 'Non spécifiée';
            
            // Niveaux possibles
            const levels = {
                'excellent': 'Excellent',
                'tres_bien': 'Très bien',
                'bien': 'Bien',
                'suffisant': 'Suffisant',
                'insuffisant': 'Insuffisant'
            };
            
            const levelText = levels[gradeData.level] || gradeData.level;
            const levelClass = gradeData.level === 'excellent' || gradeData.level === 'tres_bien' ? 'grade-green' : 
                             gradeData.level === 'insuffisant' ? 'grade-red' : '';
            
            html += `
                <tr>
                    <td>${index}</td>
                    <td>${gradeData.competence || 'Compétence'}</td>
                    <td class="${levelClass}">${levelText}</td>
                    <td>${gradeData.appreciation || 'Non spécifiée'}</td>
                    <td>${evaluationDate}</td>
                    <td>${gradeData.teacherName || 'Non spécifié'}</td>
                </tr>
            `;
            index++;
        });
        
        tableBody.innerHTML = html;
        hideLoading('kindergarten-grades-loading');
        
        // Marquer les notifications comme lues
        markNotificationsAsRead('grades');
        
    } catch (error) {
        console.error('Erreur chargement cotes maternelle:', error);
        tableBody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center;">
                    <div class="no-data">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Erreur de chargement des cotes</p>
                    </div>
                </td>
            </tr>
        `;
        hideLoading('kindergarten-grades-loading');
    }
}

// === FONCTIONS DE CHARGEMENT DES PRÉSENCES ===

async function loadChildMonthlyPresence(studentId, month, year) {
    const container = document.getElementById('monthly-presence-container');
    container.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i><p>Chargement des présences...</p></div>';
    
    try {
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        
        const startDate = firstDay.toISOString().split('T')[0];
        const endDate = lastDay.toISOString().split('T')[0];
        
        // Récupérer les présences de l'élève
        const allAttendanceSnap = await getDocs(collection(db, 'student_attendance'));
        const monthlyPresence = {};
        
        allAttendanceSnap.forEach(doc => {
            const data = doc.data();
            if (data.date >= startDate && data.date <= endDate && 
                data.studentId === studentId && data.published === true) {
                monthlyPresence[data.date] = data.status;
            }
        });
        
        // Calculer les statistiques
        let presentCount = 0;
        let absentCount = 0;
        let lateCount = 0;
        let totalDays = 0;
        
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
            const status = monthlyPresence[dateStr];
            
            if (status) {
                totalDays++;
                if (status === 'present') presentCount++;
                else if (status === 'absent') absentCount++;
                else if (status === 'late') lateCount++;
            }
        }
        
        // Afficher les statistiques
        const statsContainer = document.getElementById('presence-stats');
        const presenceRate = totalDays > 0 ? ((presentCount / totalDays) * 100).toFixed(1) : 0;
        
        statsContainer.innerHTML = `
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" style="color: #2e7d32;">${presentCount}</div>
                    <div class="stat-label">Présences</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #c62828;">${absentCount}</div>
                    <div class="stat-label">Absences</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #ef6c00;">${lateCount}</div>
                    <div class="stat-label">Retards</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #1565c0;">${presenceRate}%</div>
                    <div class="stat-label">Taux de présence</div>
                </div>
            </div>
        `;
        
        // Afficher le calendrier des présences
        let calendarHTML = `
            <h4 style="margin-bottom: 1rem;">Calendrier des présences - ${getMonthName(month)} ${year}</h4>
            <div class="attendance-grid">
        `;
        
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
            const status = monthlyPresence[dateStr];
            
            let statusClass = 'attendance-empty';
            let statusText = day.toString();
            let title = `${day} ${getMonthName(month)} ${year}`;
            
            if (status === 'present') {
                statusClass = 'attendance-present';
                statusText = '✓';
                title += ' - Présent';
            } else if (status === 'absent') {
                statusClass = 'attendance-absent';
                statusText = '✗';
                title += ' - Absent';
            } else if (status === 'late') {
                statusClass = 'attendance-late';
                statusText = '⌚';
                title += ' - Retard';
            } else {
                title += ' - Non renseigné';
            }
            
            calendarHTML += `
                <div class="attendance-day ${statusClass}" title="${title}">
                    ${statusText}
                </div>
            `;
        }
        
        calendarHTML += '</div>';
        
        // Légende
        calendarHTML += `
            <div style="margin-top: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div class="attendance-day attendance-present" style="width: 20px; height: 20px; padding: 0;">✓</div>
                    <span>Présent</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div class="attendance-day attendance-absent" style="width: 20px; height: 20px; padding: 0;">✗</div>
                    <span>Absent</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div class="attendance-day attendance-late" style="width: 20px; height: 20px; padding: 0;">⌚</div>
                    <span>Retard</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div class="attendance-day attendance-empty" style="width: 20px; height: 20px; padding: 0; font-size: 0.7rem;">1</div>
                    <span>Non renseigné</span>
                </div>
            </div>
        `;
        
        container.innerHTML = calendarHTML;
        
    } catch (error) {
        console.error('Erreur chargement présences mensuelles:', error);
        container.innerHTML = '<div class="no-data"><i class="fas fa-exclamation-triangle"></i><p>Erreur de chargement des présences.</p></div>';
    }
}

function getMonthName(monthIndex) {
    const months = [
        'Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin',
        'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'
    ];
    return months[monthIndex];
}

// === FONCTIONS DE CHARGEMENT DES INCIDENTS ===

async function loadChildIncidents(studentId) {
    const container = document.getElementById('incidents-list-container');
    container.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i><p>Chargement des incidents...</p></div>';
    
    try {
        const incidentsQuery = query(
            collection(db, 'incidents'),
            orderBy('createdAt', 'desc')
        );
        
        const incidentsSnap = await getDocs(incidentsQuery);
        
        if (incidentsSnap.empty) {
            container.innerHTML = `
                <div class="no-data">
                    <i class="fas fa-check-circle"></i>
                    <p>Aucun incident signalé pour cet enfant.</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        let incidentsFound = false;
        
        incidentsSnap.forEach(doc => {
            const incident = { id: doc.id, ...doc.data() };
            
            // Vérifiez les différents noms de champs possibles
            const isChildIncident = 
                incident.studentMatricule === studentId || 
                incident.studentId === studentId ||
                incident.matricule === studentId ||
                (incident.student && incident.student.matricule === studentId);
            
            if (isChildIncident) {
                incidentsFound = true;
                const date = incident.createdAt ? new Date(incident.createdAt.toDate()).toLocaleDateString('fr-FR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : 'Date inconnue';
                
                const severityClass = `severity-${incident.severity}`;
                
                html += `
                    <div class="incident-item ${severityClass}">
                        <div class="incident-header">
                            <span class="incident-type">${getIncidentTypeLabel(incident.type)}</span>
                            <span class="incident-date">${date}</span>
                        </div>
                        <div class="incident-description">
                            ${incident.description || 'Aucune description fournie.'}
                        </div>
                        <div>
                            <span class="incident-severity ${severityClass}">
                                ${getSeverityLabel(incident.severity)}
                            </span>
                        </div>
                    </div>
                `;
            }
        });
        
        if (!incidentsFound) {
            container.innerHTML = `
                <div class="no-data">
                    <i class="fas fa-check-circle"></i>
                    <p>Aucun incident signalé pour cet enfant.</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = html;
        
        // Marquer les notifications comme lues
        markNotificationsAsRead('presence-incidents');
        
    } catch (error) {
        console.error('Erreur chargement incidents:', error);
        container.innerHTML = `
            <div class="no-data">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Erreur de chargement des incidents: ${error.message}</p>
                <p style="font-size: 0.8rem; margin-top: 0.5rem;">
                    Si le problème persiste, veuillez contacter l'administration.
                </p>
            </div>
        `;
    }
}

function getIncidentTypeLabel(type) {
    const types = {
        'retard': 'Retard',
        'absenteisme': 'Absentéisme',
        'comportement': 'Problème de comportement',
        'autre': 'Autre incident'
    };
    return types[type] || type;
}

function getSeverityLabel(severity) {
    const severities = {
        'faible': 'Faible',
        'moyen': 'Moyen',
        'eleve': 'Élevé'
    };
    return severities[severity] || severity;
}

// === FONCTIONS DE CHARGEMENT DES DEVOIRS ===

async function loadSecondaryHomework(studentId) {
    await loadPendingHomework(studentId);
}

async function loadPendingHomework(studentId) {
    showLoading('pending-homework-loading');
    const container = document.getElementById('pending-homework-container');
    
    try {
        const child = childrenList.find(c => c.matricule === studentId);
        if (!child || child.type !== 'secondary') {
            container.innerHTML = '<p>Enfant non trouvé ou non du secondaire</p>';
            hideLoading('pending-homework-loading');
            return;
        }
        
        const homeworkQuery = query(
            collection(db, 'homework'), 
            where('className', '==', child.class),
            orderBy('dueDate', 'asc')
        );
        const homeworkSnap = await getDocs(homeworkQuery);

        if (homeworkSnap.empty) {
            container.innerHTML = `
                <div class="no-data">
                    <i class="fas fa-book-open"></i>
                    <h3>Aucun devoir en cours</h3>
                    <p>Votre enfant n'a aucun devoir à faire pour le moment.</p>
                </div>
            `;
            hideLoading('pending-homework-loading');
            return;
        }
        
        let html = '';
        const now = new Date();
        let hasPendingHomework = false;
        
        homeworkSnap.forEach(doc => {
            const hw = doc.data();
            
            const dueDate = hw.dueDate ? new Date(hw.dueDate.toDate()) : null;
            const dueDateStr = dueDate ? dueDate.toLocaleDateString('fr-FR') : 'Non spécifiée';
            
            // Vérifier si le devoir est en retard
            const isOverdue = dueDate && dueDate < now;
            const isDueSoon = dueDate && (dueDate - now) < (2 * 24 * 60 * 60 * 1000);
            
            // Vérifier si l'élève a déjà soumis ce devoir
            const hasSubmitted = hw.submissions && hw.submissions.some(
                submission => submission.studentMatricule === studentId
            );

            // Si déjà soumis, ne pas afficher dans "Devoirs en cours"
            if (hasSubmitted) {
                return;
            }

            hasPendingHomework = true;
            
            // Déterminer la classe CSS selon le statut
            let itemClass = 'homework-item';
            if (isOverdue) itemClass += ' overdue';
            else if (isDueSoon) itemClass += ' due-soon';
            
            const fileLink = hw.fileURL ? 
                `<a href="${hw.fileURL}" target="_blank" class="btn btn-primary btn-sm">
                    <i class="fas fa-download"></i> Télécharger ${hw.fileName || 'le fichier'}
                 </a>` : 
                '<p><em>Aucun fichier joint</em></p>';
            
            html += `
                <div class="${itemClass}">
                    <div class="homework-header">
                        <div>
                            <div class="homework-title">${hw.title || 'Devoir sans titre'}</div>
                            <div class="homework-meta">
                                <strong>Matière:</strong> ${hw.subject || 'Non spécifié'} | 
                                <strong>Enseignant:</strong> ${hw.teacherName || 'Non spécifié'} | 
                                <strong>Date de rendu:</strong> ${dueDateStr}
                            </div>
                        </div>
                        <div>
                            ${isOverdue ? 
                                '<span class="submission-status submission-overdue">En retard</span>' : 
                                '<span class="submission-status submission-pending">À rendre</span>'
                            }
                        </div>
                    </div>
                    <div class="homework-description">${hw.description || 'Aucune description'}</div>
                    ${fileLink}
                </div>
            `;
        });
        
        if (!hasPendingHomework) {
            container.innerHTML = `
                <div class="no-data">
                    <i class="fas fa-book-open"></i>
                    <h3>Aucun devoir en cours</h3>
                    <p>Votre enfant n'a aucun devoir à faire pour le moment.</p>
                </div>
            `;
        } else {
            container.innerHTML = html;
        }
        
        hideLoading('pending-homework-loading');
        
        // Marquer les notifications comme lues
        markNotificationsAsRead('homework');
        
    } catch (error) {
        console.error('Erreur chargement devoirs en cours:', error);
        container.innerHTML = `
            <div class="no-data">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Erreur de chargement</h3>
                <p>Impossible de charger les devoirs. Veuillez réessayer plus tard.</p>
            </div>
        `;
        hideLoading('pending-homework-loading');
    }
}

async function loadPrimaryHomework(studentId) {
    showLoading('primary-homework-loading');
    const container = document.getElementById('primary-homework-container');
    
    try {
        const child = childrenList.find(c => c.matricule === studentId);
        if (!child || child.type !== 'primary') {
            container.innerHTML = '<p>Enfant non trouvé ou non du primaire</p>';
            hideLoading('primary-homework-loading');
            return;
        }
        
        const homeworkQuery = query(
            collection(db, 'homework'),
            where('className', '==', child.class),
            where('published', '==', true),
            orderBy('createdAt', 'desc')
        );
        
        const homeworkSnap = await getDocs(homeworkQuery);

        if (homeworkSnap.empty) {
            container.innerHTML = `
                <div class="no-data">
                    <i class="fas fa-book"></i>
                    <h3>Aucun devoir publié</h3>
                    <p>Aucun devoir n'a été publié pour la classe de votre enfant.</p>
                </div>
            `;
            hideLoading('primary-homework-loading');
            return;
        }
        
        let html = '';
        
        homeworkSnap.forEach(doc => {
            const hw = doc.data();
            const dueDate = hw.dueDate ? new Date(hw.dueDate.toDate()).toLocaleDateString('fr-FR') : 'Non spécifiée';
            const createdAt = hw.createdAt ? new Date(hw.createdAt.toDate()).toLocaleDateString('fr-FR') : 'Non spécifiée';
            
            const fileLink = hw.fileURL ? 
                `<a href="${hw.fileURL}" target="_blank" class="btn btn-primary btn-sm">
                    <i class="fas fa-download"></i> Télécharger ${hw.fileName || 'le fichier'}
                 </a>` : 
                '<p><em>Aucun fichier joint</em></p>';
            
            html += `
                <div class="primary-homework-item">
                    <div class="homework-header">
                        <div>
                            <div class="homework-title">${hw.title || 'Devoir sans titre'}</div>
                            <div class="homework-meta">
                                <strong>Matière:</strong> ${hw.subject || 'Non spécifié'} | 
                                <strong>Enseignant:</strong> ${hw.teacherName || 'Non spécifié'} | 
                                <strong>Date de rendu:</strong> ${dueDate}
                            </div>
                        </div>
                    </div>
                    <div class="homework-description">${hw.description || 'Aucune description'}</div>
                    ${fileLink}
                    <div class="homework-meta" style="margin-top: 1rem;">
                        <small>Publié le: ${createdAt}</small>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        hideLoading('primary-homework-loading');
        
    } catch (error) {
        console.error('Erreur chargement devoirs primaire:', error);
        container.innerHTML = `
            <div class="no-data">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Erreur de chargement</h3>
                <p>Impossible de charger les devoirs. Veuillez réessayer plus tard.</p>
            </div>
        `;
        hideLoading('primary-homework-loading');
    }
}

// === FONCTIONS DE CHARGEMENT DES HORAIRES ===

async function loadTimetable() {
    showLoading('timetable-loading');
    const container = document.getElementById('timetable-display');
    
    const studentId = document.getElementById('timetable-child-selector').value;
    if (!studentId) {
        showAlert("Veuillez sélectionner un enfant", "error");
        hideLoading('timetable-loading');
        return;
    }
    
    try {
        const month = document.getElementById('timetable-month').value;
        const week = document.getElementById('timetable-week').value;
        
        const child = childrenList.find(c => c.matricule === studentId);
        if (!child) {
            container.innerHTML = '<p>Enfant non trouvé</p>';
            hideLoading('timetable-loading');
            return;
        }
        
        // Construire la requête selon les filtres
        let timetableQuery;
        
        if (month && week) {
            timetableQuery = query(
                collection(db, 'student_schedules'),
                where('studentMatricule', '==', studentId),
                where('month', '==', month),
                where('week', '==', week),
                orderBy('publishedAt', 'desc')
            );
        } else if (month) {
            timetableQuery = query(
                collection(db, 'student_schedules'),
                where('studentMatricule', '==', studentId),
                where('month', '==', month),
                orderBy('publishedAt', 'desc')
            );
        } else {
            timetableQuery = query(
                collection(db, 'student_schedules'),
                where('studentMatricule', '==', studentId),
                orderBy('publishedAt', 'desc')
            );
        }
        
        const timetableSnap = await getDocs(timetableQuery);
        
        if (timetableSnap.empty) {
            container.innerHTML = `
                <div class="no-schedule">
                    <i class="fas fa-calendar-times"></i>
                    <h3>Aucun horaire disponible</h3>
                    <p>L'horaire de votre enfant n'a pas encore été publié pour la période sélectionnée.</p>
                </div>
            `;
            hideLoading('timetable-loading');
            return;
        }
        
        let html = '';
        
        timetableSnap.forEach(doc => {
            const timetableData = doc.data();
            const publishedDate = timetableData.publishedAt.toDate().toLocaleDateString('fr-FR');
            
            html += `
                <div class="timetable-section">
                    <div class="schedule-info">
                        <h4>Horaire de la classe ${timetableData.className} - Semaine ${timetableData.week} (${timetableData.month})</h4>
                        <p>Publié le ${publishedDate}</p>
                    </div>
                    <div class="table-container">
                        <table class="class-schedule-table">
                            <thead>
                                <tr>
                                    <th class="hour-header">Heures</th>
                                    <th class="day-header">Lundi</th>
                                    <th class="day-header">Mardi</th>
                                    <th class="day-header">Mercredi</th>
                                    <th class="day-header">Jeudi</th>
                                    <th class="day-header">Vendredi</th>
                                    <th class="day-header">Samedi</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            // Générer les 7 lignes pour les 7 heures de cours
            for (let hour = 1; hour <= 7; hour++) {
                html += `<tr><td class="hour-header">${hour}ère heure</td>`;
                
                // Ajouter les cellules pour chaque jour
                const days = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                days.forEach(day => {
                    const course = timetableData.schedule.find(item => 
                        item.hour === hour && item.day === day
                    );
                    html += `<td>${course ? course.course : '-'}</td>`;
                });
                
                html += '</tr>';
            }
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        hideLoading('timetable-loading');
        
    } catch (error) {
        console.error('Erreur chargement horaire:', error);
        container.innerHTML = `
            <div class="no-schedule">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Erreur de chargement</h3>
                <p>Impossible de charger l'horaire. Veuillez réessayer plus tard.</p>
            </div>
        `;
        hideLoading('timetable-loading');
    }
}

// === FONCTIONS UTILITAIRES ===

function showLoading(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.classList.remove('hidden');
    }
}

function hideLoading(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.classList.add('hidden');
    }
}

function updateChildrenPage() {
    const container = document.getElementById('children-list-container');
    container.innerHTML = '';
    
    if (childrenList.length === 0) {
        container.innerHTML = '<p>Aucun enfant associé à votre compte</p>';
        return;
    }
    
    childrenList.forEach(child => {
        const childElement = document.createElement('div');
        childElement.className = 'child-item';
        childElement.innerHTML = `
            <div class="child-header">
                <strong>${child.fullName}</strong>
            </div>
            <div>Matricule: ${child.matricule}</div>
            <div>Classe: ${child.class}</div>
            <div>Type: ${child.type === 'secondary' ? 'Secondaire' : child.type === 'primary' ? 'Primaire' : 'Maternelle'}</div>
            <div>Date de naissance: ${child.birthdate || 'Non spécifiée'}</div>
        `;
        container.appendChild(childElement);
    });
}

function updateProfileForm() {
    if (currentParent) {
        document.getElementById('profile-matricule').value = currentParent.matricule;
        document.getElementById('profile-fullname').value = currentParent.fullName;
        document.getElementById('profile-email').value = currentParent.email;
        document.getElementById('profile-phone').value = currentParent.phone;
        
        // Mettre à jour le statut des notifications
        const statusElement = document.getElementById('notification-status');
        if (currentParent.notificationEnabled) {
            statusElement.textContent = '✅ Notifications activées';
            statusElement.style.color = 'var(--success)';
        } else {
            statusElement.textContent = '❌ Notifications désactivées';
            statusElement.style.color = 'var(--danger)';
        }
    }
}

function loadYearSelectors() {
    const currentYear = new Date().getFullYear();
    const yearSelectors = document.querySelectorAll('#presence-year');
    
    yearSelectors.forEach(select => {
        select.innerHTML = '';
        for (let year = currentYear - 1; year <= currentYear + 1; year++) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            if (year === currentYear) option.selected = true;
            select.appendChild(option);
        }
    });
    
    const currentMonth = new Date().getMonth();
    document.getElementById('presence-month').value = currentMonth;
    
    // Initialiser le mois pour l'horaire
    const today = new Date();
    const year = today.getFullYear();
    const month = (today.getMonth() + 1).toString().padStart(2, '0');
    const monthString = `${year}-${month}`;
    document.getElementById('timetable-month').value = monthString;
}

function setupHomeworkTabs() {
    document.querySelectorAll('#secondary-homework-content .tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('#secondary-homework-content .tab, #secondary-homework-content .tab-content').forEach(el => el.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
            
            const studentId = document.getElementById('secondary-homework-child-selector').value;
            if (studentId) {
                if (tab.dataset.tab === 'pending') {
                    loadPendingHomework(studentId);
                } else if (tab.dataset.tab === 'submitted') {
                    loadSubmittedHomework(studentId);
                }
            }
        });
    });
}

function setupPrimaryPeriods() {
    document.querySelectorAll('.period-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            currentPrimaryPeriod = this.getAttribute('data-period');
            
            const studentId = document.getElementById('primary-grades-child-selector').value;
            if (studentId) {
                loadPrimaryGrades(studentId, currentPrimaryPeriod);
            }
        });
    });
}

function setupSubTabs() {
    // Gestion des sous-onglets pour les cotes
    document.querySelectorAll('#grades-page .sub-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const subTabId = tab.getAttribute('data-sub-tab');
            
            document.querySelectorAll('#grades-page .sub-tab, #grades-page .sub-tab-content').forEach(el => el.classList.remove('active'));
            
            tab.classList.add('active');
            document.getElementById(`${subTabId}-tab`).classList.add('active');
            
            document.getElementById('secondary-grades-child-selector').value = '';
            document.getElementById('secondary-grades-content').classList.add('hidden');
            document.getElementById('primary-grades-child-selector').value = '';
            document.getElementById('primary-grades-content').classList.add('hidden');
            document.getElementById('kindergarten-grades-child-selector').value = '';
            document.getElementById('kindergarten-grades-content').classList.add('hidden');
        });
    });
    
    // Gestion des sous-onglets pour les devoirs
    document.querySelectorAll('#homework-page .sub-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const subTabId = tab.getAttribute('data-sub-tab');
            
            document.querySelectorAll('#homework-page .sub-tab, #homework-page .sub-tab-content').forEach(el => el.classList.remove('active'));
            
            tab.classList.add('active');
            document.getElementById(`${subTabId}-tab`).classList.add('active');
            
            document.getElementById('secondary-homework-child-selector').value = '';
            document.getElementById('secondary-homework-content').classList.add('hidden');
            document.getElementById('primary-homework-child-selector').value = '';
            document.getElementById('primary-homework-content').classList.add('hidden');
            document.getElementById('kindergarten-homework-child-selector').value = '';
            document.getElementById('kindergarten-homework-content').classList.add('hidden');
        });
    });
}

// === ÉVÉNEMENTS DES BOUTONS ET FORMULAIRES ===

document.getElementById('logout-btn').addEventListener('click', () => {
    signOut(auth);
    showAlert("Déconnexion réussie", "success");
});

// --- Activation de compte ---
document.getElementById('show-activation-link').addEventListener('click', (e) => {
    e.preventDefault();
    document.getElementById('login-form').closest('.login-card').classList.add('hidden');
    document.getElementById('activation-card').classList.remove('hidden');
});

document.getElementById('show-login-link').addEventListener('click', (e) => {
    e.preventDefault();
    document.getElementById('activation-card').classList.add('hidden');
    document.getElementById('login-form').closest('.login-card').classList.remove('hidden');
    resetActivationForm();
});

document.getElementById('back-to-step1').addEventListener('click', (e) => {
    e.preventDefault();
    goToActivationStep(1);
});

document.getElementById('go-to-login-btn').addEventListener('click', () => {
    document.getElementById('activation-card').classList.add('hidden');
    document.getElementById('login-form').closest('.login-card').classList.remove('hidden');
    resetActivationForm();
});

let verifiedChildren = [];

document.getElementById('activation-form-step1').addEventListener('submit', async (e) => {
    e.preventDefault();
    const childMatricule = document.getElementById('child-matricule').value;
    
    if (!childMatricule) {
        showAlert("Veuillez entrer un matricule d'élève", "error");
        return;
    }
    
    try {
        let studentData = null;
        let studentType = null;
        
        let studentDoc = await getDoc(doc(db, 'students', childMatricule));
        if (studentDoc.exists()) {
            studentData = studentDoc.data();
            studentType = 'secondary';
        } else {
            studentDoc = await getDoc(doc(db, 'primary_students', childMatricule));
            if (studentDoc.exists()) {
                studentData = studentDoc.data();
                studentType = 'primary';
            } else {
                studentDoc = await getDoc(doc(db, 'kindergarten_students', childMatricule));
                if (studentDoc.exists()) {
                    studentData = studentDoc.data();
                    studentType = 'kindergarten';
                }
            }
        }
        
        if (!studentData) {
            showAlert("Aucun élève trouvé avec ce matricule", "error");
            return;
        }
        
        if (studentData.parentId) {
            showAlert("Cet élève est déjà associé à un compte parent", "error");
            return;
        }
        
        verifiedChildren = [{
            matricule: childMatricule,
            name: studentData.fullName,
            class: studentData.class,
            type: studentType
        }];
        
        document.getElementById('child-name').textContent = studentData.fullName;
        document.getElementById('child-class').textContent = studentData.class;
        updateChildrenList();
        goToActivationStep(2);
        
    } catch (error) {
        console.error("Erreur vérification matricule:", error);
        showAlert("Erreur lors de la vérification du matricule: " + error.message, "error");
    }
});

document.getElementById('add-child-btn').addEventListener('click', async () => {
    const matricule = document.getElementById('additional-matricule').value;
    
    if (!matricule) {
        showAlert("Veuillez entrer un matricule", "error");
        return;
    }
    
    try {
        let studentData = null;
        let studentType = null;
        
        let studentDoc = await getDoc(doc(db, 'students', matricule));
        if (studentDoc.exists()) {
            studentData = studentDoc.data();
            studentType = 'secondary';
        } else {
            studentDoc = await getDoc(doc(db, 'primary_students', matricule));
            if (studentDoc.exists()) {
                studentData = studentDoc.data();
                studentType = 'primary';
            } else {
                studentDoc = await getDoc(doc(db, 'kindergarten_students', matricule));
                if (studentDoc.exists()) {
                    studentData = studentDoc.data();
                    studentType = 'kindergarten';
                }
            }
        }
        
        if (!studentData) {
            showAlert("Aucun élève trouvé avec ce matricule", "error");
            return;
        }
        
        if (studentData.parentId) {
            showAlert("Cet élève est déjà associé à un compte parent", "error");
            return;
        }
        
        if (verifiedChildren.find(child => child.matricule === matricule)) {
            showAlert("Cet élève est déjà dans la liste", "error");
            return;
        }
        
        verifiedChildren.push({
            matricule: matricule,
            name: studentData.fullName,
            class: studentData.class,
            type: studentType
        });
        
        updateChildrenList();
        document.getElementById('additional-matricule').value = '';
        showAlert("Enfant ajouté avec succès", "success");
        
    } catch (error) {
        console.error("Erreur ajout enfant:", error);
        showAlert("Erreur lors de l'ajout de l'enfant: " + error.message, "error");
    }
});

document.getElementById('create-account-btn').addEventListener('click', async () => {
    const fullName = document.getElementById('parent-fullname').value;
    const email = document.getElementById('parent-email').value;
    const phone = document.getElementById('parent-phone').value;
    const password = document.getElementById('parent-password').value;
    const confirmPassword = document.getElementById('parent-password-confirm').value;
    
    if (!fullName || !email || !phone || !password) {
        showAlert("Veuillez remplir tous les champs obligatoires", "error");
        return;
    }
    
    if (password !== confirmPassword) {
        showAlert("Les mots de passe ne correspondent pas", "error");
        return;
    }
    
    if (password.length < 6) {
        showAlert("Le mot de passe doit contenir au moins 6 caractères", "error");
        return;
    }
    
    if (verifiedChildren.length === 0) {
        showAlert("Veuillez ajouter au moins un enfant", "error");
        return;
    }
    
    try {
        const parentMatricule = await generateParentMatricule();
        const parentEmail = `parent.${parentMatricule}@cs-lacolombe.edu`;
        const userCredential = await createUserWithEmailAndPassword(auth, parentEmail, password);
        const user = userCredential.user;
        
        const parentData = {
            matricule: parentMatricule,
            fullName: fullName,
            email: email,
            phone: phone,
            authEmail: parentEmail,
            uid: user.uid,
            children: verifiedChildren.map(child => ({
                matricule: child.matricule,
                type: child.type
            })),
            notificationEnabled: false,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
        };
        
        const parentRef = doc(db, 'parents', parentMatricule);
        await setDoc(parentRef, parentData);
        
        for (const child of verifiedChildren) {
            let studentRef;
            if (child.type === 'secondary') {
                studentRef = doc(db, 'students', child.matricule);
            } else if (child.type === 'primary') {
                studentRef = doc(db, 'primary_students', child.matricule);
            } else {
                studentRef = doc(db, 'kindergarten_students', child.matricule);
            }
            
            await updateDoc(studentRef, {
                parentId: parentMatricule,
                parentName: fullName,
                parentEmail: email,
                parentPhone: phone,
                updatedAt: serverTimestamp()
            });
        }
        
        document.getElementById('created-parent-matricule').textContent = parentMatricule;
        document.getElementById('created-parent-name').textContent = fullName;
        document.getElementById('created-parent-email').textContent = email;
        document.getElementById('created-children-count').textContent = verifiedChildren.length;
        goToActivationStep(3);
        
    } catch (error) {
        console.error("Erreur création compte:", error);
        showAlert("Erreur lors de la création du compte: " + error.message, "error");
    }
});

document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const matricule = document.getElementById('login-matricule').value;
    const password = document.getElementById('login-password').value;
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Connexion...';
    submitBtn.disabled = true;

    try {
        const parentDoc = await getDoc(doc(db, 'parents', matricule));
        if (!parentDoc.exists()) {
            showAlert("Matricule parent incorrect", "error");
            return;
        }
        
        const parentData = parentDoc.data();
        const authEmail = parentData.authEmail;
        
        await signInWithEmailAndPassword(auth, authEmail, password);
        
    } catch (error) {
        console.error("Erreur connexion:", error);
        showAlert("Matricule ou mot de passe incorrect", "error");
    } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    }
});

// --- Tableau de bord ---
document.getElementById('child-selector').addEventListener('change', (e) => {
    const studentId = e.target.value;
    const dashboardContent = document.getElementById('child-dashboard-content');
    if (!studentId) {
        dashboardContent.classList.add('hidden');
        return;
    }
    dashboardContent.classList.remove('hidden');
    loadChildDashboard(studentId);
});

// --- Sous-onglet: Notes Secondaire ---
document.getElementById('secondary-grades-child-selector').addEventListener('change', (e) => {
    const studentId = e.target.value;
    const gradesContent = document.getElementById('secondary-grades-content');
    if (!studentId) {
        gradesContent.classList.add('hidden');
        return;
    }
    gradesContent.classList.remove('hidden');
    loadSecondaryGrades(studentId);
});

// --- Sous-onglet: Cotes Primaire ---
document.getElementById('primary-grades-child-selector').addEventListener('change', (e) => {
    const studentId = e.target.value;
    const gradesContent = document.getElementById('primary-grades-content');
    if (!studentId) {
        gradesContent.classList.add('hidden');
        return;
    }
    gradesContent.classList.remove('hidden');
    loadPrimaryGrades(studentId, currentPrimaryPeriod);
});

// --- Sous-onglet: Cotes Maternelle ---
document.getElementById('kindergarten-grades-child-selector').addEventListener('change', (e) => {
    const studentId = e.target.value;
    const gradesContent = document.getElementById('kindergarten-grades-content');
    if (!studentId) {
        gradesContent.classList.add('hidden');
        return;
    }
    gradesContent.classList.remove('hidden');
    loadKindergartenGrades(studentId);
});

// --- Présences et Incidents ---
document.getElementById('presence-child-selector').addEventListener('change', (e) => {
    const studentId = e.target.value;
    const content = document.getElementById('presence-incidents-content');
    if (!studentId) {
        content.classList.add('hidden');
        return;
    }
    content.classList.remove('hidden');
    loadChildIncidents(studentId);
});

document.getElementById('load-presence-btn').addEventListener('click', () => {
    const studentId = document.getElementById('presence-child-selector').value;
    const month = parseInt(document.getElementById('presence-month').value);
    const year = parseInt(document.getElementById('presence-year').value);
    
    if (!studentId) {
        showAlert("Veuillez sélectionner un enfant", "error");
        return;
    }
    
    loadChildMonthlyPresence(studentId, month, year);
});

// --- Sous-onglet: Devoirs Secondaire ---
document.getElementById('secondary-homework-child-selector').addEventListener('change', (e) => {
    const studentId = e.target.value;
    const homeworkContent = document.getElementById('secondary-homework-content');
    if (!studentId) {
        homeworkContent.classList.add('hidden');
        return;
    }
    homeworkContent.classList.remove('hidden');
    loadSecondaryHomework(studentId);
});

// --- Sous-onglet: Devoirs Primaire ---
document.getElementById('primary-homework-child-selector').addEventListener('change', (e) => {
    const studentId = e.target.value;
    const homeworkContent = document.getElementById('primary-homework-content');
    if (!studentId) {
        homeworkContent.classList.add('hidden');
        return;
    }
    homeworkContent.classList.remove('hidden');
    loadPrimaryHomework(studentId);
});

// --- Temps Horaire ---
document.getElementById('timetable-child-selector').addEventListener('change', (e) => {
    const studentId = e.target.value;
    const timetableContent = document.getElementById('timetable-content');
    if (!studentId) {
        timetableContent.classList.add('hidden');
        return;
    }
    timetableContent.classList.remove('hidden');
});

document.getElementById('load-timetable-btn').addEventListener('click', loadTimetable);

// --- Gestion du profil ---
document.getElementById('profile-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const fullName = document.getElementById('profile-fullname').value;
    const email = document.getElementById('profile-email').value;
    const phone = document.getElementById('profile-phone').value;
    const newPassword = document.getElementById('profile-new-password').value;
    const confirmPassword = document.getElementById('profile-confirm-password').value;
    
    if (!fullName || !email || !phone) {
        showAlert("Veuillez remplir tous les champs obligatoires", "error");
        return;
    }
    
    if (newPassword && newPassword !== confirmPassword) {
        showAlert("Les mots de passe ne correspondent pas", "error");
        return;
    }
    
    try {
        let photoURL = currentParent.photoURL;
        
        if (parentPhotoFile) {
            photoURL = await uploadToCloudinary(parentPhotoFile, `parents/${currentParent.matricule}`);
        }
        
        const updateData = {
            fullName,
            email,
            phone,
            photoURL,
            updatedAt: serverTimestamp()
        };
        
        await updateDoc(doc(db, 'parents', currentParent.matricule), updateData);
        
        for (const child of childrenList) {
            let studentRef;
            if (child.type === 'secondary') {
                studentRef = doc(db, 'students', child.matricule);
            } else if (child.type === 'primary') {
                studentRef = doc(db, 'primary_students', child.matricule);
            } else {
                studentRef = doc(db, 'kindergarten_students', child.matricule);
            }
            
            await updateDoc(studentRef, {
                parentName: fullName,
                parentEmail: email,
                parentPhone: phone,
                updatedAt: serverTimestamp()
            });
        }
        
        if (newPassword) {
            showAlert("La modification du mot de passe nécessite une réinitialisation. Veuillez utiliser la fonction 'Mot de passe oublié'.", "info");
        }
        
        currentParent = { ...currentParent, ...updateData };
        document.getElementById('parent-name').textContent = fullName;
        
        if (photoURL) {
            document.getElementById('parent-photo-container').innerHTML = `<img src="${photoURL}" class="parent-photo" alt="Photo de profil">`;
        }
        
        showAlert("Profil mis à jour avec succès", "success");
        parentPhotoFile = null;
        
    } catch (error) {
        console.error("Erreur mise à jour profil:", error);
        showAlert("Erreur lors de la mise à jour du profil: " + error.message, "error");
    }
});

// --- Navigation ---
document.querySelectorAll('.nav-menu a').forEach(link => {
    link.addEventListener('click', e => {
        e.preventDefault();
        const page = link.dataset.page;
        
        const pageId = page + '-page';
        document.querySelectorAll('.nav-menu a, .page').forEach(el => el.classList.remove('active'));
        link.classList.add('active');
        document.getElementById(pageId).classList.add('active');
        document.getElementById('page-title').textContent = link.textContent;
        
        // Fermer le menu sur mobile après clic
        if (window.innerWidth <= 768) {
            document.querySelector('.sidebar').classList.add('collapsed');
        }
    });
});

// === FONCTIONS D'ACTIVATION DE COMPTE ===

function goToActivationStep(step) {
    document.querySelectorAll('.step').forEach((el, index) => {
        if (index + 1 < step) {
            el.classList.add('completed');
            el.classList.remove('active');
        } else if (index + 1 === step) {
            el.classList.add('active');
            el.classList.remove('completed');
        } else {
            el.classList.remove('active', 'completed');
        }
    });
    
    document.getElementById('activation-step-1').classList.toggle('hidden', step !== 1);
    document.getElementById('activation-step-2').classList.toggle('hidden', step !== 2);
    document.getElementById('activation-step-3').classList.toggle('hidden', step !== 3);
}

function resetActivationForm() {
    document.getElementById('activation-form-step1').reset();
    document.getElementById('activation-step-2').classList.add('hidden');
    document.getElementById('activation-step-3').classList.add('hidden');
    document.getElementById('additional-matricule').value = '';
    verifiedChildren = [];
    updateChildrenList();
    goToActivationStep(1);
}

function updateChildrenList() {
    const container = document.getElementById('children-container');
    container.innerHTML = '';
    
    if (verifiedChildren.length === 0) {
        container.innerHTML = '<p>Aucun enfant ajouté</p>';
        return;
    }
    
    verifiedChildren.forEach((child, index) => {
        const childElement = document.createElement('div');
        childElement.className = 'child-item';
        childElement.innerHTML = `
            <div class="child-header">
                <strong>${child.name}</strong>
                <div class="child-actions">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeChild(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div>Matricule: ${child.matricule}</div>
            <div>Classe: ${child.class}</div>
            <div>Type: ${child.type === 'secondary' ? 'Secondaire' : child.type === 'primary' ? 'Primaire' : 'Maternelle'}</div>
        `;
        container.appendChild(childElement);
    });
}

window.removeChild = (index) => {
    verifiedChildren.splice(index, 1);
    updateChildrenList();
};

// === GESTION DU MENU MOBILE ===

document.getElementById('menu-toggle').addEventListener('click', () => {
    document.querySelector('.sidebar').classList.toggle('collapsed');
});

document.addEventListener('click', (e) => {
    const sidebar = document.querySelector('.sidebar');
    const menuToggle = document.getElementById('menu-toggle');
    
    if (!sidebar.contains(e.target) && !menuToggle.contains(e.target) && window.innerWidth <= 768) {
        sidebar.classList.add('collapsed');
    }
});

// === GESTION DES PHOTOS DE PROFIL ===

document.getElementById('profile-photo').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        if (file.size > 5 * 1024 * 1024) {
            showAlert("La photo ne doit pas dépasser 5MB", "error");
            return;
        }
        if (!file.type.startsWith('image/')) {
            showAlert("Veuillez sélectionner une image valide", "error");
            return;
        }
        parentPhotoFile = file;
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('profile-photo-preview').innerHTML = `<img src="${e.target.result}" class="photo-preview">`;
        }
        reader.readAsDataURL(file);
    }
});

// === BOUTON NOTIFICATION DANS LE HEADER ===

document.getElementById('notification-bell').addEventListener('click', () => {
    const link = document.querySelector('.nav-menu a[data-page="notifications"]');
    if (link) link.click();
});

// === INITIALISATION ===

// Cette partie reste inchangée, elle initialise l'application

// === INITIALISATION DE L'APPLICATION ===

// Démarrer l'application au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Application Espace Parent CS La Colombe initialisée');
    
    // Vérifier si Service Worker est supporté pour PWA
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js')
            .then(registration => {
                console.log('✅ Service Worker enregistré:', registration);
                
                // Vérifier les mises à jour
                registration.update();
            })
            .catch(error => {
                console.error('❌ Erreur Service Worker:', error);
            });
    }
    
    // Configurer les événements de modals
    document.querySelectorAll('.close-modal').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.modal').forEach(modal => modal.classList.add('hidden'));
        });
    });

    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.add('hidden');
            }
        });
    });

    // Gestionnaire pour le bouton d'impression dans le modal des communiqués
    const printCommuniqueBtn = document.getElementById('print-communique-btn');
    if (printCommuniqueBtn) {
        printCommuniqueBtn.addEventListener('click', function() {
            if (window.currentCommuniqueForPrint) {
                printCommuniqueForParent(window.currentCommuniqueForPrint.id);
            }
        });
    }

    // Fermer le modal des communiqués
    window.closeModal = (modalId) => document.getElementById(modalId).classList.add('hidden');

    // Initialiser le filtre de notifications
    const notificationFilter = document.getElementById('notification-filter');
    if (notificationFilter) {
        notificationFilter.addEventListener('change', (e) => {
            // À implémenter si besoin
        });
    }

    // Gestionnaire pour le bouton "Tout effacer" des notifications
    const clearNotificationsBtn = document.getElementById('clear-all-notifications-btn');
    if (clearNotificationsBtn) {
        clearNotificationsBtn.addEventListener('click', () => {
            // À implémenter si besoin
        });
    }

    // Vérifier la connexion internet
    window.addEventListener('online', () => {
        console.log('✅ Connexion internet rétablie');
        showToast('Connexion internet rétablie', 'success');
    });

    window.addEventListener('offline', () => {
        console.log('⚠️ Connexion internet perdue');
        showToast('Connexion internet perdue - Mode hors ligne', 'warning');
    });

    // Gestion du bouton de déconnexion
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showToast('Déconnexion réussie', 'success');
                
                // Nettoyer les données locales
                childrenList = [];
                currentParent = null;
                notificationCounts = {
                    dashboard: 0,
                    grades: 0,
                    'presence-incidents': 0,
                    communiques: 0,
                    payments: 0,
                    homework: 0,
                    timetable: 0,
                    children: 0,
                    profile: 0,
                    communication: 0,
                    notifications: 0
                };
                
                // Réinitialiser le compteur de notifications
                updateNotificationCount(0);
                
                // Réinitialiser l'interface
                document.getElementById('parent-name').textContent = '';
                document.getElementById('parent-photo-container').innerHTML = '<div class="parent-photo-placeholder"><i class="fas fa-user"></i></div>';
                
            } catch (error) {
                console.error('Erreur déconnexion:', error);
                showToast('Erreur lors de la déconnexion', 'error');
            }
        });
    }

    // Initialiser le menu mobile
    const menuToggle = document.getElementById('menu-toggle');
    if (menuToggle) {
        menuToggle.addEventListener('click', () => {
            document.querySelector('.sidebar').classList.toggle('collapsed');
        });
    }

    // Gestion du clic à l'extérieur pour fermer le menu mobile
    document.addEventListener('click', (e) => {
        const sidebar = document.querySelector('.sidebar');
        const menuToggle = document.getElementById('menu-toggle');
        
        if (sidebar && menuToggle) {
            if (!sidebar.contains(e.target) && !menuToggle.contains(e.target) && window.innerWidth <= 768) {
                sidebar.classList.add('collapsed');
            }
        }
    });

    // Initialiser la gestion des périodes pour les cotes primaires
    setupPrimaryPeriods();

    // Initialiser les onglets devoirs
    setupHomeworkTabs();

    // Initialiser les sous-onglets
    setupSubTabs();

    // Charger les sélecteurs d'année
    loadYearSelectors();

    // Initialiser la gestion des photos de profil
    const profilePhotoInput = document.getElementById('profile-photo');
    if (profilePhotoInput) {
        profilePhotoInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    showToast("La photo ne doit pas dépasser 5MB", "error");
                    return;
                }
                if (!file.type.startsWith('image/')) {
                    showToast("Veuillez sélectionner une image valide", "error");
                    return;
                }
                parentPhotoFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('profile-photo-preview');
                    if (preview) {
                        preview.innerHTML = `<img src="${e.target.result}" class="photo-preview" alt="Photo de profil">`;
                    }
                }
                reader.readAsDataURL(file);
            }
        });
    }

    // Vérifier l'état d'authentification initial
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            console.log('✅ Utilisateur connecté:', user.uid);
            
            try {
                // Récupérer les données du parent
                const q = query(collection(db, 'parents'), where('uid', '==', user.uid));
                const snap = await getDocs(q);
                
                if (!snap.empty) {
                    currentParent = { id: snap.docs[0].id, ...snap.docs[0].data() };
                    
                    // Masquer l'écran de connexion
                    document.getElementById('login-overlay').classList.add('hidden');
                    document.getElementById('app-root').classList.remove('hidden');
                    
                    // Mettre à jour l'interface
                    const parentNameElement = document.getElementById('parent-name');
                    if (parentNameElement) {
                        parentNameElement.textContent = currentParent.fullName;
                    }
                    
                    // Afficher la photo de profil
                    const photoContainer = document.getElementById('parent-photo-container');
                    if (photoContainer) {
                        if (currentParent.photoURL) {
                            photoContainer.innerHTML = `<img src="${currentParent.photoURL}" class="parent-photo" alt="Photo de profil">`;
                            const preview = document.getElementById('profile-photo-preview');
                            if (preview) {
                                preview.innerHTML = `<img src="${currentParent.photoURL}" class="photo-preview" alt="Photo de profil">`;
                            }
                        } else {
                            photoContainer.innerHTML = '<div class="parent-photo-placeholder"><i class="fas fa-user"></i></div>';
                        }
                    }
                    
                    // Charger les données du parent
                    await loadParentData();
                    
                    // Configurer les notifications Firebase
                    await setupBackgroundNotifications();
                    
                    // Configurer les écouteurs en temps réel
                    setupRealTimeListeners();
                    
                    // Charger les communiqués si sur la page
                    if (document.getElementById('communiques-page').classList.contains('active')) {
                        loadCommuniques();
                    }
                    
                    console.log('✅ Application chargée pour:', currentParent.fullName);
                    
                } else {
                    console.error('❌ Aucun parent trouvé avec cet UID');
                    await signOut(auth);
                    showToast("Accès refusé - Compte non trouvé", "error");
                }
                
            } catch (error) {
                console.error('❌ Erreur chargement données parent:', error);
                await signOut(auth);
                showToast("Erreur de chargement des données", "error");
            }
            
        } else {
            console.log('🔒 Aucun utilisateur connecté');
            
            // Afficher l'écran de connexion
            document.getElementById('login-overlay').classList.remove('hidden');
            document.getElementById('app-root').classList.add('hidden');
            
            // Réinitialiser les données
            childrenList = [];
            currentParent = null;
            
            // Réinitialiser le compteur de notifications
            updateNotificationCount(0);
            
            // Nettoyer l'interface
            const parentNameElement = document.getElementById('parent-name');
            if (parentNameElement) {
                parentNameElement.textContent = '';
            }
            
            const photoContainer = document.getElementById('parent-photo-container');
            if (photoContainer) {
                photoContainer.innerHTML = '<div class="parent-photo-placeholder"><i class="fas fa-user"></i></div>';
            }
        }
    });

    // Configuration des gestionnaires d'événements pour les formulaires
    const loginForm = document.getElementById('login-form');
    if (loginForm) {
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const matricule = document.getElementById('login-matricule').value;
            const password = document.getElementById('login-password').value;
            
            if (!matricule || !password) {
                showToast("Veuillez remplir tous les champs", "error");
                return;
            }
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Connexion...';
            submitBtn.disabled = true;
            
            try {
                const parentDoc = await getDoc(doc(db, 'parents', matricule));
                if (!parentDoc.exists()) {
                    showToast("Matricule parent incorrect", "error");
                    return;
                }
                
                const parentData = parentDoc.data();
                const authEmail = parentData.authEmail;
                
                await signInWithEmailAndPassword(auth, authEmail, password);
                showToast("Connexion réussie", "success");
                
            } catch (error) {
                console.error("Erreur connexion:", error);
                
                if (error.code === 'auth/wrong-password') {
                    showToast("Mot de passe incorrect", "error");
                } else if (error.code === 'auth/user-not-found') {
                    showToast("Utilisateur non trouvé", "error");
                } else if (error.code === 'auth/too-many-requests') {
                    showToast("Trop de tentatives. Veuillez réessayer plus tard", "error");
                } else {
                    showToast("Erreur de connexion", "error");
                }
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });
    }

    // Gestion du bouton de notification dans le header
    const notificationBell = document.getElementById('notification-bell');
    if (notificationBell) {
        notificationBell.addEventListener('click', () => {
            const link = document.querySelector('.nav-menu a[data-page="notifications"]');
            if (link) {
                link.click();
            }
        });
    }

    // Fonction pour marquer les notifications comme lues
    window.markNotificationsAsRead = function(page) {
        if (notificationCounts[page] > 0) {
            notificationCounts[page] = 0;
            updateNotificationBadge(page, 0);
            
            // Mettre à jour le compteur total
            const totalUnread = Object.values(notificationCounts).reduce((a, b) => a + b, 0);
            updateNotificationCount(-notificationCounts[page]);
            
            console.log(`✅ Notifications marquées comme lues pour: ${page}`);
        }
    };

    // Fonction pour mettre à jour le badge de notification spécifique
    function updateNotificationBadge(page, count) {
        const navItem = document.querySelector(`.nav-menu li a[data-page="${page}"]`);
        if (navItem) {
            const existingBadge = navItem.querySelector('.notification-badge');
            if (existingBadge) {
                existingBadge.remove();
            }
            
            if (count > 0) {
                const badge = document.createElement('span');
                badge.className = 'notification-badge';
                badge.textContent = count > 9 ? '9+' : count.toString();
                navItem.appendChild(badge);
            }
            
            notificationCounts[page] = count;
        }
    }

    // Fonction pour naviguer depuis une notification
    window.navigateFromNotification = function(page, childId = '') {
        const link = document.querySelector(`.nav-menu a[data-page="${page}"]`);
        if (link) {
            link.click();
            
            if (childId) {
                setTimeout(() => {
                    let selector;
                    switch(page) {
                        case 'grades':
                            selector = document.getElementById('secondary-grades-child-selector');
                            break;
                        case 'presence-incidents':
                            selector = document.getElementById('presence-child-selector');
                            break;
                        case 'homework':
                            selector = document.getElementById('secondary-homework-child-selector');
                            break;
                        case 'communiques':
                            selector = document.getElementById('communique-child-selector');
                            break;
                    }
                    
                    if (selector && childId) {
                        selector.value = childId;
                        selector.dispatchEvent(new Event('change'));
                    }
                }, 500);
            }
        }
    };

    // Fonction pour charger le tableau de bord enfant
    window.loadChildDashboard = async function(studentId) {
        const child = childrenList.find(c => c.matricule === studentId);
        if (!child) return;
        
        const dashboardContent = document.getElementById('child-dashboard-content');
        if (!dashboardContent) return;
        
        dashboardContent.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i><p>Chargement du tableau de bord...</p></div>';
        
        try {
            // Charger les notes selon le type d'enfant
            if (child.type === 'secondary') {
                await loadSecondaryGradesForDashboard(studentId);
            } else if (child.type === 'primary') {
                await loadPrimaryGradesForDashboard(studentId, '1ère période');
            } else {
                await loadKindergartenGradesForDashboard(studentId);
            }
            
            // Charger les présences
            const attendanceContainer = document.getElementById('attendance-container');
            if (attendanceContainer) {
                attendanceContainer.innerHTML = "Chargement...";
                
                const attQuery = query(collection(db, 'student_attendance'), where('studentId', '==', studentId));
                const attSnap = await getDocs(attQuery);
                
                let presentCount = 0;
                let totalCount = 0;
                
                attSnap.forEach(doc => {
                    const attendanceData = doc.data();
                    if (attendanceData.published === true) {
                        totalCount++;
                        if (attendanceData.status === 'present') {
                            presentCount++;
                        }
                    }
                });
                
                const attendanceRate = totalCount > 0 ? (presentCount / totalCount * 100).toFixed(0) : 0;
                attendanceContainer.innerHTML = `
                    <p>Taux de présence: <strong>${attendanceRate}%</strong></p>
                    <p>Présences: ${presentCount} / ${totalCount}</p>
                `;
            }
            
            // Charger les devoirs
            const homeworkContainer = document.getElementById('homework-container');
            if (homeworkContainer) {
                homeworkContainer.innerHTML = "Chargement...";
                
                if (child.type === 'secondary') {
                    const hwQuery = query(collection(db, 'homework'), where('className', '==', child.class), orderBy('dueDate', 'desc'), limit(5));
                    const hwSnap = await getDocs(hwQuery);
                    
                    if (hwSnap.empty) {
                        homeworkContainer.innerHTML = "<p>Aucun devoir récent.</p>";
                    } else {
                        let html = '<ul>';
                        hwSnap.forEach(doc => {
                            const hw = doc.data();
                            const dueDate = hw.dueDate ? new Date(hw.dueDate.toDate()).toLocaleDateString('fr-FR') : 'Non spécifiée';
                            html += `<li><strong>${hw.subject}:</strong> ${hw.title} (à rendre le ${dueDate})</li>`;
                        });
                        html += '</ul>';
                        homeworkContainer.innerHTML = html;
                    }
                } else if (child.type === 'primary') {
                    const hwQuery = query(collection(db, 'homework'), where('className', '==', child.class), orderBy('createdAt', 'desc'), limit(5));
                    const hwSnap = await getDocs(hwQuery);
                    
                    if (hwSnap.empty) {
                        homeworkContainer.innerHTML = "<p>Aucun devoir récent.</p>";
                    } else {
                        let html = '<ul>';
                        hwSnap.forEach(doc => {
                            const hw = doc.data();
                            const dueDate = hw.dueDate ? new Date(hw.dueDate.toDate()).toLocaleDateString('fr-FR') : 'Non spécifiée';
                            html += `<li><strong>${hw.subject}:</strong> ${hw.title} (pour le ${dueDate})</li>`;
                        });
                        html += '</ul>';
                        homeworkContainer.innerHTML = html;
                    }
                } else {
                    homeworkContainer.innerHTML = "<p>Les devoirs de la maternelle ne sont pas encore disponibles.</p>";
                }
            }
            
        } catch (error) {
            console.error('Erreur chargement tableau de bord:', error);
            dashboardContent.innerHTML = '<div class="alert alert-error">Erreur de chargement du tableau de bord</div>';
        }
    };

    // Fonctions auxiliaires pour le tableau de bord
    async function loadSecondaryGradesForDashboard(studentId) {
        const tableBody = document.getElementById('child-grades-table-body');
        if (!tableBody) return;
        
        try {
            const gradesQuery = query(collection(db, 'published_grades'), orderBy('publishedAt', 'desc'));
            const gradesSnap = await getDocs(gradesQuery);
            
            if (gradesSnap.empty) {
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Aucune note disponible.</td></tr>';
                return;
            }
            
            let allGrades = [];
            
            gradesSnap.forEach(doc => {
                const gradeData = doc.data();
                const studentGrade = gradeData.grades?.find(g => g.studentMatricule === studentId);
                
                if (studentGrade) {
                    allGrades.push({
                        subject: gradeData.subject,
                        maxPoints: gradeData.maxPoints,
                        grade: studentGrade.grade,
                        teacherName: gradeData.teacherName,
                        gradeType: gradeData.gradeType,
                        evaluationDate: gradeData.evaluationDate
                    });
                }
            });
            
            if (allGrades.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Aucune note trouvée.</td></tr>';
                return;
            }
            
            allGrades.sort((a, b) => {
                const dateA = a.evaluationDate ? a.evaluationDate.toDate() : new Date(0);
                const dateB = b.evaluationDate ? b.evaluationDate.toDate() : new Date(0);
                return dateB - dateA;
            });
            
            allGrades = allGrades.slice(0, 10);
            
            let html = '';
            allGrades.forEach((grade, index) => {
                const isGoodGrade = grade.grade >= (grade.maxPoints / 2);
                const gradeClass = isGoodGrade ? 'grade-green' : 'grade-red';
                const evaluationDate = grade.evaluationDate ? 
                    grade.evaluationDate.toDate().toLocaleDateString('fr-FR') : 'Non spécifiée';
                
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${grade.subject} (${grade.gradeType})</td>
                        <td>${grade.maxPoints}</td>
                        <td class="${gradeClass}">${grade.grade}</td>
                        <td>${grade.teacherName}</td>
                        <td>${evaluationDate}</td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
            
        } catch (error) {
            console.error('Erreur chargement notes tableau de bord:', error);
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Erreur de chargement.</td></tr>';
        }
    }

    async function loadPrimaryGradesForDashboard(studentId, period) {
        const tableBody = document.getElementById('child-grades-table-body');
        if (!tableBody) return;
        
        try {
            const child = childrenList.find(c => c.matricule === studentId);
            if (!child || child.type !== 'primary') {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Enfant non du primaire</td></tr>';
                return;
            }
            
            const gradesQuery = query(
                collection(db, 'primary_published_grades'),
                where('studentId', '==', studentId),
                where('period', '==', period)
            );
            
            const gradesSnap = await getDocs(gradesQuery);
            
            if (gradesSnap.empty) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Aucune cote disponible.</td></tr>';
                return;
            }
            
            let allGrades = [];
            
            gradesSnap.forEach(doc => {
                const gradeData = doc.data();
                gradeData.grades.forEach(courseGrade => {
                    allGrades.push({
                        courseName: courseGrade.courseName,
                        maxGrade: courseGrade.maxGrade,
                        obtainedGrade: courseGrade.obtainedGrade,
                        teacherName: courseGrade.teacherName
                    });
                });
            });
            
            if (allGrades.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Aucune cote trouvée.</td></tr>';
                return;
            }
            
            allGrades = allGrades.slice(0, 10);
            
            let html = '';
            allGrades.forEach((grade, index) => {
                const percentage = (grade.obtainedGrade / grade.maxGrade) * 100;
                const gradeClass = percentage >= 50 ? 'grade-green' : 'grade-red';
                
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${grade.courseName}</td>
                        <td>${grade.maxGrade}</td>
                        <td class="${gradeClass}">${grade.obtainedGrade}</td>
                        <td>${grade.teacherName}</td>
                        <td>Primaire</td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
            
        } catch (error) {
            console.error('Erreur chargement cotes tableau de bord:', error);
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Erreur de chargement.</td></tr>';
        }
    }

    // Fonction pour envoyer une notification de test
    window.sendTestNotification = async function() {
        if (!currentParent) {
            showToast('Veuillez vous connecter d\'abord', 'error');
            return;
        }
        
        try {
            await sendNotification(
                '🔔 Test de notification',
                'Ceci est un test pour vérifier que les notifications fonctionnent correctement.',
                {
                    type: 'test',
                    page: 'dashboard',
                    childId: childrenList.length > 0 ? childrenList[0].matricule : '',
                    childName: childrenList.length > 0 ? childrenList[0].fullName : ''
                }
            );
            showToast('Notification de test envoyée avec succès', 'success');
        } catch (error) {
            console.error('❌ Erreur envoi notification test:', error);
            showToast('Erreur lors de l\'envoi de la notification de test', 'error');
        }
    };

    // Initialiser les gestionnaires d'événements pour les notifications
    const enableNotificationsBtn = document.getElementById('enable-notifications-btn');
    if (enableNotificationsBtn) {
        enableNotificationsBtn.addEventListener('click', async () => {
            await requestNotificationsPermission();
        });
    }

    const testNotificationBtn = document.getElementById('test-notification-btn');
    if (testNotificationBtn) {
        testNotificationBtn.addEventListener('click', () => {
            window.sendTestNotification();
        });
    }

    // Log de démarrage
    console.log('%c✅ Application initialisée avec succès', 'color: #2ecc71; font-weight: bold;');
    console.log('%c📱 Version: 2.1.0', 'color: #3498db;');
    console.log('%c🔔 Notifications Firebase activées', 'color: #e74c3c;');
});

// Fonction pour gérer la visibilité de la page
document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'visible' && currentParent) {
        console.log('📱 Application au premier plan');
        // Recharger les données si nécessaire
    }
});

// Gestionnaire d'erreurs global
window.addEventListener('error', function(event) {
    console.error('❌ Erreur globale:', event.error);
});

// Gestionnaire pour les promesses non capturées
window.addEventListener('unhandledrejection', function(event) {
    console.error('❌ Promesse non capturée:', event.reason);
});

</script>

</body>

</html>
