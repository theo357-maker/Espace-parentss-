<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secrétariat - CS la Colombe</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!-- PWA Meta Tags -->
  <meta name="application-name" content="TheoVêt">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="TheoVêt">
  <meta name="description" content="Solution complète de gestion de commerce de vêtements">
  <meta name="format-detection" content="telephone=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="msapplication-TileColor" content="#3498db">
  <meta name="msapplication-tap-highlight" content="no">
  <meta name="theme-color" content="#3498db">

  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="icon-192x192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icon-192x192.png">
  <link rel="apple-touch-icon" sizes="72x72" href="icon-72x72.png">
  <link rel="apple-touch-icon" sizes="167x167" href="icons/icon-167x167.png">

  <!-- Manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- Styles et Bibliothèques -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <style>
        :root {
            --primary: #3498db; --secondary: #2c3e50; --success: #27ae60;
            --danger: #e74c3c; --warning: #f39c12; --info: #1abc9c;
            --light: #ecf0f1; --dark: #34495e;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f5f6fa; }
        .hidden { display: none !important; }

        /* --- Écran de démarrage --- */
        .splash-screen { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            z-index: 3000;
            color: white;
        }
        .splash-logo { 
            width: 150px; 
            height: 150px; 
            margin-bottom: 2rem;
            background: white;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .splash-logo i { 
            font-size: 4rem; 
            color: var(--primary);
        }
        .splash-text { 
            text-align: center; 
            margin-bottom: 2rem;
        }
        .splash-text h1 { 
            font-size: 2.5rem; 
            margin-bottom: 0.5rem;
            font-weight: 700;
        }
        .splash-text p { 
            font-size: 1.2rem; 
            opacity: 0.9;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top: 5px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Styles Communs --- */
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .login-card { background: white; padding: 3rem; border-radius: 10px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: 250px; background: white; box-shadow: 2px 0 10px rgba(0,0,0,0.08); flex-shrink: 0; transition: transform 0.3s ease; }
        .sidebar.collapsed { transform: translateX(-100%); }
        .nav-menu { list-style: none; padding: 1rem 0; margin: 0; }
        .nav-menu li a { display: flex; align-items: center; gap: 12px; padding: 14px 20px; color: var(--dark); text-decoration: none; font-weight: 500; }
        .nav-menu li a.active, .nav-menu li a:hover { background: #eaf5fc; color: var(--primary); }
        .nav-submenu { list-style: none; padding-left: 2rem; }
        .nav-submenu li a { padding: 10px 20px; font-size: 0.9rem; }
        .nav-menu .has-submenu > a::after { content: '\f078'; font-family: 'Font Awesome 5 Free'; font-weight: 900; margin-left: auto; transition: transform 0.3s; }
        .nav-menu .has-submenu.active > a::after { transform: rotate(180deg); }
        .nav-submenu { display: none; }
        .nav-menu .has-submenu.active .nav-submenu { display: block; }
        .main-content { flex: 1; display: flex; flex-direction: column; }
        .app-header { background: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        .content-area { padding: 2rem; }
        .page { display: none; }
        .page.active { display: block; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 500; color: white; }
        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        .btn-warning { background: var(--warning); }
        .btn-info { background: var(--info); }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 1.5rem; }
        .form-row { display: flex; gap: 1rem; }
        .alert { padding: 1rem; border-radius: 5px; margin-bottom: 1rem; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-error { background: #f8d7da; color: #721c24; }
        .alert-info { background: #d1ecf1; color: #0c5460; }
        
        /* --- Styles améliorés --- */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; font-weight: 600; }
        tr:hover { background-color: #f8f9fa; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 500; }
        .badge-success { background-color: var(--success); color: white; }
        .badge-warning { background-color: var(--warning); color: white; }
        .badge-danger { background-color: var(--danger); color: white; }
        .badge-info { background-color: var(--info); color: white; }
        .badge-secondary { background-color: var(--secondary); color: white; }
        .search-box { margin-bottom: 1.5rem; }
        .search-box input { width: 100%; max-width: 400px; }
        .action-buttons { display: flex; gap: 0.5rem; }
        .action-buttons button { padding: 6px 12px; font-size: 0.85rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; cursor: pointer; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card i { font-size: 2rem; margin-bottom: 0.5rem; color: var(--primary); }
        .stat-card h3 { font-size: 1.8rem; margin: 0.5rem 0; }
        .stat-card p { color: #666; font-size: 0.9rem; }
        .filter-options { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .filter-options select { min-width: 150px; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 2rem; border-radius: 10px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .close-modal { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }
        .tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 1.5rem; }
        .tab { padding: 10px 20px; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab.active { border-bottom: 2px solid var(--primary); color: var(--primary); font-weight: 500; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .student-details { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; }
        .detail-item { margin-bottom: 1rem; }
        .detail-item label { font-weight: 600; color: #666; }
        .detail-item p { margin-top: 0.25rem; }
        .photo-upload { text-align: center; margin: 1rem 0; }
        .photo-preview { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); margin: 0 auto 1rem; display: block; }
        .photo-placeholder { width: 120px; height: 120px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; color: #999; }
        .file-input { display: none; }
        .upload-btn { background: var(--info); color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; }
        .loading { opacity: 0.6; pointer-events: none; }
        .multi-select { height: 120px; }
        .teacher-classes { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem; }
        .class-checkbox { display: flex; align-items: center; gap: 0.5rem; }
        
        /* --- Styles pour la photo de profil du secrétaire --- */
        .secretary-profile { display: flex; align-items: center; gap: 1rem; }
        .secretary-photo { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }
        .secretary-photo-placeholder { width: 40px; height: 40px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; color: #999; }
        
        /* --- Styles pour le reçu --- */
        .receipt { max-width: 600px; margin: 0 auto; background: white; padding: 2rem; border: 1px solid #ddd; font-family: Arial, sans-serif; }
        .receipt-header { text-align: center; margin-bottom: 2rem; border-bottom: 2px solid var(--primary); padding-bottom: 1rem; }
        .receipt-logo { max-width: 150px; margin-bottom: 1rem; }
        .receipt-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem; color: var(--primary); }
        .receipt-details { margin-bottom: 2rem; }
        .receipt-row { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        .receipt-divider { border-top: 1px solid #ddd; margin: 1rem 0; }
        .receipt-footer { text-align: center; margin-top: 2rem; font-size: 0.9rem; color: #666; border-top: 1px solid #eee; padding-top: 1rem; }
        .code-validation { background: #f8f9fa; padding: 1rem; border-radius: 5px; margin: 1rem 0; text-align: center; border: 1px dashed #ddd; }
        .code-validation h3 { color: var(--primary); margin-bottom: 0.5rem; }
        .code-value { font-size: 1.5rem; font-weight: bold; letter-spacing: 2px; color: var(--success); background: white; padding: 0.5rem; border-radius: 4px; border: 1px solid #ddd; }
        
        /* --- Styles pour la gestion des frais --- */
        .fees-controls { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .fees-controls select, .fees-controls input { min-width: 150px; }
        .fees-summary { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .fees-summary-card { background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center; }
        .fees-summary-card h4 { margin-bottom: 0.5rem; color: var(--dark); }
        .fees-summary-card p { font-size: 1.5rem; font-weight: bold; color: var(--primary); }
        
        /* --- Styles pour l'espace administratif --- */
        .admin-controls { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .report-card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 1.5rem; }
        .report-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .report-summary { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .signature-area { margin-top: 3rem; display: flex; justify-content: space-between; }
        .signature-box { text-align: center; width: 45%; }
        .signature-line { border-top: 1px solid #000; margin-top: 3rem; }

        /* --- Styles pour les montants en dollars --- */
        .currency-display { font-weight: bold; color: var(--success); }
        .currency-input-group { position: relative; }
        .currency-symbol { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #666; font-weight: bold; }
        .currency-input { padding-left: 25px; }

        /* --- Styles pour les mois multiples --- */
        .months-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.5rem; margin: 1rem 0; }
        .month-checkbox { display: flex; align-items: center; gap: 0.5rem; }
        
        /* --- Styles pour le bouton menu --- */
        .menu-toggle { display: none; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--dark); }
        
        /* --- Styles pour le statut de connexion --- */
        .connection-status { 
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
            padding: 0.5rem 1rem; 
            border-radius: 20px; 
            font-size: 0.8rem; 
            margin-right: 1rem;
        }
        .connection-status.online { background: #d4edda; color: #155724; }
        .connection-status.offline { background: #f8d7da; color: #721c24; }
        .status-indicator { 
            width: 10px; 
            height: 10px; 
            border-radius: 50%; 
            display: inline-block;
        }
        .status-online { background: var(--success); }
        .status-offline { background: var(--danger); }
        
        /* --- Styles pour le bouton d'installation PWA --- */
        .install-btn { 
            background: var(--info); 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin-right: 1rem;
            display: none;
        }
        
        @media (max-width: 768px) {
            .menu-toggle { display: block; }
            .sidebar { position: fixed; z-index: 1000; height: 100%; }
            .main-content { margin-left: 0; }
            .connection-status, .install-btn { display: none; }
        }
    </style>
</head>
<body>
    <!-- Écran de démarrage -->
    <div id="splash-screen" class="splash-screen">
        <div class="splash-logo">
            <i > <img src="hi.png" width="50px"></i>
        </div>
        <div class="splash-text">
            <h1>CS la Colombe</h1>
            <p>Portail Secrétariat</p>
        </div>
        <div class="loading-spinner"></div>
    </div>

    <!-- Écran de connexion sécurisé -->
    <div id="login-overlay" class="login-overlay hidden">
        <div class="login-card">
            <h3>Portail Secrétariat</h3>
            <p>Veuillez vous connecter pour continuer.</p>
            <form id="login-form" style="margin-top: 2rem;">
                <div class="form-group">
                    <input type="email" id="login-email" class="form-control" placeholder="Email" required>
                </div>
                <div class="form-group">
                    <input type="password" id="login-password" class="form-control" placeholder="Mot de passe" required>
                </div>
                <div id="login-alert" class="alert hidden" style="margin-top: 1rem;"></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Connexion</button>
            </form>
        </div>
    </div>

    <!-- Contenu de l'application (caché par défaut) -->
    <div id="app-root" class="app-container hidden">
        <nav class="sidebar">
            <div style="padding: 1.5rem; text-align: center; border-bottom: 1px solid #eee;">
                <i class="fas fa-edit" style="font-size: 2rem; color: var(--primary);"></i>
                <h3 style="margin-top: 0.5rem;">Secrétariat</h3>
            </div>
            <ul class="nav-menu">
   <li><a href="#" data-page="other-management"><i class="fas fa-cogs fa-fw"></i> Gestion Autres</a></li>
                <li><a href="#" class="active" data-page="dashboard"><i class="fas fa-tachometer-alt fa-fw"></i> Tableau de Bord</a></li>
                
                <!-- Menu déroulant Élèves -->
                <li class="has-submenu">
                    <a href="#"><i class="fas fa-user-graduate fa-fw"></i> Élèves</a>
                    <ul class="nav-submenu">
                        <li><a href="#" data-page="enroll-student">Inscrire Élève Secondaire</a></li>
                        <li><a href="#" data-page="enroll-primary-student">Inscrire Élève Primaire</a></li>
                        <li><a href="#" data-page="enroll-kindergarten-student">Inscrire Élève Maternelle</a></li>
                    </ul>
                </li>
                
                <!-- Menu déroulant Enseignants -->
                <li class="has-submenu">
                    <a href="#"><i class="fas fa-chalkboard-teacher fa-fw"></i> Enseignants</a>
                    <ul class="nav-submenu">
                        <li><a href="#" data-page="enroll-teacher">Inscrire Enseignant Secondaire</a></li>
                        <li><a href="#" data-page="enroll-primary-teacher">Inscrire Enseignant Primaire</a></li>
                        <li><a href="#" data-page="enroll-kindergarten-teacher">Inscrire Enseignant Maternelle</a></li>
                    </ul>
                </li>
                
                <!-- Menu déroulant Classes -->
                <li class="has-submenu">
                    <a href="#"><i class="fas fa-door-open fa-fw"></i> Classes</a>
                    <ul class="nav-submenu">
                        <li><a href="#" data-page="manage-classes">Gérer Classes Secondaires</a></li>
                        <li><a href="#" data-page="manage-primary-classes">Gérer Classes Primaires</a></li>
                        <li><a href="#" data-page="manage-kindergarten-classes">Gérer Classes Maternelles</a></li>
                    </ul>
                </li>
                
                <li><a href="#" data-page="validate-payment"><i class="fas fa-check-circle fa-fw"></i> Valider Paiement</a></li>
                <li><a href="#" data-page="manage-fees"><i class="fas fa-money-bill-wave fa-fw"></i> Gestion des Frais</a></li>
                <li><a href="#" data-page="students-list"><i class="fas fa-users fa-fw"></i> Liste des Élèves</a></li>
                <li><a href="#" data-page="teachers-list"><i class="fas fa-user-tie fa-fw"></i> Liste des Enseignants</a></li>
                <li><a href="#" data-page="validate-enrollment"><i class="fas fa-user-check fa-fw"></i> Valider Inscription</a></li>
                <li><a href="#" data-page="admin-reports"><i class="fas fa-chart-bar fa-fw"></i> Rapports Admin</a></li>
                <li><a href="#" data-page="profile"><i class="fas fa-user fa-fw"></i> Profil</a></li>
            </ul>
        </nav>
        <div class="main-content">
            <header class="app-header">
                <button class="menu-toggle" id="menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h2 id="page-title">Tableau de Bord</h2>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div id="connection-status" class="connection-status online">
                        <span class="status-indicator status-online"></span>
                        <span>En ligne</span>
                    </div>
                    <button id="install-btn" class="install-btn">
                        <i class="fas fa-download"></i> Installer
                    </button>
                    <div class="secretary-profile">
                        <div id="secretary-photo-container">
                            <!-- La photo sera insérée ici dynamiquement -->
                        </div>
                        <span id="secretary-name"></span>
                    </div>
                    <button id="logout-btn" class="btn btn-danger">Déconnexion</button>
                </div>
            </header>
            <main class="content-area">
                <div id="global-alert" class="alert hidden"></div>

                <!-- Page: Tableau de Bord -->
                <div id="dashboard-page" class="page active">
                    <div class="stats-grid">
                        <div class="stat-card" data-target="students-list">
                            <i class="fas fa-users"></i>
                            <h3 id="total-students">0</h3>
                            <p>Élèves inscrits</p>
                        </div>
                        <div class="stat-card" data-target="teachers-list">
                            <i class="fas fa-user-tie"></i>
                            <h3 id="total-teachers">0</h3>
                            <p>Enseignants</p>
                        </div>
                        <div class="stat-card" data-target="manage-classes">
                            <i class="fas fa-door-open"></i>
                            <h3 id="total-classes">0</h3>
                            <p>Classes</p>
                        </div>
                        <div class="stat-card" data-target="validate-payment">
                            <i class="fas fa-money-bill-wave"></i>
                            <h3 id="pending-payments">0</h3>
                            <p>Paiements en attente</p>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h4>Activités récentes</h4>
                        <div id="recent-activities">
                            <p>Aucune activité récente</p>
                        </div>
                    </div>
                </div>

<!-- Page: Gestion Autres -->
<div id="other-management-page" class="page">
    <div class="card">
        <h4>Gestion des Personnels, Salaires et Communications</h4>
        <p>Cette section permet de gérer les personnels ouvriers, les paiements de salaires et les communications aux parents.</p>
        <div style="text-align: center; margin-top: 2rem;">
            <a href="autre.html" class="btn btn-primary" style="padding: 12px 24px; font-size: 1.1rem;">
                <i class="fas fa-external-link-alt"></i> Ouvrir la Gestion Complète
            </a>
        </div>
    </div>
</div>

                <!-- Page: Inscrire Élève Secondaire -->
                <div id="enroll-student-page" class="page">
                    <div class="card">
                        <form id="student-form">
                            <h4>Informations de l'élève (Secondaire)</h4>
                            
                            <!-- Photo de profil -->
                            <div class="photo-upload">
                                <div class="photo-placeholder" id="student-photo-preview">
                                    <i class="fas fa-camera"></i>
                                </div>
                                <input type="file" id="student-photo" class="file-input" accept="image/*">
                                <button type="button" class="upload-btn" onclick="document.getElementById('student-photo').click()">
                                    <i class="fas fa-upload"></i> Choisir une photo
                                </button>
                            </div>

                            <div class="form-row">
                                <div class="form-group" style="flex: 2;">
                                    <label>Nom Complet</label>
                                    <input type="text" id="student-name" class="form-control" required>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Date de Naissance</label>
                                    <input type="date" id="student-birthdate" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Lieu de Naissance</label>
                                    <input type="text" id="student-birthplace" class="form-control" required>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Sexe</label>
                                    <select id="student-gender" class="form-control" required>
                                        <option value="">Sélectionner</option>
                                        <option value="M">Masculin</option>
                                        <option value="F">Féminin</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Adresse de Résidence</label>
                                <input type="text" id="student-address" class="form-control" required>
                            </div>
                            
                            <div class="form-group">
                                <label>Numéro de Téléphone</label>
                                <input type="tel" id="student-phone" class="form-control" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Classe</label>
                                    <select id="student-class" class="form-control" required></select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Frais d'inscription ($)</label>
                                    <div class="currency-input-group">
                                        <span class="currency-symbol">$</span>
                                        <input type="number" id="student-fees" class="form-control currency-input" step="0.01" min="0" required value="0">
                                    </div>
                                </div>
                            </div>

                            <hr style="margin: 2rem 0;">
                            <h4>Informations du Parent</h4>
                            <div class="form-group">
                                <label>Nom du Parent</label>
                                <input type="text" id="parent-name" class="form-control" required>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Téléphone Parent</label>
                                    <input type="tel" id="parent-phone" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label>Adresse Parent</label>
                                    <input type="text" id="parent-address" class="form-control" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <button type="submit" class="btn btn-primary" style="margin-top: 1rem; margin-right: 1rem;" id="student-submit-btn">
                                    Inscrire l'Élève
                                </button>
                                <button type="button" class="btn btn-success" style="margin-top: 1rem;" id="print-student-btn" onclick="printEnrollmentForm('secondary')">
                                    <i class="fas fa-print"></i> Imprimer Bordereau
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Page: Inscrire Élève Primaire -->
                <div id="enroll-primary-student-page" class="page">
                    <div class="card">
                        <form id="primary-student-form">
                            <h4>Informations de l'élève (Primaire)</h4>
                            
                            <!-- Photo de profil -->
                            <div class="photo-upload">
                                <div class="photo-placeholder" id="primary-student-photo-preview">
                                    <i class="fas fa-camera"></i>
                                </div>
                                <input type="file" id="primary-student-photo" class="file-input" accept="image/*">
                                <button type="button" class="upload-btn" onclick="document.getElementById('primary-student-photo').click()">
                                    <i class="fas fa-upload"></i> Choisir une photo
                                </button>
                            </div>

                            <div class="form-row">
                                <div class="form-group" style="flex: 2;">
                                    <label>Nom Complet</label>
                                    <input type="text" id="primary-student-name" class="form-control" required>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Date de Naissance</label>
                                    <input type="date" id="primary-student-birthdate" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Lieu de Naissance</label>
                                    <input type="text" id="primary-student-birthplace" class="form-control" required>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Sexe</label>
                                    <select id="primary-student-gender" class="form-control" required>
                                        <option value="">Sélectionner</option>
                                        <option value="M">Masculin</option>
                                        <option value="F">Féminin</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Adresse de Résidence</label>
                                <input type="text" id="primary-student-address" class="form-control" required>
                            </div>
                            
                            <!-- Pas de numéro de téléphone pour les élèves primaires -->
                            
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Classe</label>
                                    <select id="primary-student-class" class="form-control" required></select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Frais d'inscription ($)</label>
                                    <div class="currency-input-group">
                                        <span class="currency-symbol">$</span>
                                        <input type="number" id="primary-student-fees" class="form-control currency-input" step="0.01" min="0" required value="0">
                                    </div>
                                </div>
                            </div>

                            <hr style="margin: 2rem 0;">
                            <h4>Informations du Parent</h4>
                            <div class="form-group">
                                <label>Nom du Parent</label>
                                    <input type="text" id="primary-parent-name" class="form-control" required>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Téléphone Parent</label>
                                    <input type="tel" id="primary-parent-phone" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label>Adresse Parent</label>
                                    <input type="text" id="primary-parent-address" class="form-control" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <button type="submit" class="btn btn-primary" style="margin-top: 1rem; margin-right: 1rem;" id="primary-student-submit-btn">
                                    Inscrire l'Élève Primaire
                                </button>
                                <button type="button" class="btn btn-success" style="margin-top: 1rem;" id="print-primary-student-btn" onclick="printEnrollmentForm('primary')">
                                    <i class="fas fa-print"></i> Imprimer Bordereau
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Page: Inscrire Élève Maternelle -->
                <div id="enroll-kindergarten-student-page" class="page">
                    <div class="card">
                        <form id="kindergarten-student-form">
                            <h4>Informations de l'élève (Maternelle)</h4>
                            
                            <!-- Photo de profil -->
                            <div class="photo-upload">
                                <div class="photo-placeholder" id="kindergarten-student-photo-preview">
                                    <i class="fas fa-camera"></i>
                                </div>
                                <input type="file" id="kindergarten-student-photo" class="file-input" accept="image/*">
                                <button type="button" class="upload-btn" onclick="document.getElementById('kindergarten-student-photo').click()">
                                    <i class="fas fa-upload"></i> Choisir une photo
                                </button>
                            </div>

                            <div class="form-row">
                                <div class="form-group" style="flex: 2;">
                                    <label>Nom Complet</label>
                                    <input type="text" id="kindergarten-student-name" class="form-control" required>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Date de Naissance</label>
                                    <input type="date" id="kindergarten-student-birthdate" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Lieu de Naissance</label>
                                    <input type="text" id="kindergarten-student-birthplace" class="form-control" required>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Sexe</label>
                                    <select id="kindergarten-student-gender" class="form-control" required>
                                        <option value="">Sélectionner</option>
                                        <option value="M">Masculin</option>
                                        <option value="F">Féminin</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Adresse de Résidence</label>
                                <input type="text" id="kindergarten-student-address" class="form-control" required>
                            </div>
                            
                            <!-- Pas de numéro de téléphone pour les élèves maternelles -->
                            
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Classe</label>
                                    <select id="kindergarten-student-class" class="form-control" required></select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Frais d'inscription ($)</label>
                                    <div class="currency-input-group">
                                        <span class="currency-symbol">$</span>
                                        <input type="number" id="kindergarten-student-fees" class="form-control currency-input" step="0.01" min="0" required value="0">
                                    </div>
                                </div>
                            </div>

                            <hr style="margin: 2rem 0;">
                            <h4>Informations du Parent</h4>
                            <div class="form-group">
                                <label>Nom du Parent</label>
                                <input type="text" id="kindergarten-parent-name" class="form-control" required>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Téléphone Parent</label>
                                    <input type="tel" id="kindergarten-parent-phone" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label>Adresse Parent</label>
                                    <input type="text" id="kindergarten-parent-address" class="form-control" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <button type="submit" class="btn btn-primary" style="margin-top: 1rem; margin-right: 1rem;" id="kindergarten-student-submit-btn">
                                    Inscrire l'Élève Maternelle
                                </button>
                                <button type="button" class="btn btn-success" style="margin-top: 1rem;" id="print-kindergarten-student-btn" onclick="printEnrollmentForm('kindergarten')">
                                    <i class="fas fa-print"></i> Imprimer Bordereau
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Page: Inscrire Enseignant Secondaire -->
                <div id="enroll-teacher-page" class="page">
                    <div class="card">
                        <form id="teacher-form">
                            <h4>Informations de l'enseignant (Secondaire)</h4>
                            
                            <!-- Photo de profil -->
                            <div class="photo-upload">
                                <div class="photo-placeholder" id="teacher-photo-preview">
                                    <i class="fas fa-camera"></i>
                                </div>
                                <input type="file" id="teacher-photo" class="file-input" accept="image/*">
                                <button type="button" class="upload-btn" onclick="document.getElementById('teacher-photo').click()">
                                    <i class="fas fa-upload"></i> Choisir une photo
                                </button>
                            </div>

                            <div class="form-group">
                                <label>Nom Complet</label>
                                <input type="text" id="teacher-name" class="form-control" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Date de Naissance</label>
                                    <input type="date" id="teacher-birthdate" class="form-control" required>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Lieu de Naissance</label>
                                    <input type="text" id="teacher-birthplace" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Sexe</label>
                                    <select id="teacher-gender" class="form-control" required>
                                        <option value="">Sélectionner</option>
                                        <option value="M">Masculin</option>
                                        <option value="F">Féminin</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Numéro de Téléphone</label>
                                    <input type="tel" id="teacher-phone" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Adresse de Résidence</label>
                                <input type="text" id="teacher-address" class="form-control" required>
                            </div>
                            
                            <div class="form-group">
                                <label>Matières (séparées par une virgule)</label>
                                <input type="text" id="teacher-subjects" class="form-control" placeholder="Ex: Mathématiques, Physique" required>
                            </div>
                            
                            <div class="form-group">
                                <label>Classes à gérer</label>
                                <div id="teacher-classes-container" class="teacher-classes">
                                    <!-- Les classes seront chargées dynamiquement -->
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary" style="margin-top: 1rem;" id="teacher-submit-btn">
                                Inscrire l'Enseignant
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Page: Inscrire Enseignant Primaire -->
                <div id="enroll-primary-teacher-page" class="page">
                    <div class="card">
                        <form id="primary-teacher-form">
                            <h4>Informations de l'enseignant (Primaire)</h4>
                            
                            <!-- Photo de profil -->
                            <div class="photo-upload">
                                <div class="photo-placeholder" id="primary-teacher-photo-preview">
                                    <i class="fas fa-camera"></i>
                                </div>
                                <input type="file" id="primary-teacher-photo" class="file-input" accept="image/*">
                                <button type="button" class="upload-btn" onclick="document.getElementById('primary-teacher-photo').click()">
                                    <i class="fas fa-upload"></i> Choisir une photo
                                </button>
                            </div>

                            <div class="form-group">
                                <label>Nom Complet</label>
                                <input type="text" id="primary-teacher-name" class="form-control" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Date de Naissance</label>
                                    <input type="date" id="primary-teacher-birthdate" class="form-control" required>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Lieu de Naissance</label>
                                    <input type="text" id="primary-teacher-birthplace" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Sexe</label>
                                    <select id="primary-teacher-gender" class="form-control" required>
                                        <option value="">Sélectionner</option>
                                        <option value="M">Masculin</option>
                                        <option value="F">Féminin</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Numéro de Téléphone</label>
                                    <input type="tel" id="primary-teacher-phone" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Adresse de Résidence</label>
                                <input type="text" id="primary-teacher-address" class="form-control" required>
                            </div>
                            
                            <!-- Pas de champ matières pour les enseignants primaires -->
                            
                            <div class="form-group">
                                <label>Classes à gérer</label>
                                <div id="primary-teacher-classes-container" class="teacher-classes">
                                    <!-- Les classes primaires seront chargées dynamiquement -->
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary" style="margin-top: 1rem;" id="primary-teacher-submit-btn">
                                Inscrire l'Enseignant Primaire
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Page: Inscrire Enseignant Maternelle -->
                <div id="enroll-kindergarten-teacher-page" class="page">
                    <div class="card">
                        <form id="kindergarten-teacher-form">
                            <h4>Informations de l'enseignant (Maternelle)</h4>
                            
                            <!-- Photo de profil -->
                            <div class="photo-upload">
                                <div class="photo-placeholder" id="kindergarten-teacher-photo-preview">
                                    <i class="fas fa-camera"></i>
                                </div>
                                <input type="file" id="kindergarten-teacher-photo" class="file-input" accept="image/*">
                                <button type="button" class="upload-btn" onclick="document.getElementById('kindergarten-teacher-photo').click()">
                                    <i class="fas fa-upload"></i> Choisir une photo
                                </button>
                            </div>

                            <div class="form-group">
                                <label>Nom Complet</label>
                                <input type="text" id="kindergarten-teacher-name" class="form-control" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Date de Naissance</label>
                                    <input type="date" id="kindergarten-teacher-birthdate" class="form-control" required>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Lieu de Naissance</label>
                                    <input type="text" id="kindergarten-teacher-birthplace" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Sexe</label>
                                    <select id="kindergarten-teacher-gender" class="form-control" required>
                                        <option value="">Sélectionner</option>
                                        <option value="M">Masculin</option>
                                        <option value="F">Féminin</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Numéro de Téléphone</label>
                                    <input type="tel" id="kindergarten-teacher-phone" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Adresse de Résidence</label>
                                <input type="text" id="kindergarten-teacher-address" class="form-control" required>
                            </div>
                            
                            <!-- Pas de champ matières pour les enseignants maternelles -->
                            
                            <div class="form-group">
                                <label>Classes à gérer</label>
                                <div id="kindergarten-teacher-classes-container" class="teacher-classes">
                                    <!-- Les classes maternelles seront chargées dynamiquement -->
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary" style="margin-top: 1rem;" id="kindergarten-teacher-submit-btn">
                                Inscrire l'Enseignant Maternelle
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Page: Gérer Classes Secondaires -->
                <div id="manage-classes-page" class="page">
                    <div class="card">
                        <h4>Ajouter une nouvelle classe (Secondaire)</h4>
                        <form id="class-form" class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label>Nom de la classe</label>
                                <input type="text" id="class-name" class="form-control" placeholder="Ex: 7ème A Scientifique" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>Niveau</label>
                                <input type="text" id="class-level" class="form-control" placeholder="Ex: 7ème" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>Capacité</label>
                                <input type="number" id="class-capacity" class="form-control" placeholder="30" required>
                            </div>
                            <button type="submit" class="btn btn-primary" style="align-self: flex-end;">Ajouter</button>
                        </form>
                    </div>
                    <div class="card">
                        <h4>Classes existantes (Secondaire)</h4>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nom</th>
                                        <th>Niveau</th>
                                        <th>Capacité</th>
                                        <th>Élèves inscrits</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="classes-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Page: Gérer Classes Primaires -->
                <div id="manage-primary-classes-page" class="page">
                    <div class="card">
                        <h4>Ajouter une nouvelle classe (Primaire)</h4>
                        <form id="primary-class-form" class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label>Nom de la classe</label>
                                <input type="text" id="primary-class-name" class="form-control" placeholder="Ex: CP1" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>Niveau</label>
                                <input type="text" id="primary-class-level" class="form-control" placeholder="Ex: CP" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>Capacité</label>
                                <input type="number" id="primary-class-capacity" class="form-control" placeholder="30" required>
                            </div>
                            <button type="submit" class="btn btn-primary" style="align-self: flex-end;">Ajouter</button>
                        </form>
                    </div>
                    <div class="card">
                        <h4>Classes existantes (Primaire)</h4>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nom</th>
                                        <th>Niveau</th>
                                        <th>Capacité</th>
                                        <th>Élèves inscrits</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="primary-classes-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Page: Gérer Classes Maternelles -->
                <div id="manage-kindergarten-classes-page" class="page">
                    <div class="card">
                        <h4>Ajouter une nouvelle classe (Maternelle)</h4>
                        <form id="kindergarten-class-form" class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label>Nom de la classe</label>
                                <input type="text" id="kindergarten-class-name" class="form-control" placeholder="Ex: Petite Section" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>Niveau</label>
                                <input type="text" id="kindergarten-class-level" class="form-control" placeholder="Ex: PS" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>Capacité</label>
                                <input type="number" id="kindergarten-class-capacity" class="form-control" placeholder="25" required>
                            </div>
                            <button type="submit" class="btn btn-primary" style="align-self: flex-end;">Ajouter</button>
                        </form>
                    </div>
                    <div class="card">
                        <h4>Classes existantes (Maternelle)</h4>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nom</th>
                                        <th>Niveau</th>
                                        <th>Capacité</th>
                                        <th>Élèves inscrits</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="kindergarten-classes-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Page: Valider Paiement -->
                <div id="validate-payment-page" class="page">
                    <div class="card">
                        <h4>Valider un paiement par code</h4>
                        <div class="form-group">
                            <label>Entrer le code de paiement</label>
                            <input type="text" id="payment-code-input" class="form-control" placeholder="PAY-XXXXXX">
                        </div>
                        <button id="find-payment-btn" class="btn btn-primary">Rechercher</button>
                    </div>
                    <div id="payment-details-card" class="card hidden">
                        <h4>Détails de la transaction</h4>
                        <p><strong>Élève:</strong> <span id="payment-student-name"></span></p>
                        <p><strong>Mois:</strong> <span id="payment-months"></span></p>
                        <p><strong>Type de frais:</strong> <span id="payment-type"></span></p>
                        <p><strong>Montant:</strong> <span id="payment-amount" class="currency-display"></span></p>
                        <button id="confirm-payment-btn" class="btn btn-success" style="margin-top: 1rem;">Confirmer le Paiement</button>
                    </div>
                    
                    <div class="card">
                        <h4>Paiements en attente</h4>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Code</th>
                                        <th>Élève</th>
                                        <th>Mois</th>
                                        <th>Type</th>
                                        <th>Montant</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="pending-payments-list"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h4>Paiements sur place</h4>
                        <form id="onsite-payment-form">
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Matricule de l'élève</label>
                                    <input type="text" id="onsite-student-id" class="form-control" placeholder="Ex: 2023SC001" required>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Type d'élève</label>
                                    <select id="onsite-student-type" class="form-control" required>
                                        <option value="secondary">Secondaire</option>
                                        <option value="primary">Primaire</option>
                                        <option value="kindergarten">Maternelle</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Classe</label>
                                    <input type="text" id="onsite-student-class" class="form-control" readonly>
                                </div>
                                <div class="form-group" style="flex: 2;">
                                    <label>Nom complet de l'élève</label>
                                    <input type="text" id="onsite-student-name" class="form-control" readonly>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Type de frais</label>
                                    <select id="onsite-payment-type" class="form-control" required>
                                        <option value="">Sélectionner</option>
                                        <option value="Frais scolaires">Frais scolaires</option>
                                        <option value="Frais de l'état">Frais de l'état</option>
                                        <option value="visite">visite</option>
                                        <option value="achat pull">achat pull</option>
                                        <option value="Autres">Autres (veuillez spécifier)</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Spécification (si autres)</label>
                                    <input type="text" id="onsite-payment-other" class="form-control" placeholder="Spécifiez le type de frais">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Mois de paiement</label>
                                    <div class="months-container" id="onsite-months-container">
                                        <!-- Les mois seront générés dynamiquement -->
                                    </div>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Montant Total ($)</label>
                                    <div class="currency-input-group">
                                        <span class="currency-symbol">$</span>
                                        <input type="number" id="onsite-amount" class="form-control currency-input" step="0.01" min="0" required>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Valider le paiement</button>
                        </form>
                    </div>
                </div>

                <!-- Page: Gestion des Frais -->
                <div id="manage-fees-page" class="page">
                    <div class="card">
                        <h4>Gestion des frais scolaires</h4>
                        <div class="fees-controls">
                            <select id="fees-student-type" class="form-control">
                                <option value="all">Tous les élèves</option>
                                <option value="secondary">Élèves Secondaires</option>
                                <option value="primary">Élèves Primaires</option>
                                <option value="kindergarten">Élèves Maternelles</option>
                            </select>
                            <select id="fees-class" class="form-control">
                                <option value="">Toutes les classes</option>
                            </select>
                            <select id="fees-month" class="form-control">
                                <option value="janvier">Janvier</option>
                                <option value="février">Février</option>
                                <option value="mars">Mars</option>
                                <option value="avril">Avril</option>
                                <option value="mai">Mai</option>
                                <option value="juin">Juin</option>
                                <option value="juillet">Juillet</option>
                                <option value="août">Août</option>
                                <option value="septembre">Septembre</option>
                                <option value="octobre">Octobre</option>
                                <option value="novembre">Novembre</option>
                                <option value="décembre">Décembre</option>
                            </select>
                            <select id="fees-type" class="form-control">
                                <option value="">Tous les types</option>
                                <option value="Frais scolaires">Frais scolaires</option>
                                <option value="Frais de l'état">Frais de l'état</option>
                                <option value="visite">visite</option>
                                <option value="achat pull">achat pull</option>
                                <option value="Autres">Autres</option>
                            </select>
                            <button id="load-fees-btn" class="btn btn-primary">Afficher</button>
                        </div>
                        
                        <div class="fees-summary">
                            <div class="fees-summary-card">
                                <h4>Total élèves</h4>
                                <p id="total-students-fees">0</p>
                            </div>
                            <div class="fees-summary-card">
                                <h4>Élèves en ordre</h4>
                                <p id="paid-students">0</p>
                            </div>
                            <div class="fees-summary-card">
                                <h4>Élèves non payés</h4>
                                <p id="unpaid-students">0</p>
                            </div>
                            <div class="fees-summary-card">
                                <h4>Taux de paiement</h4>
                                <p id="payment-rate">0%</p>
                            </div>
                        </div>
                        
                        <div class="tabs">
                            <div class="tab active" data-tab="unpaid">Élèves non payés</div>
                            <div class="tab" data-tab="paid">Élèves en ordre</div>
                            <div class="tab" data-tab="all">Tous les élèves</div>
                        </div>
                        
                        <div class="search-box">
                            <input type="text" id="fees-search" class="form-control" placeholder="Rechercher par matricule ou nom...">
                        </div>
                        
                        <div class="tab-content active" id="unpaid-tab">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Matricule</th>
                                            <th>Nom</th>
                                            <th>Type</th>
                                            <th>Classe</th>
                                            <th>Type de frais</th>
                                            <th>Montant payé</th>
                                            <th>Mois impayés</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="unpaid-students-list"></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="tab-content" id="paid-tab">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Matricule</th>
                                            <th>Nom</th>
                                            <th>Type</th>
                                            <th>Classe</th>
                                            <th>Type de frais</th>
                                            <th>Montant payé</th>
                                            <th>Dernier paiement</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="paid-students-list"></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="tab-content" id="all-tab">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Matricule</th>
                                            <th>Nom</th>
                                            <th>Type</th>
                                            <th>Classe</th>
                                            <th>Type de frais</th>
                                            <th>Montant payé</th>
                                            <th>Statut paiement</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="all-students-list"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page: Liste des Élèves -->
                <div id="students-list-page" class="page">
                    <div class="card">
                        <div class="form-row" style="justify-content: space-between; align-items: center;">
                            <h4>Liste des Élèves</h4>
                            <button id="export-students-btn" class="btn btn-primary">Télécharger la liste</button>
                        </div>
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label>Type d'élève</label>
                                <select id="student-type-filter" class="form-control">
                                    <option value="all">Tous les élèves</option>
                                    <option value="secondary">Élèves Secondaires</option>
                                    <option value="primary">Élèves Primaires</option>
                                    <option value="kindergarten">Élèves Maternelles</option>
                                </select>
                            </div>
                            <div class="search-box" style="flex: 2;">
                                <input type="text" id="student-search" class="form-control" placeholder="Rechercher par matricule, nom ou classe...">
                            </div>
                        </div>
                        <div class="filter-options">
                            <select id="filter-class" class="form-control">
                                <option value="">Toutes les classes</option>
                            </select>
                            <select id="filter-status" class="form-control">
                                <option value="">Tous les statuts</option>
                                <option value="active">Actif</option>
                                <option value="inactive">Inactif</option>
                            </select>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Photo</th>
                                        <th>Matricule</th>
                                        <th>Nom</th>
                                        <th>Type</th>
                                        <th>Classe</th>
                                        <th>Date d'inscription</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="students-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Page: Liste des Enseignants -->
                <div id="teachers-list-page" class="page">
                    <div class="card">
                        <div class="form-row" style="justify-content: space-between; align-items: center;">
                            <h4>Liste des Enseignants</h4>
                            <button id="export-teachers-btn" class="btn btn-primary">Télécharger la liste</button>
                        </div>
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label>Type d'enseignant</label>
                                <select id="teacher-type-filter" class="form-control">
                                    <option value="all">Tous les enseignants</option>
                                    <option value="secondary">Enseignants Secondaires</option>
                                    <option value="primary">Enseignants Primaires</option>
                                    <option value="kindergarten">Enseignants Maternelles</option>
                                </select>
                            </div>
                            <div class="search-box" style="flex: 2;">
                                <input type="text" id="teacher-search" class="form-control" placeholder="Rechercher par matricule, nom ou matière...">
                            </div>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Photo</th>
                                        <th>Matricule</th>
                                        <th>Nom</th>
                                        <th>Type</th>
                                        <th>Téléphone</th>
                                        <th>Matières</th>
                                        <th>Classes</th>
                                        <th>Date d'inscription</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="teachers-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Page: Valider Inscription -->
                <div id="validate-enrollment-page" class="page">
                    <div class="card">
                        <h4>Valider une inscription par code</h4>
                        <div class="form-group">
                            <label>Entrer le code d'inscription</label>
                            <input type="text" id="enrollment-code-input" class="form-control" placeholder="ENR-XXXXXX">
                        </div>
                        <button id="find-enrollment-btn" class="btn btn-primary">Rechercher</button>
                    </div>
                    <div id="enrollment-details-card" class="card hidden">
                        <h4>Détails de l'inscription</h4>
                        <form id="enrollment-form">
                            <input type="hidden" id="enrollment-id">
                            <div class="form-row">
                                <div class="form-group" style="flex: 2;">
                                    <label>Nom Complet</label>
                                    <input type="text" id="enrollment-student-name" class="form-control" required>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Date de Naissance</label>
                                    <input type="date" id="enrollment-birthdate" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Lieu de Naissance</label>
                                    <input type="text" id="enrollment-birthplace" class="form-control" required>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Sexe</label>
                                    <select id="enrollment-gender" class="form-control" required>
                                        <option value="">Sélectionner</option>
                                        <option value="M">Masculin</option>
                                        <option value="F">Féminin</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Adresse de Résidence</label>
                                <input type="text" id="enrollment-address" class="form-control" required>
                            </div>
                            
                            <div class="form-group">
                                <label>Numéro de Téléphone</label>
                                <input type="tel" id="enrollment-phone" class="form-control" required>
                            </div>
                            
                            <div class="form-group">
                                <label>Classe</label>
                                <select id="enrollment-class" class="form-control" required></select>
                            </div>

                            <div class="form-group">
                                <label>Nom du Parent</label>
                                <input type="text" id="enrollment-parent-name" class="form-control" required>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Téléphone Parent</label>
                                    <input type="tel" id="enrollment-parent-phone" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label>Adresse Parent</label>
                                    <input type="text" id="enrollment-parent-address" class="form-control" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success" style="margin-top: 1rem;">Valider l'Inscription</button>
                        </form>
                    </div>
                </div>

                <!-- Page: Rapports Administratifs -->
                <div id="admin-reports-page" class="page">
                    <div class="card">
                        <h4>Rapports Administratifs</h4>
                        <div class="admin-controls">
                            <select id="report-type" class="form-control">
                                <option value="daily">Rapport Journalier</option>
                                <option value="monthly">Rapport Mensuel</option>
                                <option value="fees">Rapport par Type de Frais</option>
                                <option value="enrollment">Rapport des Inscriptions</option>
                            </select>
                            <input type="date" id="report-date" class="form-control">
                            <select id="report-month" class="form-control">
                                <option value="janvier">Janvier</option>
                                <option value="février">Février</option>
                                <option value="mars">Mars</option>
                                <option value="avril">Avril</option>
                                <option value="mai">Mai</option>
                                <option value="juin">Juin</option>
                                <option value="juillet">Juillet</option>
                                <option value="août">Août</option>
                                <option value="septembre">Septembre</option>
                                <option value="octobre">Octobre</option>
                                <option value="novembre">Novembre</option>
                                <option value="décembre">Décembre</option>
                            </select>
                            <button id="generate-report-btn" class="btn btn-primary">Générer Rapport</button>
                            <button id="export-report-btn" class="btn btn-success">Exporter PDF</button>
                            <button id="back-report-btn" class="btn btn-secondary" style="display: none;">
                                <i class="fas fa-arrow-left"></i> Retour
                            </button>
                        </div>
                        
                        <div id="report-content" class="hidden">
                            <div class="report-card">
                                <div class="report-header">
                                    <h3 id="report-title">Rapport des Paiements</h3>
                                    <span id="report-period"></span>
                                </div>
                                <div class="report-summary">
                                    <div class="fees-summary-card">
                                        <h4>Total Paiements</h4>
                                        <p id="total-payments">0</p>
                                    </div>
                                    <div class="fees-summary-card">
                                        <h4>Montant Total</h4>
                                        <p id="total-amount" class="currency-display">$0.00</p>
                                    </div>
                                    <div class="fees-summary-card">
                                        <h4>Paiements en ligne</h4>
                                        <p id="online-payments">0</p>
                                    </div>
                                    <div class="fees-summary-card">
                                        <h4>Paiements sur place</h4>
                                        <p id="onsite-payments">0</p>
                                    </div>
                                </div>
                                
                                <!-- Section des statistiques par type de frais -->
                                <div id="fees-breakdown-section" class="hidden">
                                    <h4 style="margin-top: 2rem;">Détail par Type de Frais</h4>
                                    <div class="table-container">
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th>Type de Frais</th>
                                                    <th>Nombre de Paiements</th>
                                                    <th>Montant Total</th>
                                                    <th>Pourcentage</th>
                                                </tr>
                                            </thead>
                                            <tbody id="fees-breakdown-table"></tbody>
                                            <tfoot>
                                                <tr>
                                                    <td><strong>TOTAL GÉNÉRAL</strong></td>
                                                    <td id="total-payments-breakdown">0</td>
                                                    <td id="total-amount-breakdown" class="currency-display">$0.00</td>
                                                    <td>100%</td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                                
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Élève</th>
                                                <th>Type</th>
                                                <th>Classe</th>
                                                <th>Mois</th>
                                                <th>Type de Frais</th>
                                                <th>Montant</th>
                                                <th>Méthode</th>
                                                <th>Validé par</th>
                                            </tr>
                                        </thead>
                                        <tbody id="report-table-body"></tbody>
                                    </table>
                                </div>
                                <div class="signature-area">
                                    <div class="signature-box">
                                        <p>Le Secrétaire</p>
                                        <div class="signature-line"></div>
                                    </div>
                                    <div class="signature-box">
                                        <p>Le Directeur</p>
                                        <div class="signature-line"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page: Profil -->
                <div id="profile-page" class="page">
                    <div class="card">
                        <h4>Mon Profil</h4>
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <div class="photo-upload">
                                    <div class="photo-placeholder" id="profile-photo-preview">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <input type="file" id="profile-photo" class="file-input" accept="image/*">
                                    <button type="button" class="upload-btn" onclick="document.getElementById('profile-photo').click()">
                                        <i class="fas fa-upload"></i> Changer la photo
                                    </button>
                                </div>
                            </div>
                            <div class="form-group" style="flex: 2;">
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <label>Nom Complet</label>
                                        <input type="text" id="profile-name" class="form-control" readonly>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label>Email</label>
                                        <input type="email" id="profile-email" class="form-control" readonly>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <label>Téléphone</label>
                                        <input type="tel" id="profile-phone" class="form-control">
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label>Date d'inscription</label>
                                        <input type="text" id="profile-created" class="form-control" readonly>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Adresse</label>
                                    <input type="text" id="profile-address" class="form-control">
                                </div>
                                <button id="update-profile-btn" class="btn btn-primary">Mettre à jour le profil</button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="student-details-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Détails de l'élève</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="student-details-content">
                <!-- Contenu généré dynamiquement -->
            </div>
        </div>
    </div>

    <div id="teacher-details-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Détails de l'enseignant</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="teacher-details-content">
                <!-- Contenu généré dynamiquement -->
            </div>
        </div>
    </div>

    <div id="edit-student-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Modifier l'élève</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="edit-student-form">
                <input type="hidden" id="edit-student-id">
                <div class="form-group">
                    <label>Nom Complet</label>
                    <input type="text" id="edit-student-name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Date de Naissance</label>
                    <input type="date" id="edit-student-birthdate" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Lieu de Naissance</label>
                    <input type="text" id="edit-student-birthplace" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Sexe</label>
                    <select id="edit-student-gender" class="form-control" required>
                        <option value="">Sélectionner</option>
                        <option value="M">Masculin</option>
                        <option value="F">Féminin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Adresse de Résidence</label>
                    <input type="text" id="edit-student-address" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Numéro de Téléphone</label>
                    <input type="tel" id="edit-student-phone" class="form-control">
                </div>
                <div class="form-group">
                    <label>Classe</label>
                    <select id="edit-student-class" class="form-control" required></select>
                </div>
                <div class="form-group">
                    <label>Frais d'inscription ($)</label>
                    <div class="currency-input-group">
                        <span class="currency-symbol">$</span>
                        <input type="number" id="edit-student-fees" class="form-control currency-input" step="0.01" min="0" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Nom du Parent</label>
                    <input type="text" id="edit-parent-name" class="form-control" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Téléphone Parent</label>
                        <input type="tel" id="edit-parent-phone" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Adresse Parent</label>
                        <input type="text" id="edit-parent-address" class="form-control" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Statut</label>
                    <select id="edit-student-status" class="form-control" required>
                        <option value="active">Actif</option>
                        <option value="inactive">Inactif</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Enregistrer les modifications</button>
            </form>
        </div>
    </div>

    <div id="edit-teacher-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Modifier l'enseignant</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="edit-teacher-form">
                <input type="hidden" id="edit-teacher-id">
                <div class="form-group">
                    <label>Nom Complet</label>
                    <input type="text" id="edit-teacher-name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Date de Naissance</label>
                    <input type="date" id="edit-teacher-birthdate" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Lieu de Naissance</label>
                    <input type="text" id="edit-teacher-birthplace" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Sexe</label>
                    <select id="edit-teacher-gender" class="form-control" required>
                        <option value="">Sélectionner</option>
                        <option value="M">Masculin</option>
                                        <option value="F">Féminin</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Adresse de Résidence</label>
                                    <input type="text" id="edit-teacher-address" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label>Numéro de Téléphone</label>
                                    <input type="tel" id="edit-teacher-phone" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label>Matières (séparées par une virgule)</label>
                                    <input type="text" id="edit-teacher-subjects" class="form-control" placeholder="Ex: Mathématiques, Physique">
                                </div>
                                <div class="form-group">
                                    <label>Classes à gérer</label>
                                    <div id="edit-teacher-classes-container" class="teacher-classes">
                                        <!-- Les classes seront chargées dynamiquement -->
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Statut</label>
                                    <select id="edit-teacher-status" class="form-control" required>
                                        <option value="active">Actif</option>
                                        <option value="inactive">Inactif</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">Enregistrer les modifications</button>
                            </form>
                        </div>
                    </div>

                    <div id="receipt-modal" class="modal hidden">
                        <div class="modal-content" style="max-width: 700px;">
                            <div class="modal-header">
                                <h3>Reçu de paiement</h3>
                                <button class="close-modal">&times;</button>
                            </div>
                            <div id="receipt-content">
                                <!-- Contenu du reçu généré dynamiquement -->
                            </div>
                            <div style="text-align: center; margin-top: 1rem;">
                                <button id="print-receipt-btn" class="btn btn-primary">Imprimer le reçu</button>
                                <button id="back-receipt-btn" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left"></i> Retour
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Modal pour l'impression du bordereau d'inscription -->
                    <div id="enrollment-slip-modal" class="modal hidden">
                        <div class="modal-content" style="max-width: 800px;">
                            <div class="modal-header">
                                <h3>Bordereau d'Inscription</h3>
                                <button class="close-modal">&times;</button>
                            </div>
                            <div id="enrollment-slip-content">
                                <!-- Contenu du bordereau généré dynamiquement -->
                            </div>
                            <div style="text-align: center; margin-top: 1rem;">
                                <button id="print-enrollment-slip-btn" class="btn btn-primary">
                                    <i class="fas fa-print"></i> Imprimer le Bordereau
                                </button>
                                <button id="back-enrollment-slip-btn" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left"></i> Retour
                                </button>
                            </div>
                        </div>
                    </div>

                   <script type="module">
                    // 1. INITIALISATION DE FIREBASE
                    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
                    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
                    import { getFirestore, collection, getDocs, query, where, addDoc, serverTimestamp, doc, updateDoc, writeBatch, orderBy, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

                    // CONFIGURATION FIREBASE
                    const firebaseConfig = {
                      apiKey: "AIzaSyBn7VIddclO7KtrXb5sibCr9SjVLjOy-qI",
                      authDomain: "theo1d.firebaseapp.com",
                      projectId: "theo1d",
                      storageBucket: "theo1d.firebasestorage.app",
                      messagingSenderId: "269629842962",
                      appId: "1:269629842962:web:a80a12b04448fe1e595acb",
                      measurementId: "G-TNSG1XFMDZ"
                    };

                    const app = initializeApp(firebaseConfig);
                    const auth = getAuth(app);
                    const db = getFirestore(app);

                    // 2. CONFIGURATION CLOUDINARY
                    const CLOUDINARY_CONFIG = {
                        cloudName: 'diwn8sxtn',
                        uploadPreset: 'cs_lacolombe'
                    };

                    // 3. FONCTION UPLOAD CLOUDINARY (optimisée)
                    async function uploadToCloudinary(file, folder = 'cs-lacolombe') {
                        if (!file) return null;
                        
                        return new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = async (e) => {
                                try {
                                    const formData = new FormData();
                                    formData.append('file', file);
                                    formData.append('upload_preset', CLOUDINARY_CONFIG.uploadPreset);
                                    formData.append('folder', folder);
                                    
                                    const response = await fetch(
                                        `https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloudName}/image/upload`,
                                        { 
                                            method: 'POST', 
                                            body: formData 
                                        }
                                    );
                                    
                                    if (!response.ok) {
                                        throw new Error(`HTTP error! status: ${response.status}`);
                                    }
                                    
                                    const data = await response.json();
                                    resolve(data.secure_url);
                                } catch (error) {
                                    reject(error);
                                }
                            };
                            reader.onerror = () => reject(new Error('Erreur de lecture du fichier'));
                            reader.readAsDataURL(file);
                        });
                    }

                    // 4. LOGIQUE SPÉCIFIQUE À LA PAGE SECRÉTARIAT
                    const loginOverlay = document.getElementById('login-overlay');
                    const appRoot = document.getElementById('app-root');
                    const splashScreen = document.getElementById('splash-screen');
                    let currentSecretary = null;

                    // Variables pour stocker les photos temporairement
                    let studentPhotoFile = null;
                    let teacherPhotoFile = null;
                    let profilePhotoFile = null;
                    let primaryStudentPhotoFile = null;
                    let primaryTeacherPhotoFile = null;
                    let kindergartenStudentPhotoFile = null;
                    let kindergartenTeacherPhotoFile = null;

                    // Variables pour la gestion hors ligne
                    let isOnline = navigator.onLine;
                    let deferredPrompt = null;
                    let offlineQueue = [];

                    // Dernier élève inscrit (pour l'impression du bordereau)
                    let lastEnrolledStudent = null;

                    // --- Gestion des photos ---
                    document.getElementById('student-photo').addEventListener('change', function(e) {
                        const file = e.target.files[0];
                        if (file) {
                            if (file.size > 5 * 1024 * 1024) {
                                showAlert("La photo ne doit pas dépasser 5MB", "error");
                                return;
                            }
                            if (!file.type.startsWith('image/')) {
                                showAlert("Veuillez sélectionner une image valide", "error");
                                return;
                            }
                            studentPhotoFile = file;
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                document.getElementById('student-photo-preview').innerHTML = `<img src="${e.target.result}" class="photo-preview">`;
                            }
                            reader.readAsDataURL(file);
                        }
                    });

                    document.getElementById('primary-student-photo').addEventListener('change', function(e) {
                        const file = e.target.files[0];
                        if (file) {
                            if (file.size > 5 * 1024 * 1024) {
                                showAlert("La photo ne doit pas dépasser 5MB", "error");
                                return;
                            }
                            if (!file.type.startsWith('image/')) {
                                showAlert("Veuillez sélectionner une image valide", "error");
                                return;
                            }
                            primaryStudentPhotoFile = file;
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                document.getElementById('primary-student-photo-preview').innerHTML = `<img src="${e.target.result}" class="photo-preview">`;
                            }
                            reader.readAsDataURL(file);
                        }
                    });

                    document.getElementById('kindergarten-student-photo').addEventListener('change', function(e) {
                        const file = e.target.files[0];
                        if (file) {
                            if (file.size > 5 * 1024 * 1024) {
                                showAlert("La photo ne doit pas dépasser 5MB", "error");
                                return;
                            }
                            if (!file.type.startsWith('image/')) {
                                showAlert("Veuillez sélectionner une image valide", "error");
                                return;
                            }
                            kindergartenStudentPhotoFile = file;
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                document.getElementById('kindergarten-student-photo-preview').innerHTML = `<img src="${e.target.result}" class="photo-preview">`;
                            }
                            reader.readAsDataURL(file);
                        }
                    });

                    document.getElementById('teacher-photo').addEventListener('change', function(e) {
                        const file = e.target.files[0];
                        if (file) {
                            if (file.size > 5 * 1024 * 1024) {
                                showAlert("La photo ne doit pas dépasser 5MB", "error");
                                return;
                            }
                            if (!file.type.startsWith('image/')) {
                                showAlert("Veuillez sélectionner une image valide", "error");
                                return;
                            }
                            teacherPhotoFile = file;
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                document.getElementById('teacher-photo-preview').innerHTML = `<img src="${e.target.result}" class="photo-preview">`;
                            }
                            reader.readAsDataURL(file);
                        }
                    });

                    document.getElementById('primary-teacher-photo').addEventListener('change', function(e) {
                        const file = e.target.files[0];
                        if (file) {
                            if (file.size > 5 * 1024 * 1024) {
                                showAlert("La photo ne doit pas dépasser 5MB", "error");
                                return;
                            }
                            if (!file.type.startsWith('image/')) {
                                showAlert("Veuillez sélectionner une image valide", "error");
                                return;
                            }
                            primaryTeacherPhotoFile = file;
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                document.getElementById('primary-teacher-photo-preview').innerHTML = `<img src="${e.target.result}" class="photo-preview">`;
                            }
                            reader.readAsDataURL(file);
                        }
                    });

                    document.getElementById('kindergarten-teacher-photo').addEventListener('change', function(e) {
                        const file = e.target.files[0];
                        if (file) {
                            if (file.size > 5 * 1024 * 1024) {
                                showAlert("La photo ne doit pas dépasser 5MB", "error");
                                return;
                            }
                            if (!file.type.startsWith('image/')) {
                                showAlert("Veuillez sélectionner une image valide", "error");
                                return;
                            }
                            kindergartenTeacherPhotoFile = file;
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                document.getElementById('kindergarten-teacher-photo-preview').innerHTML = `<img src="${e.target.result}" class="photo-preview">`;
                            }
                            reader.readAsDataURL(file);
                        }
                    });

                    document.getElementById('profile-photo').addEventListener('change', function(e) {
                        const file = e.target.files[0];
                        if (file) {
                            if (file.size > 5 * 1024 * 1024) {
                                showAlert("La photo ne doit pas dépasser 5MB", "error");
                                return;
                            }
                            if (!file.type.startsWith('image/')) {
                                showAlert("Veuillez sélectionner une image valide", "error");
                                return;
                            }
                            profilePhotoFile = file;
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                document.getElementById('profile-photo-preview').innerHTML = `<img src="${e.target.result}" class="photo-preview">`;
                            }
                            reader.readAsDataURL(file);
                        }
                    });

                    // --- Gestion de l'écran de démarrage ---
                    setTimeout(() => {
                        splashScreen.classList.add('hidden');
                        checkAuthentication();
                    }, 5000);

                    // --- Authentification renforcée ---
                    function checkAuthentication() {
                        // Vérifier si l'utilisateur est déjà connecté
                        const user = auth.currentUser;
                        if (user) {
                            // Déconnecter l'utilisateur pour forcer la reconnexion
                            signOut(auth).then(() => {
                                loginOverlay.classList.remove('hidden');
                                showLoginAlert("Veuillez vous reconnecter", "info");
                            });
                        } else {
                            loginOverlay.classList.remove('hidden');
                        }
                    }

                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            try {
                                // Suppression de la vérification de portail - accès direct
                                const q = query(collection(db, 'secretary'), where('uid', '==', user.uid));
                                const snap = await getDocs(q);
                                
                                // Si le secrétaire n'existe pas encore dans Firestore, le créer
                                if (snap.empty) {
                                    // Créer un nouveau document secrétaire
                                    const secretaryData = {
                                        uid: user.uid,
                                        fullName: user.email.split('@')[0],
                                        email: user.email,
                                        createdAt: serverTimestamp(),
                                        updatedAt: serverTimestamp()
                                    };
                                    
                                    const newSecretaryRef = await addDoc(collection(db, 'secretary'), secretaryData);
                                    currentSecretary = { id: newSecretaryRef.id, ...secretaryData };
                                } else {
                                    currentSecretary = { id: snap.docs[0].id, ...snap.docs[0].data() };
                                }
                                
                                loginOverlay.classList.add('hidden');
                                appRoot.classList.remove('hidden');
                                document.getElementById('secretary-name').textContent = currentSecretary.fullName;
                                
                                // Afficher la photo de profil du secrétaire
                                const photoContainer = document.getElementById('secretary-photo-container');
                                if (currentSecretary.photoURL) {
                                    photoContainer.innerHTML = `<img src="${currentSecretary.photoURL}" class="secretary-photo" alt="Photo de profil">`;
                                } else {
                                    photoContainer.innerHTML = `<div class="secretary-photo-placeholder"><i class="fas fa-user"></i></div>`;
                                }
                                
                                // Charger les données du profil
                                loadProfileData();
                                initializePortal();
                            } catch (error) {
                                console.error("Erreur initialisation secrétaire:", error);
                                showLoginAlert("Erreur lors de l'initialisation du compte", "error");
                            }
                        } else {
                            // Toujours afficher l'écran de connexion si pas d'utilisateur
                            loginOverlay.classList.remove('hidden');
                            appRoot.classList.add('hidden');
                        }
                    });

                    function showLoginAlert(message, type = 'info') {
                        const alertBox = document.getElementById('login-alert');
                        alertBox.textContent = message;
                        alertBox.className = `alert alert-${type}`;
                        alertBox.classList.remove('hidden');
                        setTimeout(() => alertBox.classList.add('hidden'), 6000);
                    }

                    document.getElementById('login-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const email = document.getElementById('login-email').value;
                        const password = document.getElementById('login-password').value;
                        
                        const submitBtn = e.target.querySelector('button[type="submit"]');
                        const originalText = submitBtn.textContent;
                        submitBtn.textContent = 'Connexion...';
                        submitBtn.disabled = true;

                        try {
                            await signInWithEmailAndPassword(auth, email, password);
                            showLoginAlert("Connexion réussie !", "success");
                            // La redirection se fera automatiquement via onAuthStateChanged
                        } catch (error) {
                            console.error("Erreur connexion:", error);
                            let errorMessage = "Email ou mot de passe incorrect.";
                            if (error.code === 'auth/invalid-email') {
                                errorMessage = "Adresse email invalide.";
                            } else if (error.code === 'auth/user-disabled') {
                                errorMessage = "Ce compte a été désactivé.";
                            } else if (error.code === 'auth/user-not-found') {
                                errorMessage = "Aucun compte trouvé avec cette adresse email.";
                            } else if (error.code === 'auth/wrong-password') {
                                errorMessage = "Mot de passe incorrect.";
                            } else if (error.code === 'auth/network-request-failed') {
                                errorMessage = "Erreur de réseau. Vérifiez votre connexion internet.";
                            }
                            showLoginAlert(errorMessage, "error");
                        } finally {
                            submitBtn.textContent = originalText;
                            submitBtn.disabled = false;
                        }
                    });

                    document.getElementById('logout-btn').addEventListener('click', () => {
                        signOut(auth);
                        showAlert("Déconnexion réussie", "success");
                    });

                    // --- Gestion PWA ---
                    // Événement d'installation
                    window.addEventListener('beforeinstallprompt', (e) => {
                        e.preventDefault();
                        deferredPrompt = e;
                        document.getElementById('install-btn').style.display = 'block';
                    });

                    document.getElementById('install-btn').addEventListener('click', async () => {
                        if (deferredPrompt) {
                            deferredPrompt.prompt();
                            const { outcome } = await deferredPrompt.userChoice;
                            if (outcome === 'accepted') {
                                document.getElementById('install-btn').style.display = 'none';
                            }
                            deferredPrompt = null;
                        }
                    });

                    // Gestion du statut de connexion
                    function updateConnectionStatus() {
                        const statusElement = document.getElementById('connection-status');
                        if (isOnline) {
                            statusElement.className = 'connection-status online';
                            statusElement.innerHTML = '<span class="status-indicator status-online"></span><span>En ligne</span>';
                        } else {
                            statusElement.className = 'connection-status offline';
                            statusElement.innerHTML = '<span class="status-indicator status-offline"></span><span>Hors ligne</span>';
                        }
                    }

                    window.addEventListener('online', () => {
                        isOnline = true;
                        updateConnectionStatus();
                        showAlert("Connexion rétablie - Synchronisation en cours...", "success");
                        syncOfflineData();
                    });

                    window.addEventListener('offline', () => {
                        isOnline = false;
                        updateConnectionStatus();
                        showAlert("Mode hors ligne activé - Les données seront sauvegardées localement", "warning");
                    });

                    // Initialiser le statut de connexion
                    updateConnectionStatus();

                    // Gestion des données hors ligne
                    function addToOfflineQueue(action, data) {
                        offlineQueue.push({ action, data, timestamp: new Date().getTime() });
                        localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
                    }

                    async function syncOfflineData() {
                        if (!isOnline) return;

                        const queue = JSON.parse(localStorage.getItem('offlineQueue') || '[]');
                        if (queue.length === 0) return;

                        showAlert("Synchronisation des données hors ligne...", "info");

                        for (const item of queue) {
                            try {
                                // Implémenter la logique de synchronisation selon l'action
                                switch (item.action) {
                                    case 'addStudent':
                                        // Logique pour ajouter l'étudiant
                                        break;
                                    case 'addTeacher':
                                        // Logique pour ajouter l'enseignant
                                        break;
                                    // Ajouter d'autres actions selon les besoins
                                }
                            } catch (error) {
                                console.error("Erreur synchronisation:", error);
                            }
                        }

                        // Vider la file d'attente après synchronisation
                        localStorage.removeItem('offlineQueue');
                        offlineQueue = [];
                        showAlert("Synchronisation terminée", "success");
                    }

                    // --- Initialisation et Fonctions Utilitaires ---
                    function initializePortal() {
                        loadClassesIntoSelects();
                        loadClassesList();
                        loadPrimaryClassesList();
                        loadKindergartenClassesList();
                        loadDashboardStats();
                        loadStudentsList();
                        loadTeachersList();
                        loadPendingPaymentsList();
                        loadTeacherClasses();
                        loadPrimaryTeacherClasses();
                        loadKindergartenTeacherClasses();
                        loadFeesClasses();
                        setupPaymentForm();
                        setupStatsNavigation();
                        setupMenuDropdowns();
                        
                        // Charger les données hors ligne si disponibles
                        if (localStorage.getItem('offlineQueue')) {
                            offlineQueue = JSON.parse(localStorage.getItem('offlineQueue'));
                        }
                    }

                    function showAlert(message, type = 'info') {
                        const alertBox = document.getElementById('global-alert');
                        alertBox.textContent = message;
                        alertBox.className = `alert alert-${type}`;
                        alertBox.classList.remove('hidden');
                        setTimeout(() => alertBox.classList.add('hidden'), 6000);
                    }

                    function formatDate(date) {
                        if (!date) return 'Non définie';
                        return date.toLocaleDateString('fr-FR', { 
                            day: '2-digit', 
                            month: '2-digit', 
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    }

                    function generatePassword() {
                        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                        let password = '';
                        for (let i = 0; i < 8; i++) {
                            password += chars.charAt(Math.floor(Math.random() * chars.length));
                        }
                        return password;
                    }

                    function generatePaymentCode() {
                        return 'PAY-' + Math.random().toString(36).substring(2, 8).toUpperCase();
                    }

                    function generateEnrollmentCode() {
                        return 'ENR-' + Math.random().toString(36).substring(2, 8).toUpperCase();
                    }

                    // --- Gestion des menus déroulants ---
                    function setupMenuDropdowns() {
                        document.querySelectorAll('.has-submenu > a').forEach(link => {
                            link.addEventListener('click', function(e) {
                                e.preventDefault();
                                const parent = this.parentElement;
                                parent.classList.toggle('active');
                            });
                        });
                    }

                    // --- Navigation des cartes de statistiques ---
                    function setupStatsNavigation() {
                        document.querySelectorAll('.stat-card').forEach(card => {
                            card.addEventListener('click', function() {
                                const targetPage = this.getAttribute('data-target');
                                if (targetPage) {
                                    document.querySelectorAll('.nav-menu a, .page').forEach(el => el.classList.remove('active'));
                                    document.querySelector(`.nav-menu a[data-page="${targetPage}"]`).classList.add('active');
                                    document.getElementById(targetPage + '-page').classList.add('active');
                                    document.getElementById('page-title').textContent = document.querySelector(`.nav-menu a[data-page="${targetPage}"]`).textContent;
                                }
                            });
                        });
                    }

                    // --- Tableau de Bord ---
                    async function loadDashboardStats() {
                        try {
                            // Compter les élèves secondaires
                            const studentsSnap = await getDocs(query(collection(db, 'students'), where('status', '!=', 'deleted')));
                            // Compter les élèves primaires
                            const primaryStudentsSnap = await getDocs(query(collection(db, 'primary_students'), where('status', '!=', 'deleted')));
                            // Compter les élèves maternelles
                            const kindergartenStudentsSnap = await getDocs(query(collection(db, 'kindergarten_students'), where('status', '!=', 'deleted')));
                            const totalStudents = studentsSnap.size + primaryStudentsSnap.size + kindergartenStudentsSnap.size;
                            document.getElementById('total-students').textContent = totalStudents;
                            
                            // Compter les enseignants secondaires
                            const teachersSnap = await getDocs(query(collection(db, 'teachers'), where('status', '!=', 'deleted')));
                            // Compter les enseignants primaires
                            const primaryTeachersSnap = await getDocs(query(collection(db, 'primary_teachers'), where('status', '!=', 'deleted')));
                            // Compter les enseignants maternelles
                            const kindergartenTeachersSnap = await getDocs(query(collection(db, 'kindergarten_teachers'), where('status', '!=', 'deleted')));
                            const totalTeachers = teachersSnap.size + primaryTeachersSnap.size + kindergartenTeachersSnap.size;
                            document.getElementById('total-teachers').textContent = totalTeachers;
                            
                            // Compter les classes secondaires
                            const classesSnap = await getDocs(collection(db, 'classes'));
                            // Compter les classes primaires
                            const primaryClassesSnap = await getDocs(collection(db, 'primary_classes'));
                            // Compter les classes maternelles
                            const kindergartenClassesSnap = await getDocs(collection(db, 'kindergarten_classes'));
                            const totalClasses = classesSnap.size + primaryClassesSnap.size + kindergartenClassesSnap.size;
                            document.getElementById('total-classes').textContent = totalClasses;
                            
                            // Compter les paiements en attente
                            const pendingPaymentsSnap = await getDocs(query(collection(db, 'payment_requests'), where('status', '==', 'pending')));
                            document.getElementById('pending-payments').textContent = pendingPaymentsSnap.size;
                            
                            // Charger les activités récentes
                            loadRecentActivities();
                        } catch (error) {
                            console.error('Erreur chargement stats:', error);
                        }
                    }

                    async function loadRecentActivities() {
                        const activitiesEl = document.getElementById('recent-activities');
                        activitiesEl.innerHTML = '<p>Chargement...</p>';
                        
                        try {
                            // Récupérer les 10 dernières activités
                            const activities = [];
                            
                            // Récupérer les dernières inscriptions d'élèves secondaires
                            const studentsSnap = await getDocs(query(collection(db, 'students'), where('status', '!=', 'deleted'), orderBy('createdAt', 'desc')));
                            studentsSnap.forEach(doc => {
                                const data = doc.data();
                                activities.push({
                                    type: 'student_enrollment',
                                    message: `Nouvel élève secondaire inscrit: ${data.fullName}`,
                                    date: data.createdAt?.toDate(),
                                    icon: 'fa-user-plus',
                                    color: 'success'
                                });
                            });
                            
                            // Récupérer les dernières inscriptions d'élèves primaires
                            const primaryStudentsSnap = await getDocs(query(collection(db, 'primary_students'), where('status', '!=', 'deleted'), orderBy('createdAt', 'desc')));
                            primaryStudentsSnap.forEach(doc => {
                                const data = doc.data();
                                activities.push({
                                    type: 'primary_student_enrollment',
                                    message: `Nouvel élève primaire inscrit: ${data.fullName}`,
                                    date: data.createdAt?.toDate(),
                                    icon: 'fa-user-plus',
                                    color: 'info'
                                });
                            });
                            
                            // Récupérer les dernières inscriptions d'élèves maternelles
                            const kindergartenStudentsSnap = await getDocs(query(collection(db, 'kindergarten_students'), where('status', '!=', 'deleted'), orderBy('createdAt', 'desc')));
                            kindergartenStudentsSnap.forEach(doc => {
                                const data = doc.data();
                                activities.push({
                                    type: 'kindergarten_student_enrollment',
                                    message: `Nouvel élève maternelle inscrit: ${data.fullName}`,
                                    date: data.createdAt?.toDate(),
                                    icon: 'fa-user-plus',
                                    color: 'info'
                                });
                            });
                            
                            // Récupérer les dernières inscriptions d'enseignants secondaires
                            const teachersSnap = await getDocs(query(collection(db, 'teachers'), where('status', '!=', 'deleted'), orderBy('createdAt', 'desc')));
                            teachersSnap.forEach(doc => {
                                const data = doc.data();
                                activities.push({
                                    type: 'teacher_enrollment',
                                    message: `Nouvel enseignant secondaire inscrit: ${data.fullName}`,
                                    date: data.createdAt?.toDate(),
                                    icon: 'fa-user-tie',
                                    color: 'info'
                                });
                            });
                            
                            // Récupérer les dernières inscriptions d'enseignants primaires
                            const primaryTeachersSnap = await getDocs(query(collection(db, 'primary_teachers'), where('status', '!=', 'deleted'), orderBy('createdAt', 'desc')));
                            primaryTeachersSnap.forEach(doc => {
                                const data = doc.data();
                                activities.push({
                                    type: 'primary_teacher_enrollment',
                                    message: `Nouvel enseignant primaire inscrit: ${data.fullName}`,
                                    date: data.createdAt?.toDate(),
                                    icon: 'fa-user-tie',
                                    color: 'info'
                                });
                            });
                            
                            // Récupérer les dernières inscriptions d'enseignants maternelles
                            const kindergartenTeachersSnap = await getDocs(query(collection(db, 'kindergarten_teachers'), where('status', '!=', 'deleted'), orderBy('createdAt', 'desc')));
                            kindergartenTeachersSnap.forEach(doc => {
                                const data = doc.data();
                                activities.push({
                                    type: 'kindergarten_teacher_enrollment',
                                    message: `Nouvel enseignant maternelle inscrit: ${data.fullName}`,
                                    date: data.createdAt?.toDate(),
                                    icon: 'fa-user-tie',
                                    color: 'info'
                                });
                            });
                            
                            // Récupérer les derniers paiements
                            const paymentsSnap = await getDocs(query(collection(db, 'payments'), orderBy('validatedAt', 'desc')));
                            paymentsSnap.forEach(doc => {
                                const data = doc.data();
                                activities.push({
                                    type: 'payment',
                                    message: `Paiement validé pour ${data.studentName}: $${data.amount}`,
                                    date: data.validatedAt?.toDate(),
                                    icon: 'fa-money-bill-wave',
                                    color: 'success'
                                });
                            });
                            
                            // Trier par date et prendre les 10 plus récentes
                            activities.sort((a, b) => b.date - a.date);
                            const recentActivities = activities.slice(0, 10);
                            
                            let activitiesHTML = '';
                            
                            if (recentActivities.length === 0) {
                                activitiesHTML = '<p>Aucune activité récente</p>';
                            } else {
                                recentActivities.forEach(activity => {
                                    activitiesHTML += `
                                        <div style="padding: 10px 0; border-bottom: 1px solid #eee;">
                                            <i class="fas ${activity.icon}" style="color: var(--${activity.color});"></i>
                                            <span>${activity.message}</span>
                                            <small style="color: #666; display: block;">${formatDate(activity.date)}</small>
                                        </div>
                                    `;
                                });
                            }
                            
                            activitiesEl.innerHTML = activitiesHTML;
                        } catch (error) {
                            console.error("Erreur chargement activités:", error);
                            activitiesEl.innerHTML = '<p>Erreur de chargement</p>';
                        }
                    }

                    // --- Inscription Élève Secondaire (optimisée) ---
                    document.getElementById('student-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const form = e.target;
                        const studentName = document.getElementById('student-name').value;
                        const birthdate = document.getElementById('student-birthdate').value;
                        const birthplace = document.getElementById('student-birthplace').value;
                        const gender = document.getElementById('student-gender').value;
                        const address = document.getElementById('student-address').value;
                        const phone = document.getElementById('student-phone').value;
                        const studentClass = document.getElementById('student-class').value;
                        const enrollmentFees = parseFloat(document.getElementById('student-fees').value) || 0;
                        const parentName = document.getElementById('parent-name').value;
                        const parentPhone = document.getElementById('parent-phone').value;
                        const parentAddress = document.getElementById('parent-address').value;
                        const year = new Date().getFullYear();

                        // Validation basique
                        if (!studentName || !birthdate || !studentClass || !parentName || !parentPhone) {
                            showAlert("Veuillez remplir tous les champs obligatoires", "error");
                            return;
                        }

                        const submitBtn = document.getElementById('student-submit-btn');
                        const originalText = submitBtn.textContent;
                        
                        try {
                            // Afficher le chargement
                            submitBtn.textContent = 'Inscription en cours...';
                            submitBtn.disabled = true;

                            console.log("Début de l'inscription pour:", studentName);

                            // Générer matricule
                            const q = query(collection(db, 'students'), where('year', '==', year));
                            const countSnap = await getDocs(q);
                            const matricule = `SEC${year}${(countSnap.size + 1).toString().padStart(3, '0')}`;

                            console.log("Matricule généré:", matricule);

                            // Uploader la photo vers Cloudinary si elle existe (en parallèle)
                            let photoURL = null;
                            if (studentPhotoFile) {
                                try {
                                    photoURL = await uploadToCloudinary(studentPhotoFile, `students/${matricule}`);
                                    console.log("✅ Photo élève uploadée:", photoURL);
                                } catch (uploadError) {
                                    console.error("❌ Erreur photo élève:", uploadError);
                                    // Continuer sans photo si l'upload échoue
                                }
                            }

                            // Créer l'élève dans Firestore
                            const studentData = {
                                matricule,
                                fullName: studentName,
                                birthdate,
                                birthplace,
                                gender,
                                address,
                                phone,
                                class: studentClass,
                                enrollmentFees,
                                parentName,
                                parentPhone,
                                parentAddress,
                                photoURL,
                                studentType: 'secondary',
                                status: 'active',
                                year,
                                createdAt: serverTimestamp(),
                                updatedAt: serverTimestamp()
                            };

                            console.log("Données élève préparées:", studentData);

                            // Utiliser setDoc avec l'ID comme matricule pour éviter les doublons
                            const studentRef = doc(db, 'students', matricule);
                            await setDoc(studentRef, studentData);
                            console.log("Élève sauvegardé dans Firestore");

                            // Sauvegarder le dernier élève inscrit pour l'impression
                            lastEnrolledStudent = { ...studentData, id: matricule };
                            
                            // Enregistrer les frais d'inscription comme un paiement
                            if (enrollmentFees > 0) {
                                const paymentData = {
                                    studentId: matricule,
                                    studentName: studentName,
                                    studentClass: studentClass,
                                    studentType: 'secondary',
                                    month: 'inscription',
                                    paymentType: 'Frais d\'inscription',
                                    amount: enrollmentFees,
                                    validatedBy: currentSecretary.uid,
                                    validatedAt: serverTimestamp(),
                                    createdAt: serverTimestamp(),
                                    paymentMethod: 'onsite',
                                    description: 'Frais d\'inscription pour l\'année scolaire'
                                };
                                
                                const paymentRef = doc(collection(db, 'payments'));
                                await setDoc(paymentRef, paymentData);
                            }

                            showAlert(`Élève secondaire ${studentName} inscrit avec succès! Matricule: ${matricule}`, 'success');
                            form.reset();
                            studentPhotoFile = null;
                            document.getElementById('student-photo-preview').innerHTML = '<i class="fas fa-camera"></i>';
                            
                            // Afficher le bouton d'impression du bordereau
                            document.getElementById('print-student-btn').style.display = 'inline-block';
                            
                            // Mettre à jour les statistiques et listes
                            loadDashboardStats();
                            loadStudentsList();

                        } catch (error) {
                            console.error('Erreur complète inscription élève:', error);
                            if (!isOnline) {
                                // Sauvegarder localement
                                addToOfflineQueue('addStudent', { studentData: studentData });
                                showAlert(`Élève sauvegardé localement (hors ligne). Matricule: ${matricule}`, 'warning');
                                form.reset();
                                studentPhotoFile = null;
                                document.getElementById('student-photo-preview').innerHTML = '<i class="fas fa-camera"></i>';
                            } else {
                                showAlert(`Erreur lors de l'inscription: ${error.message}`, 'error');
                            }
                        } finally {
                            // Réactiver le bouton
                            submitBtn.textContent = originalText;
                            submitBtn.disabled = false;
                        }
                    });

                    // --- Inscription Élève Primaire ---
                    document.getElementById('primary-student-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const form = e.target;
                        const studentName = document.getElementById('primary-student-name').value;
                        const birthdate = document.getElementById('primary-student-birthdate').value;
                        const birthplace = document.getElementById('primary-student-birthplace').value;
                        const gender = document.getElementById('primary-student-gender').value;
                        const address = document.getElementById('primary-student-address').value;
                        const studentClass = document.getElementById('primary-student-class').value;
                        const enrollmentFees = parseFloat(document.getElementById('primary-student-fees').value) || 0;
                        const parentName = document.getElementById('primary-parent-name').value;
                        const parentPhone = document.getElementById('primary-parent-phone').value;
                        const parentAddress = document.getElementById('primary-parent-address').value;
                        const year = new Date().getFullYear();

                        // Validation basique
                        if (!studentName || !birthdate || !studentClass || !parentName || !parentPhone) {
                            showAlert("Veuillez remplir tous les champs obligatoires", "error");
                            return;
                        }

                        const submitBtn = document.getElementById('primary-student-submit-btn');
                        const originalText = submitBtn.textContent;
                        
                        try {
                            // Afficher le chargement
                            submitBtn.textContent = 'Inscription en cours...';
                            submitBtn.disabled = true;

                            console.log("Début de l'inscription pour élève primaire:", studentName);

                            // Générer matricule
                            const q = query(collection(db, 'primary_students'), where('year', '==', year));
                            const countSnap = await getDocs(q);
                            const matricule = `PRI${year}${(countSnap.size + 1).toString().padStart(3, '0')}`;

                            console.log("Matricule primaire généré:", matricule);

                            // Uploader la photo vers Cloudinary si elle existe (en parallèle)
                            let photoURL = null;
                            if (primaryStudentPhotoFile) {
                                try {
                                    photoURL = await uploadToCloudinary(primaryStudentPhotoFile, `primary_students/${matricule}`);
                                    console.log("✅ Photo élève primaire uploadée:", photoURL);
                                } catch (uploadError) {
                                    console.error("❌ Erreur photo élève primaire:", uploadError);
                                    // Continuer sans photo si l'upload échoue
                                }
                            }

                            // Créer l'élève dans Firestore
                            const studentData = {
                                matricule,
                                fullName: studentName,
                                birthdate,
                                birthplace,
                                gender,
                                address,
                                class: studentClass,
                                enrollmentFees,
                                parentName,
                                parentPhone,
                                parentAddress,
                                photoURL,
                                studentType: 'primary',
                                status: 'active',
                                year,
                                createdAt: serverTimestamp(),
                                updatedAt: serverTimestamp()
                            };

                            console.log("Données élève primaire préparées:", studentData);

                            // Utiliser setDoc avec l'ID comme matricule pour éviter les doublons
                            const studentRef = doc(db, 'primary_students', matricule);
                            await setDoc(studentRef, studentData);
                            console.log("Élève primaire sauvegardé dans Firestore");

                            // Sauvegarder le dernier élève inscrit pour l'impression
                            lastEnrolledStudent = { ...studentData, id: matricule };
                            
                            // Enregistrer les frais d'inscription comme un paiement
                            if (enrollmentFees > 0) {
                                const paymentData = {
                                    studentId: matricule,
                                    studentName: studentName,
                                    studentClass: studentClass,
                                    studentType: 'primary',
                                    month: 'inscription',
                                    paymentType: 'Frais d\'inscription',
                                    amount: enrollmentFees,
                                    validatedBy: currentSecretary.uid,
                                    validatedAt: serverTimestamp(),
                                    createdAt: serverTimestamp(),
                                    paymentMethod: 'onsite',
                                    description: 'Frais d\'inscription pour l\'année scolaire'
                                };
                                
                                const paymentRef = doc(collection(db, 'payments'));
                                await setDoc(paymentRef, paymentData);
                            }

                            showAlert(`Élève primaire ${studentName} inscrit avec succès! Matricule: ${matricule}`, 'success');
                            form.reset();
                            primaryStudentPhotoFile = null;
                            document.getElementById('primary-student-photo-preview').innerHTML = '<i class="fas fa-camera"></i>';
                            
                            // Afficher le bouton d'impression du bordereau
                            document.getElementById('print-primary-student-btn').style.display = 'inline-block';
                            
                            // Mettre à jour les statistiques et listes
                            loadDashboardStats();
                            loadStudentsList();

                        } catch (error) {
                            console.error('Erreur complète inscription élève primaire:', error);
                            if (!isOnline) {
                                // Sauvegarder localement
                                addToOfflineQueue('addPrimaryStudent', { studentData: studentData });
                                showAlert(`Élève primaire sauvegardé localement (hors ligne). Matricule: ${matricule}`, 'warning');
                                form.reset();
                                primaryStudentPhotoFile = null;
                                document.getElementById('primary-student-photo-preview').innerHTML = '<i class="fas fa-camera"></i>';
                            } else {
                                showAlert(`Erreur lors de l'inscription: ${error.message}`, 'error');
                            }
                        } finally {
                            // Réactiver le bouton
                            submitBtn.textContent = originalText;
                            submitBtn.disabled = false;
                        }
                    });

                    // --- Inscription Élève Maternelle ---
                    document.getElementById('kindergarten-student-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const form = e.target;
                        const studentName = document.getElementById('kindergarten-student-name').value;
                        const birthdate = document.getElementById('kindergarten-student-birthdate').value;
                        const birthplace = document.getElementById('kindergarten-student-birthplace').value;
                        const gender = document.getElementById('kindergarten-student-gender').value;
                        const address = document.getElementById('kindergarten-student-address').value;
                        const studentClass = document.getElementById('kindergarten-student-class').value;
                        const enrollmentFees = parseFloat(document.getElementById('kindergarten-student-fees').value) || 0;
                        const parentName = document.getElementById('kindergarten-parent-name').value;
                        const parentPhone = document.getElementById('kindergarten-parent-phone').value;
                        const parentAddress = document.getElementById('kindergarten-parent-address').value;
                        const year = new Date().getFullYear();

                        // Validation basique
                        if (!studentName || !birthdate || !studentClass || !parentName || !parentPhone) {
                            showAlert("Veuillez remplir tous les champs obligatoires", "error");
                            return;
                        }

                        const submitBtn = document.getElementById('kindergarten-student-submit-btn');
                        const originalText = submitBtn.textContent;
                        
                        try {
                            // Afficher le chargement
                            submitBtn.textContent = 'Inscription en cours...';
                            submitBtn.disabled = true;

                            console.log("Début de l'inscription pour élève maternelle:", studentName);

                            // Générer matricule
                            const q = query(collection(db, 'kindergarten_students'), where('year', '==', year));
                            const countSnap = await getDocs(q);
                            const matricule = `MAT${year}${(countSnap.size + 1).toString().padStart(3, '0')}`;

                            console.log("Matricule maternelle généré:", matricule);

                            // Uploader la photo vers Cloudinary si elle existe (en parallèle)
                            let photoURL = null;
                            if (kindergartenStudentPhotoFile) {
                                try {
                                    photoURL = await uploadToCloudinary(kindergartenStudentPhotoFile, `kindergarten_students/${matricule}`);
                                    console.log("✅ Photo élève maternelle uploadée:", photoURL);
                                } catch (uploadError) {
                                    console.error("❌ Erreur photo élève maternelle:", uploadError);
                                    // Continuer sans photo si l'upload échoue
                                }
                            }

                            // Créer l'élève dans Firestore
                            const studentData = {
                                matricule,
                                fullName: studentName,
                                birthdate,
                                birthplace,
                                gender,
                                address,
                                class: studentClass,
                                enrollmentFees,
                                parentName,
                                parentPhone,
                                parentAddress,
                                photoURL,
                                studentType: 'kindergarten',
                                status: 'active',
                                year,
                                createdAt: serverTimestamp(),
                                updatedAt: serverTimestamp()
                            };

                            console.log("Données élève maternelle préparées:", studentData);

                            // Utiliser setDoc avec l'ID comme matricule
                            const studentRef = doc(db, 'kindergarten_students', matricule);
                            await setDoc(studentRef, studentData);
                            console.log("Élève maternelle sauvegardé dans Firestore");

                            // Sauvegarder le dernier élève inscrit pour l'impression
                            lastEnrolledStudent = { ...studentData, id: matricule };
                            
                            // Enregistrer les frais d'inscription comme un paiement
                            if (enrollmentFees > 0) {
                                const paymentData = {
                                    studentId: matricule,
                                    studentName: studentName,
                                    studentClass: studentClass,
                                    studentType: 'kindergarten',
                                    month: 'inscription',
                                    paymentType: 'Frais d\'inscription',
                                    amount: enrollmentFees,
                                    validatedBy: currentSecretary.uid,
                                    validatedAt: serverTimestamp(),
                                    createdAt: serverTimestamp(),
                                    paymentMethod: 'onsite',
                                    description: 'Frais d\'inscription pour l\'année scolaire'
                                };
                                
                                const paymentRef = doc(collection(db, 'payments'));
                                await setDoc(paymentRef, paymentData);
                            }

                            showAlert(`Élève maternelle ${studentName} inscrit avec succès! Matricule: ${matricule}`, 'success');
                            form.reset();
                            kindergartenStudentPhotoFile = null;
                            document.getElementById('kindergarten-student-photo-preview').innerHTML = '<i class="fas fa-camera"></i>';
                            
                            // Afficher le bouton d'impression du bordereau
                            document.getElementById('print-kindergarten-student-btn').style.display = 'inline-block';
                            
                            // Mettre à jour les statistiques et listes
                            loadDashboardStats();
                            loadStudentsList();

                        } catch (error) {
                            console.error('Erreur complète inscription élève maternelle:', error);
                            if (!isOnline) {
                                // Sauvegarder localement
                                addToOfflineQueue('addKindergartenStudent', { studentData: studentData });
                                showAlert(`Élève maternelle sauvegardé localement (hors ligne). Matricule: ${matricule}`, 'warning');
                                form.reset();
                                kindergartenStudentPhotoFile = null;
                                document.getElementById('kindergarten-student-photo-preview').innerHTML = '<i class="fas fa-camera"></i>';
                            } else {
                                showAlert(`Erreur lors de l'inscription: ${error.message}`, 'error');
                            }
                        } finally {
                            // Réactiver le bouton
                            submitBtn.textContent = originalText;
                            submitBtn.disabled = false;
                        }
                    });

                    // --- Inscription Enseignant Secondaire (optimisée) ---
                    async function loadTeacherClasses() {
                        const container = document.getElementById('teacher-classes-container');
                        container.innerHTML = 'Chargement...';
                        
                        try {
                            const classesSnap = await getDocs(collection(db, 'classes'));
                            let html = '';
                            classesSnap.forEach(doc => {
                                const data = doc.data();
                                html += `
                                    <div class="class-checkbox">
                                        <input type="checkbox" id="class-${doc.id}" value="${data.name}">
                                        <label for="class-${doc.id}">${data.name}</label>
                                    </div>
                                `;
                            });
                            container.innerHTML = html || '<p>Aucune classe disponible</p>';
                        } catch (error) {
                            console.error("Erreur chargement classes:", error);
                            container.innerHTML = 'Erreur de chargement';
                        }
                    }

                    document.getElementById('teacher-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const teacherName = document.getElementById('teacher-name').value;
                        const birthdate = document.getElementById('teacher-birthdate').value;
                        const birthplace = document.getElementById('teacher-birthplace').value;
                        const gender = document.getElementById('teacher-gender').value;
                        const address = document.getElementById('teacher-address').value;
                        const phone = document.getElementById('teacher-phone').value;
                        const teacherSubjects = document.getElementById('teacher-subjects').value.split(',').map(s => s.trim());
                        
                        // Récupérer les classes sélectionnées
                        const selectedClasses = [];
                        document.querySelectorAll('#teacher-classes-container input[type="checkbox"]:checked').forEach(checkbox => {
                            selectedClasses.push(checkbox.value);
                        });

                        const submitBtn = document.getElementById('teacher-submit-btn');
                        const originalText = submitBtn.textContent;

                        try {
                            // Afficher le chargement
                            submitBtn.textContent = 'Inscription en cours...';
                            submitBtn.disabled = true;

                            // Générer matricule enseignant
                            const teacherSnap = await getDocs(collection(db, 'teachers'));
                            const teacherCount = teacherSnap.size + 1;
                            const teacherMatricule = `ENS${teacherCount.toString().padStart(3, '0')}`;

                            // Uploader la photo vers Cloudinary si elle existe (en parallèle)
                            let photoURL = null;
                            if (teacherPhotoFile) {
                                try {
                                    photoURL = await uploadToCloudinary(teacherPhotoFile, `teachers/${teacherMatricule}`);
                                    console.log("✅ Photo enseignant uploadée:", photoURL);
                                } catch (uploadError) {
                                    console.error("❌ Erreur upload photo enseignant:", uploadError);
                                    // Continuer sans photo
                                }
                            }

                            // Créer l'enseignant dans Firestore
                            const teacherData = {
                                matricule: teacherMatricule,
                                fullName: teacherName,
                                birthdate,
                                birthplace,
                                gender,
                                address,
                                phone,
                                subjects: teacherSubjects,
                                classes: selectedClasses,
                                teacherType: 'secondary',
                                photoURL,
                                status: 'active',
                                createdAt: serverTimestamp(),
                                updatedAt: serverTimestamp()
                            };

                            // Utiliser setDoc avec l'ID comme matricule
                            const teacherRef = doc(db, 'teachers', teacherMatricule);
                            await setDoc(teacherRef, teacherData);

                            showAlert(`Enseignant secondaire ${teacherName} inscrit avec succès! Matricule: ${teacherMatricule}`, 'success');
                            document.getElementById('teacher-form').reset();
                            teacherPhotoFile = null;
                            document.getElementById('teacher-photo-preview').innerHTML = '<i class="fas fa-camera"></i>';
                            
                            // Mettre à jour les statistiques et listes
                            loadDashboardStats();
                            loadTeachersList();
                        } catch (error) {
                            console.error('Erreur inscription enseignant:', error);
                            if (!isOnline) {
                                // Sauvegarder localement
                                addToOfflineQueue('addTeacher', { teacherData: teacherData });
                                showAlert(`Enseignant sauvegardé localement (hors ligne). Matricule: ${teacherMatricule}`, 'warning');
                                document.getElementById('teacher-form').reset();
                                teacherPhotoFile = null;
                                document.getElementById('teacher-photo-preview').innerHTML = '<i class="fas fa-camera"></i>';
                            } else {
                                showAlert(`Erreur lors de l'inscription: ${error.message}`, 'error');
                            }
                        } finally {
                            submitBtn.textContent = originalText;
                            submitBtn.disabled = false;
                        }
                    });

                    // --- Inscription Enseignant Primaire ---
                    async function loadPrimaryTeacherClasses() {
                        const container = document.getElementById('primary-teacher-classes-container');
                        container.innerHTML = 'Chargement...';
                        
                        try {
                            const classesSnap = await getDocs(collection(db, 'primary_classes'));
                            let html = '';
                            classesSnap.forEach(doc => {
                                const data = doc.data();
                                html += `
                                    <div class="class-checkbox">
                                        <input type="checkbox" id="primary-class-${doc.id}" value="${data.name}">
                                        <label for="primary-class-${doc.id}">${data.name}</label>
                                    </div>
                                `;
                            });
                            container.innerHTML = html || '<p>Aucune classe primaire disponible</p>';
                        } catch (error) {
                            console.error("Erreur chargement classes primaires:", error);
                            container.innerHTML = 'Erreur de chargement';
                        }
                    }

                    document.getElementById('primary-teacher-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const teacherName = document.getElementById('primary-teacher-name').value;
                        const birthdate = document.getElementById('primary-teacher-birthdate').value;
                        const birthplace = document.getElementById('primary-teacher-birthplace').value;
                        const gender = document.getElementById('primary-teacher-gender').value;
                        const address = document.getElementById('primary-teacher-address').value;
                        const phone = document.getElementById('primary-teacher-phone').value;
                        
                        // Récupérer les classes sélectionnées
                        const selectedClasses = [];
                        document.querySelectorAll('#primary-teacher-classes-container input[type="checkbox"]:checked').forEach(checkbox => {
                            selectedClasses.push(checkbox.value);
                        });

                        const submitBtn = document.getElementById('primary-teacher-submit-btn');
                        const originalText = submitBtn.textContent;

                        try {
                            // Afficher le chargement
                            submitBtn.textContent = 'Inscription en cours...';
                            submitBtn.disabled = true;

                            // Générer matricule enseignant primaire
                            const teacherSnap = await getDocs(collection(db, 'primary_teachers'));
                            const teacherCount = teacherSnap.size + 1;
                            const teacherMatricule = `ENP${teacherCount.toString().padStart(3, '0')}`;

                            // Uploader la photo vers Cloudinary si elle existe (en parallèle)
                            let photoURL = null;
                            if (primaryTeacherPhotoFile) {
                                try {
                                    photoURL = await uploadToCloudinary(primaryTeacherPhotoFile, `primary_teachers/${teacherMatricule}`);
                                    console.log("✅ Photo enseignant primaire uploadée:", photoURL);
                                } catch (uploadError) {
                                    console.error("❌ Erreur upload photo enseignant primaire:", uploadError);
                                    // Continuer sans photo
                                }
                            }

                            // Créer l'enseignant dans Firestore
                            const teacherData = {
                                matricule: teacherMatricule,
                                fullName: teacherName,
                                birthdate,
                                birthplace,
                                gender,
                                address,
                                phone,
                                classes: selectedClasses,
                                teacherType: 'primary',
                                photoURL,
                                status: 'active',
                                createdAt: serverTimestamp(),
                                updatedAt: serverTimestamp()
                            };

                            // Utiliser setDoc avec l'ID comme matricule
                            const teacherRef = doc(db, 'primary_teachers', teacherMatricule);
                            await setDoc(teacherRef, teacherData);

                            showAlert(`Enseignant primaire ${teacherName} inscrit avec succès! Matricule: ${teacherMatricule}`, 'success');
                            document.getElementById('primary-teacher-form').reset();
                            primaryTeacherPhotoFile = null;
                            document.getElementById('primary-teacher-photo-preview').innerHTML = '<i class="fas fa-camera"></i>';
                            
                            // Mettre à jour les statistiques et listes
                            loadDashboardStats();
                            loadTeachersList();
                        } catch (error) {
                            console.error('Erreur inscription enseignant primaire:', error);
                            if (!isOnline) {
                                // Sauvegarder localement
                                addToOfflineQueue('addPrimaryTeacher', { teacherData: teacherData });
                                showAlert(`Enseignant primaire sauvegardé localement (hors ligne). Matricule: ${teacherMatricule}`, 'warning');
                                document.getElementById('primary-teacher-form').reset();
                                primaryTeacherPhotoFile = null;
                                document.getElementById('primary-teacher-photo-preview').innerHTML = '<i class="fas fa-camera"></i>';
                            } else {
                                showAlert(`Erreur lors de l'inscription: ${error.message}`, 'error');
                            }
                        } finally {
                            submitBtn.textContent = originalText;
                            submitBtn.disabled = false;
                        }
                    });

                    // --- Inscription Enseignant Maternelle ---
                    async function loadKindergartenTeacherClasses() {
                        const container = document.getElementById('kindergarten-teacher-classes-container');
                        container.innerHTML = 'Chargement...';
                        
                        try {
                            const classesSnap = await getDocs(collection(db, 'kindergarten_classes'));
                            let html = '';
                            classesSnap.forEach(doc => {
                                const data = doc.data();
                                html += `
                                    <div class="class-checkbox">
                                        <input type="checkbox" id="kindergarten-class-${doc.id}" value="${data.name}">
                                        <label for="kindergarten-class-${doc.id}">${data.name}</label>
                                    </div>
                                `;
                            });
                            container.innerHTML = html || '<p>Aucune classe maternelle disponible</p>';
                        } catch (error) {
                            console.error("Erreur chargement classes maternelles:", error);
                            container.innerHTML = 'Erreur de chargement';
                        }
                    }

                    document.getElementById('kindergarten-teacher-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const teacherName = document.getElementById('kindergarten-teacher-name').value;
                        const birthdate = document.getElementById('kindergarten-teacher-birthdate').value;
                        const birthplace = document.getElementById('kindergarten-teacher-birthplace').value;
                        const gender = document.getElementById('kindergarten-teacher-gender').value;
                        const address = document.getElementById('kindergarten-teacher-address').value;
                        const phone = document.getElementById('kindergarten-teacher-phone').value;
                        
                        // Récupérer les classes sélectionnées
                        const selectedClasses = [];
                        document.querySelectorAll('#kindergarten-teacher-classes-container input[type="checkbox"]:checked').forEach(checkbox => {
                            selectedClasses.push(checkbox.value);
                        });

                        const submitBtn = document.getElementById('kindergarten-teacher-submit-btn');
                        const originalText = submitBtn.textContent;

                        try {
                            // Afficher le chargement
                            submitBtn.textContent = 'Inscription en cours...';
                            submitBtn.disabled = true;

                            // Générer matricule enseignant maternelle
                            const teacherSnap = await getDocs(collection(db, 'kindergarten_teachers'));
                            const teacherCount = teacherSnap.size + 1;
                            const teacherMatricule = `ENM${teacherCount.toString().padStart(3, '0')}`;

                            // Uploader la photo vers Cloudinary si elle existe (en parallèle)
                            let photoURL = null;
                            if (kindergartenTeacherPhotoFile) {
                                try {
                                    photoURL = await uploadToCloudinary(kindergartenTeacherPhotoFile, `kindergarten_teachers/${teacherMatricule}`);
                                    console.log("✅ Photo enseignant maternelle uploadée:", photoURL);
                                } catch (uploadError) {
                                    console.error("❌ Erreur upload photo enseignant maternelle:", uploadError);
                                    // Continuer sans photo
                                }
                            }

                            // Créer l'enseignant dans Firestore
                            const teacherData = {
                                matricule: teacherMatricule,
                                fullName: teacherName,
                                birthdate,
                                birthplace,
                                gender,
                                address,
                                phone,
                                classes: selectedClasses,
                                teacherType: 'kindergarten',
                                photoURL,
                                status: 'active',
                                createdAt: serverTimestamp(),
                                updatedAt: serverTimestamp()
                            };

                            // Utiliser setDoc avec l'ID comme matricule
                            const teacherRef = doc(db, 'kindergarten_teachers', teacherMatricule);
                            await setDoc(teacherRef, teacherData);

                            showAlert(`Enseignant maternelle ${teacherName} inscrit avec succès! Matricule: ${teacherMatricule}`, 'success');
                            document.getElementById('kindergarten-teacher-form').reset();
                            kindergartenTeacherPhotoFile = null;
                            document.getElementById('kindergarten-teacher-photo-preview').innerHTML = '<i class="fas fa-camera"></i>';
                            
                            // Mettre à jour les statistiques et listes
                            loadDashboardStats();
                            loadTeachersList();
                        } catch (error) {
                            console.error('Erreur inscription enseignant maternelle:', error);
                            if (!isOnline) {
                                // Sauvegarder localement
                                addToOfflineQueue('addKindergartenTeacher', { teacherData: teacherData });
                                showAlert(`Enseignant maternelle sauvegardé localement (hors ligne). Matricule: ${teacherMatricule}`, 'warning');
                                document.getElementById('kindergarten-teacher-form').reset();
                                kindergartenTeacherPhotoFile = null;
                                document.getElementById('kindergarten-teacher-photo-preview').innerHTML = '<i class="fas fa-camera"></i>';
                            } else {
                                showAlert(`Erreur lors de l'inscription: ${error.message}`, 'error');
                            }
                        } finally {
                            submitBtn.textContent = originalText;
                            submitBtn.disabled = false;
                        }
                    });

                    // --- Gestion des Classes Secondaires ---
                    async function loadClassesIntoSelects() {
                        const classSelect = document.getElementById('student-class');
                        const primaryClassSelect = document.getElementById('primary-student-class');
                        const kindergartenClassSelect = document.getElementById('kindergarten-student-class');
                        const filterClassSelect = document.getElementById('filter-class');
                        const feesClassSelect = document.getElementById('fees-class');
                        const editClassSelect = document.getElementById('edit-student-class');
                        const enrollmentClassSelect = document.getElementById('enrollment-class');
                        
                        classSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
                        primaryClassSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
                        kindergartenClassSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
                        filterClassSelect.innerHTML = '<option value="">Toutes les classes</option>';
                        feesClassSelect.innerHTML = '<option value="">Toutes les classes</option>';
                        editClassSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
                        enrollmentClassSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
                        
                        try {
                            // Classes secondaires
                            const classesSnap = await getDocs(collection(db, 'classes'));
                            classesSnap.forEach(doc => {
                                const data = doc.data();
                                classSelect.innerHTML += `<option value="${data.name}">${data.name}</option>`;
                                filterClassSelect.innerHTML += `<option value="${data.name}">${data.name}</option>`;
                                feesClassSelect.innerHTML += `<option value="${data.name}">${data.name}</option>`;
                                editClassSelect.innerHTML += `<option value="${data.name}">${data.name}</option>`;
                                enrollmentClassSelect.innerHTML += `<option value="${data.name}">${data.name}</option>`;
                            });
                            
                            // Classes primaires
                            const primaryClassesSnap = await getDocs(collection(db, 'primary_classes'));
                            primaryClassesSnap.forEach(doc => {
                                const data = doc.data();
                                primaryClassSelect.innerHTML += `<option value="${data.name}">${data.name}</option>`;
                                filterClassSelect.innerHTML += `<option value="${data.name}">${data.name}</option>`;
                                feesClassSelect.innerHTML += `<option value="${data.name}">${data.name}</option>`;
                            });
                            
                            // Classes maternelles
                            const kindergartenClassesSnap = await getDocs(collection(db, 'kindergarten_classes'));
                            kindergartenClassesSnap.forEach(doc => {
                                const data = doc.data();
                                kindergartenClassSelect.innerHTML += `<option value="${data.name}">${data.name}</option>`;
                                filterClassSelect.innerHTML += `<option value="${data.name}">${data.name}</option>`;
                                feesClassSelect.innerHTML += `<option value="${data.name}">${data.name}</option>`;
                            });
                        } catch (error) {
                            console.error('Erreur chargement classes:', error);
                        }
                    }
                    
                    // Fonction pour charger la liste des classes secondaires
                    async function loadClassesList() {
                        const listEl = document.getElementById('classes-list');
                        listEl.innerHTML = "<tr><td colspan='5' style='text-align: center;'>Chargement...</td></tr>";
                        
                        try {
                            const classesSnap = await getDocs(collection(db, 'classes'));
                            
                            console.log("Nombre de classes secondaires trouvées:", classesSnap.size);
                            
                            if (classesSnap.empty) {
                                listEl.innerHTML = '<tr><td colspan="5" style="text-align: center;">Aucune classe créée.</td></tr>';
                                return;
                            }
                            
                            let html = '';
                            
                            for (const classDoc of classesSnap.docs) {
                                const data = classDoc.data();
                                console.log(`Classe ${classDoc.id}:`, data);
                                
                                let studentCount = 0;
                                try {
                                    // Récupérer tous les étudiants et filtrer manuellement
                                    const allStudentsSnap = await getDocs(query(collection(db, 'students'), where('status', '!=', 'deleted')));
                                    allStudentsSnap.forEach(studentDoc => {
                                        const studentData = studentDoc.data();
                                        if (studentData.class && studentData.class === data.name) {
                                            studentCount++;
                                        }
                                    });
                                } catch (error) {
                                    console.error("Erreur comptage étudiants:", error);
                                }
                                
                                html += `
                                    <tr>
                                        <td>${data.name || 'Non défini'}</td>
                                        <td>${data.level || 'Non défini'}</td>
                                        <td>${data.capacity || 'Non défini'}</td>
                                        <td>${studentCount}</td>
                                        <td class="action-buttons">
                                            <button class="btn btn-warning" onclick="editClass('${classDoc.id}', 'secondary')">Modifier</button>
                                            <button class="btn btn-danger" onclick="deleteClass('${classDoc.id}', 'secondary')">Supprimer</button>
                                        </td>
                                    </tr>
                                `;
                            }
                            
                            listEl.innerHTML = html;
                            
                        } catch (error) {
                            console.error("Erreur chargement classes secondaires:", error);
                            listEl.innerHTML = '<tr><td colspan="5" style="text-align: center;">Erreur de chargement: ' + error.message + '</td></tr>';
                        }
                    }
                    
                    // Fonction pour charger la liste des classes primaires
                    async function loadPrimaryClassesList() {
                        const listEl = document.getElementById('primary-classes-list');
                        listEl.innerHTML = "<tr><td colspan='5' style='text-align: center;'>Chargement...</td></tr>";
                        
                        try {
                            const classesSnap = await getDocs(collection(db, 'primary_classes'));
                            
                            console.log("Nombre de classes primaires trouvées:", classesSnap.size);
                            
                            if (classesSnap.empty) {
                                listEl.innerHTML = '<tr><td colspan="5" style="text-align: center;">Aucune classe primaire créée.</td></tr>';
                                return;
                            }
                            
                            let html = '';
                            
                            for (const classDoc of classesSnap.docs) {
                                const data = classDoc.data();
                                console.log(`Classe primaire ${classDoc.id}:`, data);
                                
                                let studentCount = 0;
                                try {
                                    // Récupérer tous les étudiants primaires et filtrer manuellement
                                    const allStudentsSnap = await getDocs(query(collection(db, 'primary_students'), where('status', '!=', 'deleted')));
                                    allStudentsSnap.forEach(studentDoc => {
                                        const studentData = studentDoc.data();
                                        if (studentData.class && studentData.class === data.name) {
                                            studentCount++;
                                        }
                                    });
                                } catch (error) {
                                    console.error("Erreur comptage étudiants primaires:", error);
                                }
                                
                                html += `
                                    <tr>
                                        <td>${data.name || 'Non défini'}</td>
                                        <td>${data.level || 'Non défini'}</td>
                                        <td>${data.capacity || 'Non défini'}</td>
                                        <td>${studentCount}</td>
                                        <td class="action-buttons">
                                            <button class="btn btn-warning" onclick="editClass('${classDoc.id}', 'primary')">Modifier</button>
                                            <button class="btn btn-danger" onclick="deleteClass('${classDoc.id}', 'primary')">Supprimer</button>
                                        </td>
                                    </tr>
                                `;
                            }
                            
                            listEl.innerHTML = html;
                            
                        } catch (error) {
                            console.error("Erreur chargement classes primaires:", error);
                            listEl.innerHTML = '<tr><td colspan="5" style="text-align: center;">Erreur de chargement: ' + error.message + '</td></tr>';
                        }
                    }
                    
                    // Fonction pour charger la liste des classes maternelles
                    async function loadKindergartenClassesList() {
                        const listEl = document.getElementById('kindergarten-classes-list');
                        listEl.innerHTML = "<tr><td colspan='5' style='text-align: center;'>Chargement...</td></tr>";
                        
                        try {
                            const classesSnap = await getDocs(collection(db, 'kindergarten_classes'));
                            
                            console.log("Nombre de classes maternelles trouvées:", classesSnap.size);
                            
                            if (classesSnap.empty) {
                                listEl.innerHTML = '<tr><td colspan="5" style="text-align: center;">Aucune classe maternelle créée.</td></tr>';
                                return;
                            }
                            
                            let html = '';
                            
                            for (const classDoc of classesSnap.docs) {
                                const data = classDoc.data();
                                console.log(`Classe maternelle ${classDoc.id}:`, data);
                                
                                let studentCount = 0;
                                try {
                                    // Récupérer tous les étudiants maternelles et filtrer manuellement
                                    const allStudentsSnap = await getDocs(query(collection(db, 'kindergarten_students'), where('status', '!=', 'deleted')));
                                    allStudentsSnap.forEach(studentDoc => {
                                        const studentData = studentDoc.data();
                                        if (studentData.class && studentData.class === data.name) {
                                            studentCount++;
                                        }
                                    });
                                } catch (error) {
                                    console.error("Erreur comptage étudiants maternelles:", error);
                                }
                                
                                html += `
                                    <tr>
                                        <td>${data.name || 'Non défini'}</td>
                                        <td>${data.level || 'Non défini'}</td>
                                        <td>${data.capacity || 'Non défini'}</td>
                                        <td>${studentCount}</td>
                                        <td class="action-buttons">
                                            <button class="btn btn-warning" onclick="editClass('${classDoc.id}', 'kindergarten')">Modifier</button>
                                            <button class="btn btn-danger" onclick="deleteClass('${classDoc.id}', 'kindergarten')">Supprimer</button>
                                        </td>
                                    </tr>
                                `;
                            }
                            
                            listEl.innerHTML = html;
                            
                        } catch (error) {
                            console.error("Erreur chargement classes maternelles:", error);
                            listEl.innerHTML = '<tr><td colspan="5" style="text-align: center;">Erreur de chargement: ' + error.message + '</td></tr>';
                        }
                    }
                    
                    document.getElementById('class-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const name = document.getElementById('class-name').value;
                        const level = document.getElementById('class-level').value;
                        const capacity = document.getElementById('class-capacity').value;
                        
                        if (!name || !level || !capacity) {
                            showAlert("Veuillez remplir tous les champs pour la classe.", "error");
                            return;
                        }
                        
                        try {
                            await addDoc(collection(db, 'classes'), { 
                                name, 
                                level, 
                                capacity: parseInt(capacity),
                                createdAt: serverTimestamp()
                            });
                            
                            showAlert('Classe secondaire ajoutée avec succès !', 'success');
                            document.getElementById('class-form').reset();
                            
                            loadClassesIntoSelects();
                            loadClassesList();
                            loadTeacherClasses();
                            
                        } catch (error) {
                            console.error("Erreur ajout classe secondaire:", error);
                            showAlert('Erreur lors de l\'ajout: ' + error.message, 'error');
                        }
                    });

                    document.getElementById('primary-class-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const name = document.getElementById('primary-class-name').value;
                        const level = document.getElementById('primary-class-level').value;
                        const capacity = document.getElementById('primary-class-capacity').value;
                        
                        if (!name || !level || !capacity) {
                            showAlert("Veuillez remplir tous les champs pour la classe primaire.", "error");
                            return;
                        }
                        
                        try {
                            await addDoc(collection(db, 'primary_classes'), { 
                                name, 
                                level, 
                                capacity: parseInt(capacity),
                                createdAt: serverTimestamp()
                            });
                            
                            showAlert('Classe primaire ajoutée avec succès !', 'success');
                            document.getElementById('primary-class-form').reset();
                            
                            loadClassesIntoSelects();
                            loadPrimaryClassesList();
                            loadPrimaryTeacherClasses();
                            
                        } catch (error) {
                            console.error("Erreur ajout classe primaire:", error);
                            showAlert('Erreur lors de l\'ajout: ' + error.message, 'error');
                        }
                    });

                    document.getElementById('kindergarten-class-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const name = document.getElementById('kindergarten-class-name').value;
                        const level = document.getElementById('kindergarten-class-level').value;
                        const capacity = document.getElementById('kindergarten-class-capacity').value;
                        
                        if (!name || !level || !capacity) {
                            showAlert("Veuillez remplir tous les champs pour la classe maternelle.", "error");
                            return;
                        }
                        
                        try {
                            await addDoc(collection(db, 'kindergarten_classes'), { 
                                name, 
                                level, 
                                capacity: parseInt(capacity),
                                createdAt: serverTimestamp()
                            });
                            
                            showAlert('Classe maternelle ajoutée avec succès !', 'success');
                            document.getElementById('kindergarten-class-form').reset();
                            
                            loadClassesIntoSelects();
                            loadKindergartenClassesList();
                            loadKindergartenTeacherClasses();
                            
                        } catch (error) {
                            console.error("Erreur ajout classe maternelle:", error);
                            showAlert('Erreur lors de l\'ajout: ' + error.message, 'error');
                        }
                    });

                    // --- Validation Paiement ---
                    let foundRequest = null;
                    
                    document.getElementById('find-payment-btn').addEventListener('click', async () => {
                        const code = document.getElementById('payment-code-input').value;
                        if (!code) {
                            showAlert("Veuillez entrer un code de paiement", "error");
                            return;
                        }
                        
                        try {
                            const q = query(collection(db, 'payment_requests'), where('paymentCode', '==', code), where('status', '==', 'pending'));
                            const snap = await getDocs(q);

                            if (snap.empty) {
                                showAlert('Aucune demande de paiement en attente trouvée pour ce code.', 'error');
                                document.getElementById('payment-details-card').classList.add('hidden');
                                return;
                            }
                            
                            foundRequest = snap.docs[0];
                            const data = foundRequest.data();
                            document.getElementById('payment-student-name').textContent = data.studentName;
                            document.getElementById('payment-months').textContent = data.months.join(', ');
                            document.getElementById('payment-type').textContent = data.paymentType || 'Frais scolaires';
                            document.getElementById('payment-amount').textContent = `$${data.amount.toFixed(2)}`;
                            document.getElementById('payment-details-card').classList.remove('hidden');
                        } catch (error) {
                            showAlert('Erreur de recherche: ' + error.message, 'error');
                        }
                    });

                    document.getElementById('confirm-payment-btn').addEventListener('click', async () => {
                        if (!foundRequest) return;
                        
                        try {
                            const batch = writeBatch(db);
                            batch.update(doc(db, 'payment_requests', foundRequest.id), { 
                                status: 'paid',
                                validatedAt: serverTimestamp(),
                                validatedBy: currentSecretary.uid
                            });

                            const data = foundRequest.data();
                            data.months.forEach(month => {
                                const paymentDocRef = doc(collection(db, 'payments'));
                                batch.set(paymentDocRef, {
                                    studentId: data.studentId,
                                    studentName: data.studentName,
                                    studentClass: data.studentClass,
                                    studentType: data.studentType || 'secondary',
                                    month: month,
                                    paymentType: data.paymentType || 'Frais scolaires',
                                    amount: data.amount / data.months.length,
                                    validatedBy: currentSecretary.uid,
                                    validatedAt: serverTimestamp(),
                                    createdAt: serverTimestamp(),
                                    paymentMethod: 'online'
                                });
                            });

                            await batch.commit();
                            
                            // Générer le reçu
                            await generateReceipt(data.studentName, data.months, data.amount, data.paymentCode, data.studentClass, data.paymentType);
                            
                            showAlert('Paiement validé avec succès !', 'success');
                            document.getElementById('payment-details-card').classList.add('hidden');
                            document.getElementById('payment-code-input').value = '';
                            foundRequest = null;
                            
                            // Mettre à jour les listes
                            loadPendingPaymentsList();
                            loadDashboardStats();
                        } catch (error) {
                            showAlert('Erreur de validation: ' + error.message, 'error');
                        }
                    });

                    async function loadPendingPaymentsList() {
                        const listEl = document.getElementById('pending-payments-list');
                        listEl.innerHTML = "Chargement...";
                        
                        try {
                            const pendingSnap = await getDocs(query(collection(db, 'payment_requests'), where('status', '==', 'pending')));
                            
                            if (pendingSnap.empty) {
                                listEl.innerHTML = '<tr><td colspan="6" style="text-align: center;">Aucun paiement en attente.</td></tr>';
                                return;
                            }
                            
                            let html = '';
                            pendingSnap.forEach(doc => {
                                const data = doc.data();
                                html += `
                                    <tr>
                                        <td>${data.paymentCode}</td>
                                        <td>${data.studentName}</td>
                                        <td>${data.months.join(', ')}</td>
                                        <td>${data.paymentType || 'Frais scolaires'}</td>
                                        <td class="currency-display">$${data.amount.toFixed(2)}</td>
                                        <td class="action-buttons">
                                            <button class="btn btn-success" onclick="validatePaymentByCode('${data.paymentCode}')">Valider</button>
                                        </td>
                                    </tr>
                                `;
                            });
                            
                            listEl.innerHTML = html;
                        } catch (error) {
                            console.error("Erreur chargement paiements:", error);
                            listEl.innerHTML = '<tr><td colspan="6" style="text-align: center;">Erreur de chargement</td></tr>';
                        }
                    }

                    // --- Paiements sur place ---
                    function setupPaymentForm() {
                        const studentIdInput = document.getElementById('onsite-student-id');
                        const studentTypeSelect = document.getElementById('onsite-student-type');
                        
                        studentIdInput.addEventListener('blur', async () => {
                            const matricule = studentIdInput.value.trim();
                            if (!matricule) return;
                            
                            try {
                                let studentDoc;
                                if (studentTypeSelect.value === 'secondary') {
                                    studentDoc = await getDoc(doc(db, 'students', matricule));
                                } else if (studentTypeSelect.value === 'primary') {
                                    studentDoc = await getDoc(doc(db, 'primary_students', matricule));
                                } else {
                                    studentDoc = await getDoc(doc(db, 'kindergarten_students', matricule));
                                }
                                
                                if (studentDoc.exists()) {
                                    const data = studentDoc.data();
                                    document.getElementById('onsite-student-name').value = data.fullName;
                                    document.getElementById('onsite-student-class').value = data.class;
                                    
                                    // Générer les checkboxes pour les mois
                                    generateMonthCheckboxes();
                                } else {
                                    document.getElementById('onsite-student-name').value = '';
                                    document.getElementById('onsite-student-class').value = '';
                                    document.getElementById('onsite-amount').value = '';
                                    showAlert("Aucun élève trouvé avec ce matricule", "error");
                                }
                            } catch (error) {
                                console.error("Erreur recherche élève:", error);
                            }
                        });
                        
                        // Gérer l'affichage du champ de spécification pour "Autres"
                        document.getElementById('onsite-payment-type').addEventListener('change', function() {
                            const otherSpec = document.getElementById('onsite-payment-other');
                            if (this.value === 'Autres') {
                                otherSpec.style.display = 'block';
                                otherSpec.required = true;
                            } else {
                                otherSpec.style.display = 'none';
                                otherSpec.required = false;
                                otherSpec.value = '';
                            }
                        });
                    }

                    function generateMonthCheckboxes() {
                        const container = document.getElementById('onsite-months-container');
                        const months = [
                            'janvier', 'février', 'mars', 'avril', 'mai', 'juin',
                            'juillet', 'août', 'septembre', 'octobre', 'novembre', 'décembre'
                        ];
                        
                        let html = '';
                        months.forEach(month => {
                            html += `
                                <div class="month-checkbox">
                                    <input type="checkbox" id="month-${month}" value="${month}" class="month-checkbox-input">
                                    <label for="month-${month}">${month}</label>
                                </div>
                            `;
                        });
                        
                        container.innerHTML = html;
                        
                        // Ajouter l'écouteur d'événements pour le calcul du montant total
                        document.querySelectorAll('.month-checkbox-input').forEach(checkbox => {
                            checkbox.addEventListener('change', updateTotalAmount);
                        });
                    }

                    function updateTotalAmount() {
                        const selectedMonths = document.querySelectorAll('.month-checkbox-input:checked');
                        const monthlyFees = parseFloat(document.getElementById('onsite-amount').value) || 0;
                        const totalAmount = selectedMonths.length * monthlyFees;
                        document.getElementById('onsite-amount').value = totalAmount.toFixed(2);
                    }

                    document.getElementById('onsite-payment-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const studentMatricule = document.getElementById('onsite-student-id').value;
                        const studentName = document.getElementById('onsite-student-name').value;
                        const studentClass = document.getElementById('onsite-student-class').value;
                        const studentType = document.getElementById('onsite-student-type').value;
                        const paymentType = document.getElementById('onsite-payment-type').value;
                        const paymentOther = document.getElementById('onsite-payment-other').value;
                        const amount = parseFloat(document.getElementById('onsite-amount').value);
                        
                        if (!studentMatricule || !studentName || !studentClass || !paymentType || !amount) {
                            showAlert("Veuillez remplir tous les champs", "error");
                            return;
                        }
                        
                        // Si le type est "Autres" mais pas de spécification
                        if (paymentType === 'Autres' && !paymentOther) {
                            showAlert("Veuillez spécifier le type de frais", "error");
                            return;
                        }
                        
                        // Récupérer les mois sélectionnés
                        const selectedMonths = [];
                        document.querySelectorAll('.month-checkbox-input:checked').forEach(checkbox => {
                            selectedMonths.push(checkbox.value);
                        });
                        
                        if (selectedMonths.length === 0) {
                            showAlert("Veuillez sélectionner au moins un mois", "error");
                            return;
                        }
                        
                        try {
                            // Vérifier si l'élève existe
                            let studentDoc;
                            if (studentType === 'secondary') {
                                studentDoc = await getDoc(doc(db, 'students', studentMatricule));
                            } else if (studentType === 'primary') {
                                studentDoc = await getDoc(doc(db, 'primary_students', studentMatricule));
                            } else {
                                studentDoc = await getDoc(doc(db, 'kindergarten_students', studentMatricule));
                            }
                            
                            if (!studentDoc.exists()) {
                                showAlert("Élève non trouvé", "error");
                                return;
                            }
                            
                            // Vérifier l'ordre des mois de paiement
                            const allMonths = ["janvier", "février", "mars", "avril", "mai", "juin", "juillet", "août", "septembre", "octobre", "novembre", "décembre"];
                            
                            // Récupérer les paiements de l'élève
                            const paymentsSnap = await getDocs(query(collection(db, 'payments'), where('studentId', '==', studentMatricule)));
                            const paidMonths = paymentsSnap.docs.map(doc => doc.data().month);
                            
                            // Vérifier si des mois sélectionnés sont déjà payés
                            const alreadyPaidMonths = selectedMonths.filter(month => paidMonths.includes(month));
                            if (alreadyPaidMonths.length > 0) {
                                showAlert(`L'élève a déjà payé le(s) mois suivant(s): ${alreadyPaidMonths.join(', ')}`, "error");
                                return;
                            }
                            
                            // Enregistrer les paiements
                            const monthlyAmount = amount / selectedMonths.length;
                            const batch = writeBatch(db);
                            
                            selectedMonths.forEach(month => {
                                const paymentDocRef = doc(collection(db, 'payments'));
                                batch.set(paymentDocRef, {
                                    studentId: studentMatricule,
                                    studentName: studentName,
                                    studentClass: studentClass,
                                    studentType: studentType,
                                    month: month,
                                    paymentType: paymentType === 'Autres' ? paymentOther : paymentType,
                                    amount: monthlyAmount,
                                    validatedBy: currentSecretary.uid,
                                    validatedAt: serverTimestamp(),
                                    createdAt: serverTimestamp(),
                                    paymentMethod: 'onsite'
                                });
                            });
                            
                            await batch.commit();
                            
                            // Générer le reçu
                            await generateReceipt(studentName, selectedMonths, amount, 'ONSITE-' + generatePaymentCode(), studentClass, paymentType === 'Autres' ? paymentOther : paymentType);
                            
                            showAlert('Paiement enregistré avec succès !', 'success');
                            document.getElementById('onsite-payment-form').reset();
                            document.getElementById('onsite-months-container').innerHTML = '';
                            document.getElementById('onsite-payment-other').style.display = 'none';
                            
                        } catch (error) {
                            showAlert('Erreur lors de l\'enregistrement: ' + error.message, 'error');
                        }
                    });

                    // --- Gestion des Frais ---
                    async function loadFeesClasses() {
                        const selectEl = document.getElementById('fees-class');
                        selectEl.innerHTML = '<option value="">Toutes les classes</option>';
                        
                        try {
                            // Classes secondaires
                            const classesSnap = await getDocs(collection(db, 'classes'));
                            classesSnap.forEach(doc => {
                                const data = doc.data();
                                selectEl.innerHTML += `<option value="${data.name}">${data.name}</option>`;
                            });
                            
                            // Classes primaires
                            const primaryClassesSnap = await getDocs(collection(db, 'primary_classes'));
                            primaryClassesSnap.forEach(doc => {
                                const data = doc.data();
                                selectEl.innerHTML += `<option value="${data.name}">${data.name}</option>`;
                            });
                            
                            // Classes maternelles
                            const kindergartenClassesSnap = await getDocs(collection(db, 'kindergarten_classes'));
                            kindergartenClassesSnap.forEach(doc => {
                                const data = doc.data();
                                selectEl.innerHTML += `<option value="${data.name}">${data.name}</option>`;
                            });
                        } catch (error) {
                            console.error("Erreur chargement classes pour frais:", error);
                        }
                    }

                    document.getElementById('load-fees-btn').addEventListener('click', async () => {
                        await loadFeesData();
                    });

                    // Recherche dans la gestion des frais
                    document.getElementById('fees-search').addEventListener('input', (e) => {
                        const searchTerm = e.target.value.toLowerCase();
                        const activeTab = document.querySelector('.tab.active').dataset.tab;
                        const rows = document.querySelectorAll(`#${activeTab}-students-list tr`);
                        
                        rows.forEach(row => {
                            const text = row.textContent.toLowerCase();
                            row.style.display = text.includes(searchTerm) ? '' : 'none';
                        });
                    });

                    async function loadFeesData() {
                        const selectedStudentType = document.getElementById('fees-student-type').value;
                        const selectedClass = document.getElementById('fees-class').value;
                        const selectedMonth = document.getElementById('fees-month').value;
                        const selectedType = document.getElementById('fees-type').value;
                        
                        try {
                            let studentsList = [];
                            
                            // Récupérer les élèves selon le type sélectionné
                            if (selectedStudentType === 'all' || selectedStudentType === 'secondary') {
                                const studentsSnap = await getDocs(query(collection(db, 'students'), where('status', '!=', 'deleted')));
                                studentsSnap.forEach(doc => {
                                    const data = doc.data();
                                    if (!selectedClass || data.class === selectedClass) {
                                        studentsList.push({...data, studentType: 'secondary'});
                                    }
                                });
                            }
                            
                            if (selectedStudentType === 'all' || selectedStudentType === 'primary') {
                                const primaryStudentsSnap = await getDocs(query(collection(db, 'primary_students'), where('status', '!=', 'deleted')));
                                primaryStudentsSnap.forEach(doc => {
                                    const data = doc.data();
                                    if (!selectedClass || data.class === selectedClass) {
                                        studentsList.push({...data, studentType: 'primary'});
                                    }
                                });
                            }
                            
                            if (selectedStudentType === 'all' || selectedStudentType === 'kindergarten') {
                                const kindergartenStudentsSnap = await getDocs(query(collection(db, 'kindergarten_students'), where('status', '!=', 'deleted')));
                                kindergartenStudentsSnap.forEach(doc => {
                                    const data = doc.data();
                                    if (!selectedClass || data.class === selectedClass) {
                                        studentsList.push({...data, studentType: 'kindergarten'});
                                    }
                                });
                            }
                            
                            // Récupérer tous les paiements du mois sélectionné
                            let paymentsQuery = collection(db, 'payments');
                            if (selectedMonth) {
                                paymentsQuery = query(paymentsQuery, where('month', '==', selectedMonth));
                            }
                            if (selectedType) {
                                paymentsQuery = query(paymentsQuery, where('paymentType', '==', selectedType));
                            }
                            
                            const paymentsSnap = await getDocs(paymentsQuery);
                            
                            // Créer un Set des élèves ayant payé
                            const paidStudents = new Set();
                            const paymentDetails = {};
                            
                            paymentsSnap.forEach(doc => {
                                const data = doc.data();
                                paidStudents.add(data.studentId);
                                if (!paymentDetails[data.studentId]) {
                                    paymentDetails[data.studentId] = {
                                        amount: 0,
                                        type: data.paymentType,
                                        date: data.validatedAt
                                    };
                                }
                                paymentDetails[data.studentId].amount += data.amount;
                                if (data.validatedAt > (paymentDetails[data.studentId].date || new Date(0))) {
                                    paymentDetails[data.studentId].date = data.validatedAt;
                                }
                            });
                            
                            // Calculer les statistiques
                            const totalStudents = studentsList.length;
                            const paidCount = Array.from(paidStudents).length;
                            const unpaidCount = totalStudents - paidCount;
                            const paymentRate = totalStudents > 0 ? Math.round((paidCount / totalStudents) * 100) : 0;
                            
                            // Mettre à jour les statistiques
                            document.getElementById('total-students-fees').textContent = totalStudents;
                            document.getElementById('paid-students').textContent = paidCount;
                            document.getElementById('unpaid-students').textContent = unpaidCount;
                            document.getElementById('payment-rate').textContent = paymentRate + '%';
                            
                            // Mettre à jour les listes d'élèves
                            updateFeesStudentsLists(studentsList, paidStudents, paymentDetails, selectedMonth, selectedType);
                            
                        } catch (error) {
                            console.error("Erreur chargement données frais:", error);
                            showAlert('Erreur lors du chargement des données: ' + error.message, 'error');
                        }
                    }

                    async function updateFeesStudentsLists(studentsList, paidStudents, paymentDetails, selectedMonth, selectedType) {
                        const unpaidList = document.getElementById('unpaid-students-list');
                        const paidList = document.getElementById('paid-students-list');
                        const allList = document.getElementById('all-students-list');
                        
                        let unpaidHTML = '';
                        let paidHTML = '';
                        let allHTML = '';
                        
                        for (const student of studentsList) {
                            const isPaid = paidStudents.has(student.matricule);
                            const paymentInfo = paymentDetails[student.matricule] || { amount: 0, type: 'Aucun', date: null };
                            const studentTypeText = student.studentType === 'secondary' ? 'Secondaire' : 
                                                  student.studentType === 'primary' ? 'Primaire' : 'Maternelle';
                            
                            const unpaidRowHTML = `
                                <tr>
                                    <td>${student.matricule}</td>
                                    <td>${student.fullName}</td>
                                    <td>${studentTypeText}</td>
                                    <td>${student.class}</td>
                                    <td>${selectedType || 'Tous'}</td>
                                    <td class="currency-display">$0.00</td>
                                    <td>${selectedMonth || 'Tous'}</td>
                                    <td class="action-buttons">
                                        <button class="btn btn-primary" onclick="viewStudentDetails('${student.matricule}', '${student.studentType}')">Détails</button>
                                    </td>
                                </tr>
                            `;
                            
                            const paidRowHTML = `
                                <tr>
                                    <td>${student.matricule}</td>
                                    <td>${student.fullName}</td>
                                    <td>${studentTypeText}</td>
                                    <td>${student.class}</td>
                                    <td>${paymentInfo.type}</td>
                                    <td class="currency-display">$${paymentInfo.amount.toFixed(2)}</td>
                                    <td>${formatDate(paymentInfo.date?.toDate())}</td>
                                    <td class="action-buttons">
                                        <button class="btn btn-primary" onclick="viewStudentDetails('${student.matricule}', '${student.studentType}')">Détails</button>
                                    </td>
                                </tr>
                            `;
                            
                            const allRowHTML = `
                                <tr>
                                    <td>${student.matricule}</td>
                                    <td>${student.fullName}</td>
                                    <td>${studentTypeText}</td>
                                    <td>${student.class}</td>
                                    <td>${isPaid ? paymentInfo.type : 'Aucun'}</td>
                                    <td class="currency-display">${isPaid ? `$${paymentInfo.amount.toFixed(2)}` : '$0.00'}</td>
                                    <td>${isPaid ? '<span class="badge badge-success">Payé</span>' : '<span class="badge badge-danger">Non payé</span>'}</td>
                                    <td class="action-buttons">
                                        <button class="btn btn-primary" onclick="viewStudentDetails('${student.matricule}', '${student.studentType}')">Détails</button>
                                    </td>
                                </tr>
                            `;
                            
                            if (isPaid) {
                                paidHTML += paidRowHTML;
                            } else {
                                unpaidHTML += unpaidRowHTML;
                            }
                            
                            allHTML += allRowHTML;
                        }
                        
                        unpaidList.innerHTML = unpaidHTML || '<tr><td colspan="8" style="text-align: center;">Aucun élève non payé</td></tr>';
                        paidList.innerHTML = paidHTML || '<tr><td colspan="8" style="text-align: center;">Aucun élève en ordre</td></tr>';
                        allList.innerHTML = allHTML || '<tr><td colspan="8" style="text-align: center;">Aucun élève trouvé</td></tr>';
                    }

                    // --- Liste des Élèves ---
                    async function loadStudentsList() {
                        const tableBody = document.getElementById('students-table-body');
                        const studentTypeFilter = document.getElementById('student-type-filter').value;
                        tableBody.innerHTML = "Chargement...";
                        
                        try {
                            let students = [];
                            
                            // Récupérer les élèves secondaires
                            if (studentTypeFilter === 'all' || studentTypeFilter === 'secondary') {
                                const studentsSnap = await getDocs(query(collection(db, 'students'), where('status', '!=', 'deleted')));
                                studentsSnap.forEach(doc => {
                                    const data = doc.data();
                                    students.push({...data, studentType: 'secondary'});
                                });
                            }
                            
                            // Récupérer les élèves primaires
                            if (studentTypeFilter === 'all' || studentTypeFilter === 'primary') {
                                const primaryStudentsSnap = await getDocs(query(collection(db, 'primary_students'), where('status', '!=', 'deleted')));
                                primaryStudentsSnap.forEach(doc => {
                                    const data = doc.data();
                                    students.push({...data, studentType: 'primary'});
                                });
                            }
                            
                            // Récupérer les élèves maternelles
                            if (studentTypeFilter === 'all' || studentTypeFilter === 'kindergarten') {
                                const kindergartenStudentsSnap = await getDocs(query(collection(db, 'kindergarten_students'), where('status', '!=', 'deleted')));
                                kindergartenStudentsSnap.forEach(doc => {
                                    const data = doc.data();
                                    students.push({...data, studentType: 'kindergarten'});
                                });
                            }
                            
                            if (students.length === 0) {
                                tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Aucun élève inscrit.</td></tr>';
                                return;
                            }
                            
                            let html = '';
                            for (const student of students) {
                                const statusBadge = student.status === 'active' 
                                    ? '<span class="badge badge-success">Actif</span>' 
                                    : '<span class="badge badge-danger">Inactif</span>';
                                
                                const photoHTML = student.photoURL 
                                    ? `<img src="${student.photoURL}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">`
                                    : '<div style="width: 40px; height: 40px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center;"><i class="fas fa-user"></i></div>';
                                
                                const studentTypeText = student.studentType === 'secondary' ? 'Secondaire' : 
                                                      student.studentType === 'primary' ? 'Primaire' : 'Maternelle';
                                
                                html += `
                                    <tr>
                                        <td>${photoHTML}</td>
                                        <td>${student.matricule}</td>
                                        <td>${student.fullName}</td>
                                        <td>${studentTypeText}</td>
                                        <td>${student.class}</td>
                                        <td>${formatDate(student.createdAt?.toDate())}</td>
                                        <td>${statusBadge}</td>
                                        <td class="action-buttons">
                                            <button class="btn btn-primary" onclick="viewStudentDetails('${student.matricule}', '${student.studentType}')">Détails</button>
                                            <button class="btn btn-warning" onclick="editStudent('${student.matricule}', '${student.studentType}')">Modifier</button>
                                            <button class="btn btn-danger" onclick="deleteStudent('${student.matricule}', '${student.studentType}')">Supprimer</button>
                                        </td>
                                    </tr>
                                `;
                            }
                            
                            tableBody.innerHTML = html;
                        } catch (error) {
                            console.error("Erreur chargement élèves:", error);
                            tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Erreur de chargement</td></tr>';
                        }
                    }

                    // --- Liste des Enseignants ---
                    async function loadTeachersList() {
                        const tableBody = document.getElementById('teachers-table-body');
                        const teacherTypeFilter = document.getElementById('teacher-type-filter').value;
                        tableBody.innerHTML = "Chargement...";
                        
                        try {
                            let teachers = [];
                            
                            // Récupérer les enseignants secondaires
                            if (teacherTypeFilter === 'all' || teacherTypeFilter === 'secondary') {
                                const teachersSnap = await getDocs(query(collection(db, 'teachers'), where('status', '!=', 'deleted')));
                                teachersSnap.forEach(doc => {
                                    const data = doc.data();
                                    teachers.push({...data, teacherType: 'secondary'});
                                });
                            }
                            
                            // Récupérer les enseignants primaires
                            if (teacherTypeFilter === 'all' || teacherTypeFilter === 'primary') {
                                const primaryTeachersSnap = await getDocs(query(collection(db, 'primary_teachers'), where('status', '!=', 'deleted')));
                                primaryTeachersSnap.forEach(doc => {
                                    const data = doc.data();
                                    teachers.push({...data, teacherType: 'primary'});
                                });
                            }
                            
                            // Récupérer les enseignants maternelles
                            if (teacherTypeFilter === 'all' || teacherTypeFilter === 'kindergarten') {
                                const kindergartenTeachersSnap = await getDocs(query(collection(db, 'kindergarten_teachers'), where('status', '!=', 'deleted')));
                                kindergartenTeachersSnap.forEach(doc => {
                                    const data = doc.data();
                                    teachers.push({...data, teacherType: 'kindergarten'});
                                });
                            }
                            
                            if (teachers.length === 0) {
                                tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center;">Aucun enseignant inscrit.</td></tr>';
                                return;
                            }
                            
                            let html = '';
                            teachers.forEach(teacher => {
                                const statusBadge = teacher.status === 'active' 
                                    ? '<span class="badge badge-success">Actif</span>' 
                                    : '<span class="badge badge-danger">Inactif</span>';
                                
                                const photoHTML = teacher.photoURL 
                                    ? `<img src="${teacher.photoURL}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">`
                                    : '<div style="width: 40px; height: 40px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center;"><i class="fas fa-user-tie"></i></div>';
                                
                                const teacherTypeText = teacher.teacherType === 'secondary' ? 'Secondaire' : 
                                                       teacher.teacherType === 'primary' ? 'Primaire' : 'Maternelle';
                                const subjectsText = teacher.subjects ? teacher.subjects.join(', ') : 'Toutes matières';
                                
                                html += `
                                    <tr>
                                        <td>${photoHTML}</td>
                                        <td>${teacher.matricule}</td>
                                        <td>${teacher.fullName}</td>
                                        <td>${teacherTypeText}</td>
                                        <td>${teacher.phone}</td>
                                        <td>${subjectsText}</td>
                                        <td>${teacher.classes ? teacher.classes.join(', ') : 'Aucune'}</td>
                                        <td>${formatDate(teacher.createdAt?.toDate())}</td>
                                        <td>${statusBadge}</td>
                                        <td class="action-buttons">
                                            <button class="btn btn-primary" onclick="viewTeacherDetails('${teacher.matricule}', '${teacher.teacherType}')">Détails</button>
                                            <button class="btn btn-warning" onclick="editTeacher('${teacher.matricule}', '${teacher.teacherType}')">Modifier</button>
                                            <button class="btn btn-danger" onclick="deleteTeacher('${teacher.matricule}', '${teacher.teacherType}')">Supprimer</button>
                                        </td>
                                    </tr>
                                `;
                            });
                            
                            tableBody.innerHTML = html;
                        } catch (error) {
                            console.error("Erreur chargement enseignants:", error);
                            tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center;">Erreur de chargement</td></tr>';
                        }
                    }

                    // --- Valider Inscription ---
                    let foundEnrollment = null;
                    
                    document.getElementById('find-enrollment-btn').addEventListener('click', async () => {
                        const code = document.getElementById('enrollment-code-input').value;
                        if (!code) {
                            showAlert("Veuillez entrer un code d'inscription", "error");
                            return;
                        }
                        
                        try {
                            const q = query(collection(db, 'enrollment_requests'), where('enrollmentCode', '==', code), where('status', '==', 'pending'));
                            const snap = await getDocs(q);

                            if (snap.empty) {
                                showAlert('Aucune demande d\'inscription en attente trouvée pour ce code.', 'error');
                                document.getElementById('enrollment-details-card').classList.add('hidden');
                                return;
                            }
                            
                            foundEnrollment = snap.docs[0];
                            const data = foundEnrollment.data();
                            
                            // Remplir le formulaire avec les données de l'inscription
                            document.getElementById('enrollment-id').value = foundEnrollment.id;
                            document.getElementById('enrollment-student-name').value = data.studentName;
                            document.getElementById('enrollment-birthdate').value = data.birthdate;
                            document.getElementById('enrollment-birthplace').value = data.birthplace || '';
                            document.getElementById('enrollment-gender').value = data.gender || '';
                            document.getElementById('enrollment-address').value = data.address || '';
                            document.getElementById('enrollment-phone').value = data.phone || '';
                            document.getElementById('enrollment-parent-name').value = data.parentName;
                            document.getElementById('enrollment-parent-phone').value = data.parentPhone;
                            document.getElementById('enrollment-parent-address').value = data.parentAddress || '';
                            
                            document.getElementById('enrollment-details-card').classList.remove('hidden');
                        } catch (error) {
                            showAlert('Erreur de recherche: ' + error.message, 'error');
                        }
                    });

                    document.getElementById('enrollment-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        if (!foundEnrollment) return;
                        
                        const studentName = document.getElementById('enrollment-student-name').value;
                        const birthdate = document.getElementById('enrollment-birthdate').value;
                        const birthplace = document.getElementById('enrollment-birthplace').value;
                        const gender = document.getElementById('enrollment-gender').value;
                        const address = document.getElementById('enrollment-address').value;
                        const phone = document.getElementById('enrollment-phone').value;
                        const studentClass = document.getElementById('enrollment-class').value;
                        const parentName = document.getElementById('enrollment-parent-name').value;
                        const parentPhone = document.getElementById('enrollment-parent-phone').value;
                        const parentAddress = document.getElementById('enrollment-parent-address').value;
                        const year = new Date().getFullYear();

                        try {
                            // Générer matricule
                            const q = query(collection(db, 'students'), where('year', '==', year));
                            const countSnap = await getDocs(q);
                            const matricule = `SEC${year}${(countSnap.size + 1).toString().padStart(3, '0')}`;

                            // Créer l'élève dans Firestore
                            const studentData = {
                                matricule,
                                fullName: studentName,
                                birthdate,
                                birthplace,
                                gender,
                                address,
                                phone,
                                class: studentClass,
                                parentName,
                                parentPhone,
                                parentAddress,
                                studentType: 'secondary',
                                status: 'active',
                                year,
                                createdAt: serverTimestamp(),
                                updatedAt: serverTimestamp()
                            };

                            // Utiliser setDoc avec l'ID comme matricule
                            const studentRef = doc(db, 'students', matricule);
                            await setDoc(studentRef, studentData);

                            // Mettre à jour la demande d'inscription
                            await updateDoc(doc(db, 'enrollment_requests', foundEnrollment.id), {
                                status: 'approved',
                                approvedAt: serverTimestamp(),
                                approvedBy: currentSecretary.uid,
                                studentMatricule: matricule
                            });

                            showAlert(`Élève ${studentName} inscrit avec succès! Matricule: ${matricule}`, 'success');
                            document.getElementById('enrollment-form').reset();
                            document.getElementById('enrollment-details-card').classList.add('hidden');
                            document.getElementById('enrollment-code-input').value = '';
                            foundEnrollment = null;
                            
                            // Mettre à jour les statistiques et listes
                            loadDashboardStats();
                            loadStudentsList();
                        } catch (error) {
                            showAlert('Erreur lors de l\'inscription: ' + error.message, 'error');
                        }
                    });

                    // --- Rapports Administratifs ---
                    document.getElementById('generate-report-btn').addEventListener('click', async () => {
                        await generateReport();
                    });

                    // Bouton retour pour les rapports
                    document.getElementById('back-report-btn').addEventListener('click', () => {
                        document.getElementById('report-content').classList.add('hidden');
                        document.getElementById('back-report-btn').style.display = 'none';
                    });

                    async function generateReport() {
                        const reportType = document.getElementById('report-type').value;
                        const reportDate = document.getElementById('report-date').value;
                        const reportMonth = document.getElementById('report-month').value;
                        
                        try {
                            let paymentsQuery = collection(db, 'payments');
                            let reportTitle = '';
                            let reportPeriod = '';
                            
                            if (reportType === 'daily') {
                                if (!reportDate) {
                                    showAlert("Veuillez sélectionner une date", "error");
                                    return;
                                }
                                const startDate = new Date(reportDate);
                                const endDate = new Date(startDate);
                                endDate.setDate(endDate.getDate() + 1);
                                
                                paymentsQuery = query(
                                    paymentsQuery, 
                                    where('validatedAt', '>=', startDate),
                                    where('validatedAt', '<', endDate)
                                );
                                
                                reportTitle = 'Rapport Journalier des Paiements';
                                reportPeriod = `Date: ${new Date(reportDate).toLocaleDateString('fr-FR')}`;
                            } else if (reportType === 'monthly') {
                                if (!reportMonth) {
                                    showAlert("Veuillez sélectionner un mois", "error");
                                    return;
                                }
                                
                                paymentsQuery = query(paymentsQuery, where('month', '==', reportMonth));
                                
                                reportTitle = 'Rapport Mensuel des Paiements';
                                reportPeriod = `Mois: ${reportMonth}`;
                            } else if (reportType === 'fees') {
                                reportTitle = 'Rapport par Type de Frais';
                                reportPeriod = `Période: ${reportMonth ? reportMonth : 'Tous les mois'}`;
                                
                                if (reportMonth) {
                                    paymentsQuery = query(paymentsQuery, where('month', '==', reportMonth));
                                }
                            } else if (reportType === 'enrollment') {
                                reportTitle = 'Rapport des Inscriptions';
                                reportPeriod = `Période: ${reportMonth ? reportMonth : 'Tous les mois'}`;
                                
                                // Pour les inscriptions, nous allons traiter différemment
                                await generateEnrollmentReport(reportMonth);
                                return;
                            }
                            
                            const paymentsSnap = await getDocs(paymentsQuery);
                            
                            // Calculer les statistiques
                            let totalAmount = 0;
                            let onlineCount = 0;
                            let onsiteCount = 0;
                            let tableHTML = '';
                            
                            // Pour le rapport par type de frais
                            const feesBreakdown = {};
                            let totalPaymentsCount = 0;
                            
                            paymentsSnap.forEach(doc => {
                                const data = doc.data();
                                totalAmount += data.amount;
                                totalPaymentsCount++;
                                
                                if (data.paymentMethod === 'online') {
                                    onlineCount++;
                                } else {
                                    onsiteCount++;
                                }
                                
                                // Ajouter au breakdown par type de frais
                                if (reportType === 'fees') {
                                    const feeType = data.paymentType || 'Autres';
                                    if (!feesBreakdown[feeType]) {
                                        feesBreakdown[feeType] = {
                                            count: 0,
                                            amount: 0
                                        };
                                    }
                                    feesBreakdown[feeType].count++;
                                    feesBreakdown[feeType].amount += data.amount;
                                }
                                
                                const studentTypeText = data.studentType === 'secondary' ? 'Secondaire' : 
                                                      data.studentType === 'primary' ? 'Primaire' : 'Maternelle';
                                
                                tableHTML += `
                                    <tr>
                                        <td>${formatDate(data.validatedAt?.toDate())}</td>
                                        <td>${data.studentName}</td>
                                        <td>${studentTypeText}</td>
                                        <td>${data.studentClass}</td>
                                        <td>${data.month}</td>
                                        <td>${data.paymentType}</td>
                                        <td class="currency-display">$${data.amount.toFixed(2)}</td>
                                        <td>${data.paymentMethod === 'online' ? 'En ligne' : 'Sur place'}</td>
                                        <td>${currentSecretary.fullName}</td>
                                    </tr>
                                `;
                            });
                            
                            // Mettre à jour les statistiques
                            document.getElementById('total-payments').textContent = paymentsSnap.size;
                            document.getElementById('total-amount').textContent = '$' + totalAmount.toFixed(2);
                            document.getElementById('online-payments').textContent = onlineCount;
                            document.getElementById('onsite-payments').textContent = onsiteCount;
                            
                            // Mettre à jour le tableau
                            document.getElementById('report-table-body').innerHTML = tableHTML || '<tr><td colspan="9" style="text-align: center;">Aucun paiement trouvé</td></tr>';
                            
                            // Mettre à jour le titre et la période
                            document.getElementById('report-title').textContent = reportTitle;
                            document.getElementById('report-period').textContent = reportPeriod;
                            
                            // Gérer le breakdown par type de frais
                            if (reportType === 'fees') {
                                let breakdownHTML = '';
                                for (const [feeType, data] of Object.entries(feesBreakdown)) {
                                    const percentage = totalAmount > 0 ? ((data.amount / totalAmount) * 100).toFixed(2) : 0;
                                    breakdownHTML += `
                                        <tr>
                                            <td>${feeType}</td>
                                            <td>${data.count}</td>
                                            <td class="currency-display">$${data.amount.toFixed(2)}</td>
                                            <td>${percentage}%</td>
                                        </tr>
                                    `;
                                }
                                
                                document.getElementById('fees-breakdown-table').innerHTML = breakdownHTML || '<tr><td colspan="4" style="text-align: center;">Aucun frais trouvé</td></tr>';
                                document.getElementById('total-payments-breakdown').textContent = totalPaymentsCount;
                                document.getElementById('total-amount-breakdown').textContent = '$' + totalAmount.toFixed(2);
                                document.getElementById('fees-breakdown-section').classList.remove('hidden');
                            } else {
                                document.getElementById('fees-breakdown-section').classList.add('hidden');
                            }
                            
                            // Afficher le contenu du rapport
                            document.getElementById('report-content').classList.remove('hidden');
                            document.getElementById('back-report-btn').style.display = 'block';
                            
                        } catch (error) {
                            console.error("Erreur génération rapport:", error);
                            showAlert('Erreur lors de la génération du rapport: ' + error.message, 'error');
                        }
                    }

                    async function generateEnrollmentReport(month) {
                        try {
                            // Récupérer tous les étudiants
                            const studentsSnap = await getDocs(query(collection(db, 'students'), where('status', '!=', 'deleted')));
                            const primaryStudentsSnap = await getDocs(query(collection(db, 'primary_students'), where('status', '!=', 'deleted')));
                            const kindergartenStudentsSnap = await getDocs(query(collection(db, 'kindergarten_students'), where('status', '!=', 'deleted')));
                            
                            let allStudents = [];
                            studentsSnap.forEach(doc => {
                                allStudents.push({...doc.data(), studentType: 'secondary'});
                            });
                            primaryStudentsSnap.forEach(doc => {
                                allStudents.push({...doc.data(), studentType: 'primary'});
                            });
                            kindergartenStudentsSnap.forEach(doc => {
                                allStudents.push({...doc.data(), studentType: 'kindergarten'});
                            });
                            
                            // Filtrer par mois si spécifié
                            if (month) {
                                const monthNames = {
                                    'janvier': 0, 'février': 1, 'mars': 2, 'avril': 3, 'mai': 4, 'juin': 5,
                                    'juillet': 6, 'août': 7, 'septembre': 8, 'octobre': 9, 'novembre': 10, 'décembre': 11
                                };
                                
                                const targetMonth = monthNames[month.toLowerCase()];
                                allStudents = allStudents.filter(student => {
                                    if (student.createdAt && student.createdAt.toDate) {
                                        const studentMonth = student.createdAt.toDate().getMonth();
                                        return studentMonth === targetMonth;
                                    }
                                    return false;
                                });
                            }
                            
                            // Calculer les statistiques
                            const totalStudents = allStudents.length;
                            const secondaryCount = allStudents.filter(s => s.studentType === 'secondary').length;
                            const primaryCount = allStudents.filter(s => s.studentType === 'primary').length;
                            const kindergartenCount = allStudents.filter(s => s.studentType === 'kindergarten').length;
                            const totalFees = allStudents.reduce((sum, student) => sum + (student.enrollmentFees || 0), 0);
                            
                            // Mettre à jour les statistiques
                            document.getElementById('total-payments').textContent = totalStudents;
                            document.getElementById('total-amount').textContent = '$' + totalFees.toFixed(2);
                            document.getElementById('online-payments').textContent = secondaryCount;
                            document.getElementById('onsite-payments').textContent = primaryCount + kindergartenCount;
                            
                            // Générer le tableau
                            let tableHTML = '';
                            allStudents.forEach(student => {
                                const studentTypeText = student.studentType === 'secondary' ? 'Secondaire' : 
                                                      student.studentType === 'primary' ? 'Primaire' : 'Maternelle';
                                
                                tableHTML += `
                                    <tr>
                                        <td>${formatDate(student.createdAt?.toDate())}</td>
                                        <td>${student.fullName}</td>
                                        <td>${studentTypeText}</td>
                                        <td>${student.class}</td>
                                        <td>Inscription</td>
                                        <td>Frais d'inscription</td>
                                        <td class="currency-display">$${(student.enrollmentFees || 0).toFixed(2)}</td>
                                        <td>Sur place</td>
                                        <td>${currentSecretary.fullName}</td>
                                    </tr>
                                `;
                            });
                            
                            document.getElementById('report-table-body').innerHTML = tableHTML || '<tr><td colspan="9" style="text-align: center;">Aucune inscription trouvée</td></tr>';
                            
                            // Mettre à jour le titre et la période
                            document.getElementById('report-title').textContent = 'Rapport des Inscriptions';
                            document.getElementById('report-period').textContent = month ? `Mois: ${month}` : 'Tous les mois';
                            
                            // Cacher le breakdown des frais
                            document.getElementById('fees-breakdown-section').classList.add('hidden');
                            
                            // Afficher le contenu du rapport
                            document.getElementById('report-content').classList.remove('hidden');
                            document.getElementById('back-report-btn').style.display = 'block';
                            
                        } catch (error) {
                            console.error("Erreur génération rapport inscriptions:", error);
                            showAlert('Erreur lors de la génération du rapport: ' + error.message, 'error');
                        }
                    }

                    document.getElementById('export-report-btn').addEventListener('click', () => {
                        const reportContent = document.getElementById('report-content').innerHTML;
                        
                        // Créer une nouvelle fenêtre pour l'impression
                        const printWindow = window.open('', '_blank');
                        
                        // HTML minimal pour l'impression
                        const printHTML = `
                            <!DOCTYPE html>
                            <html>
                                <head>
                                    <title>Rapport des Paiements - CS la Colombe</title>
                                    <style>
                                        body { 
                                            font-family: Arial, sans-serif; 
                                            margin: 20px; 
                                            font-size: 12px;
                                        }
                                        .report-card { 
                                            max-width: 100%; 
                                            margin: 0 auto; 
                                            border: none;
                                            padding: 0;
                                        }
                                        .report-header { 
                                            display: flex; 
                                            justify-content: space-between; 
                                            align-items: center; 
                                            margin-bottom: 20px;
                                            border-bottom: 2px solid #3498db;
                                            padding-bottom: 10px;
                                        }
                                        .report-summary { 
                                            display: grid; 
                                            grid-template-columns: repeat(4, 1fr); 
                                            gap: 1rem; 
                                            margin-bottom: 1.5rem; 
                                        }
                                        .fees-summary-card { 
                                            background: #f8f9fa; 
                                            padding: 1rem; 
                                            border-radius: 8px; 
                                            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
                                            text-align: center; 
                                            border: 1px solid #dee2e6;
                                        }
                                        .fees-summary-card h4 { 
                                            margin-bottom: 0.5rem; 
                                            color: #2c3e50; 
                                            font-size: 14px;
                                        }
                                        .fees-summary-card p { 
                                            font-size: 18px; 
                                            font-weight: bold; 
                                            color: #3498db; 
                                            margin: 0;
                                        }
                                        table { 
                                            width: 100%; 
                                            border-collapse: collapse; 
                                            margin-top: 1rem; 
                                            font-size: 11px;
                                        }
                                        th, td { 
                                            padding: 6px 8px; 
                                            text-align: left; 
                                            border: 1px solid #dee2e6; 
                                        }
                                        th { 
                                            background-color: #f8f9fa; 
                                            font-weight: 600; 
                                        }
                                        .signature-area { 
                                            margin-top: 3rem; 
                                            display: flex; 
                                            justify-content: space-between; 
                                        }
                                        .signature-box { 
                                            text-align: center; 
                                            width: 45%; 
                                        }
                                        .signature-line { 
                                            border-top: 1px solid #000; 
                                            margin-top: 3rem; 
                                        }
                                        .currency-display { 
                                            font-weight: bold; 
                                            color: #27ae60; 
                                        }
                                        @media print {
                                            body { 
                                                margin: 0; 
                                                padding: 10px;
                                            }
                                            .report-card { 
                                                border: none; 
                                                box-shadow: none; 
                                            }
                                            .no-print {
                                                display: none !important;
                                            }
                                        }
                                    </style>
                                </head>
                                <body>
                                    <div class="report-card">
                                        ${reportContent}
                                    </div>
                                    <script>
                                        window.onload = function() {
                                            window.print();
                                            setTimeout(function() {
                                                window.close();
                                            }, 1000);
                                        }
                                    <\/script>
                                </body>
                            </html>
                        `;
                        
                        printWindow.document.write(printHTML);
                        printWindow.document.close();
                    });

                    // --- Profil ---
                    async function loadProfileData() {
                        if (!currentSecretary) return;
                        
                        try {
                            document.getElementById('profile-name').value = currentSecretary.fullName || '';
                            document.getElementById('profile-email').value = currentSecretary.email || '';
                            document.getElementById('profile-phone').value = currentSecretary.phone || '';
                            document.getElementById('profile-address').value = currentSecretary.address || '';
                            document.getElementById('profile-created').value = formatDate(currentSecretary.createdAt?.toDate()) || '';
                            
                            // Afficher la photo de profil
                            const photoPreview = document.getElementById('profile-photo-preview');
                            if (currentSecretary.photoURL) {
                                photoPreview.innerHTML = `<img src="${currentSecretary.photoURL}" class="photo-preview">`;
                            } else {
                                photoPreview.innerHTML = '<i class="fas fa-user"></i>';
                            }
                        } catch (error) {
                            console.error("Erreur chargement profil:", error);
                        }
                    }

                    document.getElementById('update-profile-btn').addEventListener('click', async () => {
                        if (!currentSecretary) return;
                        
                        const fullName = document.getElementById('profile-name').value;
                        const phone = document.getElementById('profile-phone').value;
                        const address = document.getElementById('profile-address').value;
                        
                        try {
                            // Uploader la nouvelle photo si elle existe
                            let photoURL = currentSecretary.photoURL;
                            if (profilePhotoFile) {
                                try {
                                    photoURL = await uploadToCloudinary(profilePhotoFile, `secretary/${currentSecretary.id}`);
                                } catch (uploadError) {
                                    console.error("Erreur upload photo profil:", uploadError);
                                }
                            }
                            
                            // Mettre à jour les données dans Firestore
                            await updateDoc(doc(db, 'secretary', currentSecretary.id), {
                                fullName,
                                phone,
                                address,
                                photoURL,
                                updatedAt: serverTimestamp()
                            });
                            
                            // Mettre à jour l'objet currentSecretary
                            currentSecretary.fullName = fullName;
                            currentSecretary.phone = phone;
                            currentSecretary.address = address;
                            currentSecretary.photoURL = photoURL;
                            
                            // Mettre à jour l'affichage
                            document.getElementById('secretary-name').textContent = fullName;
                            const photoContainer = document.getElementById('secretary-photo-container');
                            if (photoURL) {
                                photoContainer.innerHTML = `<img src="${photoURL}" class="secretary-photo" alt="Photo de profil">`;
                            } else {
                                photoContainer.innerHTML = `<div class="secretary-photo-placeholder"><i class="fas fa-user"></i></div>`;
                            }
                            
                            showAlert('Profil mis à jour avec succès !', 'success');
                            profilePhotoFile = null;
                        } catch (error) {
                            console.error("Erreur mise à jour profil:", error);
                            showAlert('Erreur lors de la mise à jour du profil: ' + error.message, 'error');
                        }
                    });

                    // --- Navigation ---
                    document.querySelectorAll('.nav-menu a').forEach(link => {
                        link.addEventListener('click', e => {
                            if (link.parentElement.classList.contains('has-submenu')) {
                                return; // Ne pas changer de page pour les menus déroulants
                            }
                            
                            e.preventDefault();
                            document.querySelectorAll('.nav-menu a, .page').forEach(el => el.classList.remove('active'));
                            link.classList.add('active');
                            document.getElementById(link.dataset.page + '-page').classList.add('active');
                            document.getElementById('page-title').textContent = link.textContent;
                            
                            // Recharger les données si nécessaire
                            if (link.dataset.page === 'dashboard') {
                                loadDashboardStats();
                            } else if (link.dataset.page === 'students-list') {
                                loadStudentsList();
                            } else if (link.dataset.page === 'teachers-list') {
                                loadTeachersList();
                            } else if (link.dataset.page === 'validate-payment') {
                                loadPendingPaymentsList();
                            } else if (link.dataset.page === 'enroll-teacher') {
                                loadTeacherClasses();
                            } else if (link.dataset.page === 'enroll-primary-teacher') {
                                loadPrimaryTeacherClasses();
                            } else if (link.dataset.page === 'enroll-kindergarten-teacher') {
                                loadKindergartenTeacherClasses();
                            } else if (link.dataset.page === 'manage-fees') {
                                loadFeesData();
                            } else if (link.dataset.page === 'admin-reports') {
                                // Initialiser les dates pour les rapports
                                const today = new Date().toISOString().split('T')[0];
                                document.getElementById('report-date').value = today;
                            } else if (link.dataset.page === 'manage-classes') {
                                loadClassesList();
                            } else if (link.dataset.page === 'manage-primary-classes') {
                                loadPrimaryClassesList();
                            } else if (link.dataset.page === 'manage-kindergarten-classes') {
                                loadKindergartenClassesList();
                            } else if (link.dataset.page === 'profile') {
                                loadProfileData();
                            }
                            
                            // Fermer le menu sur mobile
                            if (window.innerWidth <= 768) {
                                document.querySelector('.sidebar').classList.add('collapsed');
                            }
                        });
                    });

                    // Onglets pour la gestion des frais
                    document.querySelectorAll('.tab').forEach(tab => {
                        tab.addEventListener('click', () => {
                            document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
                            tab.classList.add('active');
                            document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
                        });
                    });

                    // Recherche dans la liste des élèves
                    document.getElementById('student-search').addEventListener('input', (e) => {
                        const searchTerm = e.target.value.toLowerCase();
                        const rows = document.querySelectorAll('#students-table-body tr');
                        
                        rows.forEach(row => {
                            const text = row.textContent.toLowerCase();
                            row.style.display = text.includes(searchTerm) ? '' : 'none';
                        });
                    });

                    // Recherche dans la liste des enseignants
                    document.getElementById('teacher-search').addEventListener('input', (e) => {
                        const searchTerm = e.target.value.toLowerCase();
                        const rows = document.querySelectorAll('#teachers-table-body tr');
                        
                        rows.forEach(row => {
                            const text = row.textContent.toLowerCase();
                            row.style.display = text.includes(searchTerm) ? '' : 'none';
                        });
                    });

                    // Filtre par type d'élève
                    document.getElementById('student-type-filter').addEventListener('change', () => {
                        loadStudentsList();
                    });

                    // Filtre par type d'enseignant
                    document.getElementById('teacher-type-filter').addEventListener('change', () => {
                        loadTeachersList();
                    });

                    // --- Fonctions globales pour les boutons ---
                    window.viewStudentDetails = async (studentMatricule, studentType) => {
                        try {
                            let docRef;
                            if (studentType === 'secondary') {
                                docRef = doc(db, 'students', studentMatricule);
                            } else if (studentType === 'primary') {
                                docRef = doc(db, 'primary_students', studentMatricule);
                            } else {
                                docRef = doc(db, 'kindergarten_students', studentMatricule);
                            }
                            
                            const studentSnap = await getDoc(docRef);
                            
                            if (!studentSnap.exists()) {
                                showAlert('Élève non trouvé.', 'error');
                                return;
                            }
                            
                            const data = studentSnap.data();
                            const modalContent = document.getElementById('student-details-content');
                            
                            const photoHTML = data.photoURL 
                                ? `<img src="${data.photoURL}" class="photo-preview" style="margin: 0 auto 1rem; display: block;">`
                                : '<div class="photo-placeholder" style="margin: 0 auto 1rem;"><i class="fas fa-user"></i></div>';
                            
                            const studentTypeText = studentType === 'secondary' ? 'Secondaire' : 
                                                  studentType === 'primary' ? 'Primaire' : 'Maternelle';
                            const phoneField = studentType === 'secondary' ? 
                                `<div class="detail-item">
                                    <label>Téléphone</label>
                                    <p>${data.phone || 'Non spécifié'}</p>
                                </div>` : '';
                            
                            modalContent.innerHTML = `
                                ${photoHTML}
                                <div class="student-details">
                                    <div class="detail-item">
                                        <label>Matricule</label>
                                        <p>${data.matricule}</p>
                                    </div>
                                    <div class="detail-item">
                                        <label>Nom complet</label>
                                        <p>${data.fullName}</p>
                                    </div>
                                    <div class="detail-item">
                                        <label>Type</label>
                                        <p>${studentTypeText}</p>
                                    </div>
                                    <div class="detail-item">
                                        <label>Date de naissance</label>
                                        <p>${data.birthdate}</p>
                                    </div>
                                    <div class="detail-item">
                                        <label>Lieu de naissance</label>
                                        <p>${data.birthplace || 'Non spécifié'}</p>
                                    </div>
                                    <div class="detail-item">
                                        <label>Sexe</label>
                                        <p>${data.gender === 'M' ? 'Masculin' : data.gender === 'F' ? 'Féminin' : 'Non spécifié'}</p>
                                    </div>
                                    <div class="detail-item">
                                        <label>Adresse</label>
                                        <p>${data.address || 'Non spécifié'}</p>
                                    </div>
                                    ${phoneField}
                                    <div class="detail-item">
                                        <label>Classe</label>
                                        <p>${data.class}</p>
                                    </div>
                                    <div class="detail-item">
                                        <label>Frais d'inscription</label>
                                        <p class="currency-display">$${(data.enrollmentFees || 0).toFixed(2)}</p>
                                    </div>
                                    <div class="detail-item">
                                        <label>Statut</label>
                                        <p>${data.status === 'active' ? 'Actif' : 'Inactif'}</p>
                                    </div>
                                    <div class="detail-item">
                                        <label>Date d'inscription</label>
                                        <p>${formatDate(data.createdAt?.toDate())}</p>
                                    </div>
                                    <div class="detail-item">
                                        <label>Nom du parent</label>
                                        <p>${data.parentName}</p>
                                    </div>
                                    <div class="detail-item">
                                        <label>Téléphone du parent</label>
                                        <p>${data.parentPhone}</p>
                                    </div>
                                    <div class="detail-item">
                                        <label>Adresse du parent</label>
                                        <p>${data.parentAddress || 'Non spécifié'}</p>
                                    </div>
                                </div>
                            `;
                            
                            document.getElementById('student-details-modal').classList.remove('hidden');
                        } catch (error) {
                            showAlert('Erreur: ' + error.message, 'error');
                        }
                    };

                    window.viewTeacherDetails = async (teacherMatricule, teacherType) => {
                        try {
                            let docRef;
                            if (teacherType === 'secondary') {
                                docRef = doc(db, 'teachers', teacherMatricule);
                            } else if (teacherType === 'primary') {
                                docRef = doc(db, 'primary_teachers', teacherMatricule);
                            } else {
                                docRef = doc(db, 'kindergarten_teachers', teacherMatricule);
                            }
                            
                            const teacherSnap = await getDoc(docRef);
                            
                            if (!teacherSnap.exists()) {
                                showAlert('Enseignant non trouvé.', 'error');
                                return;
                            }
                            
                            const data = teacherSnap.data();
                            const modalContent = document.getElementById('teacher-details-content');
                            
                            const photoHTML = data.photoURL 
                                ? `<img src="${data.photoURL}" class="photo-preview" style="margin: 0 auto 1rem; display: block;">`
                                : '<div class="photo-placeholder" style="margin: 0 auto 1rem;"><i class="fas fa-user-tie"></i></div>';
                            
                            const teacherTypeText = teacherType === 'secondary' ? 'Secondaire' : 
                                                   teacherType === 'primary' ? 'Primaire' : 'Maternelle';
                            const subjectsField = teacherType === 'secondary' ? 
                                `<div class="detail-item">
                                    <label>Matières</label>
                                    <p>${data.subjects.join(', ')}</p>
                                </div>` : '';
                            
                            modalContent.innerHTML = `
                                ${photoHTML}
                                <div class="student-details">
                                    <div class="detail-item">
                                        <label>Matricule</label>
                                        <p>${data.matricule}</p>
                                    </div>
                                    <div class="detail-item">
                                        <label>Nom complet</label>
                                        <p>${data.fullName}</p>
                                    </div>
                                    <div class="detail-item">
                                        <label>Type</label>
                                        <p>${teacherTypeText}</p>
                                    </div>
                                    <div class="detail-item">
                                        <label>Date de naissance</label>
                                        <p>${data.birthdate}</p>
                                    </div>
                                    <div class="detail-item">
                                        <label>Lieu de naissance</label>
                                        <p>${data.birthplace || 'Non spécifié'}</p>
                                    </div>
                                    <div class="detail-item">
                                        <label>Sexe</label>
                                        <p>${data.gender === 'M' ? 'Masculin' : data.gender === 'F' ? 'Féminin' : 'Non spécifié'}</p>
                                    </div>
                                    <div class="detail-item">
                                        <label>Adresse</label>
                                        <p>${data.address || 'Non spécifié'}</p>
                                    </div>
                                    <div class="detail-item">
                                        <label>Téléphone</label>
                                        <p>${data.phone || 'Non spécifié'}</p>
                                    </div>
                                    ${subjectsField}
                                    <div class="detail-item">
                                        <label>Classes</label>
                                        <p>${data.classes ? data.classes.join(', ') : 'Aucune'}</p>
                                    </div>
                                    <div class="detail-item">
                                        <label>Statut</label>
                                        <p>${data.status === 'active' ? 'Actif' : 'Inactif'}</p>
                                    </div>
                                    <div class="detail-item">
                                        <label>Date d'inscription</label>
                                        <p>${formatDate(data.createdAt?.toDate())}</p>
                                    </div>
                                </div>
                            `;
                            
                            document.getElementById('teacher-details-modal').classList.remove('hidden');
                        } catch (error) {
                            showAlert('Erreur: ' + error.message, 'error');
                        }
                    };

                    window.editStudent = async (studentMatricule, studentType) => {
                        try {
                            let docRef;
                            if (studentType === 'secondary') {
                                docRef = doc(db, 'students', studentMatricule);
                            } else if (studentType === 'primary') {
                                docRef = doc(db, 'primary_students', studentMatricule);
                            } else {
                                docRef = doc(db, 'kindergarten_students', studentMatricule);
                            }
                            
                            const studentSnap = await getDoc(docRef);
                            
                            if (!studentSnap.exists()) {
                                showAlert('Élève non trouvé.', 'error');
                                return;
                            }
                            
                            const data = studentSnap.data();
                            
                            // Remplir le formulaire de modification
                            document.getElementById('edit-student-id').value = studentMatricule;
                            document.getElementById('edit-student-name').value = data.fullName;
                            document.getElementById('edit-student-birthdate').value = data.birthdate;
                            document.getElementById('edit-student-birthplace').value = data.birthplace || '';
                            document.getElementById('edit-student-gender').value = data.gender || '';
                            document.getElementById('edit-student-address').value = data.address || '';
                            document.getElementById('edit-student-phone').value = data.phone || '';
                            document.getElementById('edit-student-class').value = data.class;
                            document.getElementById('edit-student-fees').value = data.enrollmentFees || 0;
                            document.getElementById('edit-parent-name').value = data.parentName;
                            document.getElementById('edit-parent-phone').value = data.parentPhone;
                            document.getElementById('edit-parent-address').value = data.parentAddress || '';
                            document.getElementById('edit-student-status').value = data.status;
                            
                            // Charger les classes dans le select
                            const classSelect = document.getElementById('edit-student-class');
                            classSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
                            
                            let classesSnap;
                            if (studentType === 'secondary') {
                                classesSnap = await getDocs(collection(db, 'classes'));
                            } else if (studentType === 'primary') {
                                classesSnap = await getDocs(collection(db, 'primary_classes'));
                            } else {
                                classesSnap = await getDocs(collection(db, 'kindergarten_classes'));
                            }
                            
                            classesSnap.forEach(doc => {
                                const classData = doc.data();
                                classSelect.innerHTML += `<option value="${classData.name}">${classData.name}</option>`;
                            });
                            
                            // Sélectionner la classe actuelle
                            classSelect.value = data.class;
                            
                            // Cacher le champ téléphone pour les élèves primaires et maternelles
                            const phoneField = document.getElementById('edit-student-phone').parentElement;
                            if (studentType === 'primary' || studentType === 'kindergarten') {
                                phoneField.style.display = 'none';
                            } else {
                                phoneField.style.display = 'block';
                            }
                            
                            document.getElementById('edit-student-modal').classList.remove('hidden');
                        } catch (error) {
                            showAlert('Erreur: ' + error.message, 'error');
                        }
                    };

                    window.editTeacher = async (teacherMatricule, teacherType) => {
                        try {
                            let docRef;
                            if (teacherType === 'secondary') {
                                docRef = doc(db, 'teachers', teacherMatricule);
                            } else if (teacherType === 'primary') {
                                docRef = doc(db, 'primary_teachers', teacherMatricule);
                            } else {
                                docRef = doc(db, 'kindergarten_teachers', teacherMatricule);
                            }
                            
                            const teacherSnap = await getDoc(docRef);
                            
                            if (!teacherSnap.exists()) {
                                showAlert('Enseignant non trouvé.', 'error');
                                return;
                            }
                            
                            const data = teacherSnap.data();
                            
                            // Remplir le formulaire de modification
                            document.getElementById('edit-teacher-id').value = teacherMatricule;
                            document.getElementById('edit-teacher-name').value = data.fullName;
                            document.getElementById('edit-teacher-birthdate').value = data.birthdate;
                            document.getElementById('edit-teacher-birthplace').value = data.birthplace || '';
                            document.getElementById('edit-teacher-gender').value = data.gender || '';
                            document.getElementById('edit-teacher-address').value = data.address || '';
                            document.getElementById('edit-teacher-phone').value = data.phone || '';
                            document.getElementById('edit-teacher-subjects').value = data.subjects ? data.subjects.join(', ') : '';
                            document.getElementById('edit-teacher-status').value = data.status;
                            
                            // Charger les classes dans le container
                            const container = document.getElementById('edit-teacher-classes-container');
                            container.innerHTML = '';
                            
                            let classesSnap;
                            if (teacherType === 'secondary') {
                                classesSnap = await getDocs(collection(db, 'classes'));
                            } else if (teacherType === 'primary') {
                                classesSnap = await getDocs(collection(db, 'primary_classes'));
                            } else {
                                classesSnap = await getDocs(collection(db, 'kindergarten_classes'));
                            }
                            
                            classesSnap.forEach(doc => {
                                const classData = doc.data();
                                const isChecked = data.classes && data.classes.includes(classData.name);
                                container.innerHTML += `
                                    <div class="class-checkbox">
                                        <input type="checkbox" id="edit-class-${doc.id}" value="${classData.name}" ${isChecked ? 'checked' : ''}>
                                        <label for="edit-class-${doc.id}">${classData.name}</label>
                                    </div>
                                `;
                            });
                            
                            // Cacher le champ matières pour les enseignants primaires et maternelles
                            const subjectsField = document.getElementById('edit-teacher-subjects').parentElement;
                            if (teacherType === 'primary' || teacherType === 'kindergarten') {
                                subjectsField.style.display = 'none';
                            } else {
                                subjectsField.style.display = 'block';
                            }
                            
                            document.getElementById('edit-teacher-modal').classList.remove('hidden');
                        } catch (error) {
                            showAlert('Erreur: ' + error.message, 'error');
                        }
                    };

                    window.editClass = async (classId, classType) => {
                        try {
                            let classDoc;
                            if (classType === 'secondary') {
                                classDoc = await getDoc(doc(db, 'classes', classId));
                            } else if (classType === 'primary') {
                                classDoc = await getDoc(doc(db, 'primary_classes', classId));
                            } else {
                                classDoc = await getDoc(doc(db, 'kindergarten_classes', classId));
                            }
                            
                            if (!classDoc.exists()) {
                                showAlert('Classe non trouvée.', 'error');
                                return;
                            }
                            
                            const data = classDoc.data();
                            
                            // Remplir le formulaire de modification selon le type
                            if (classType === 'secondary') {
                                document.getElementById('class-name').value = data.name;
                                document.getElementById('class-level').value = data.level;
                                document.getElementById('class-capacity').value = data.capacity;
                                
                                // Mettre à jour le bouton pour modification
                                const submitBtn = document.querySelector('#class-form button[type="submit"]');
                                submitBtn.textContent = 'Modifier la Classe';
                                submitBtn.onclick = async (e) => {
                                    e.preventDefault();
                                    const name = document.getElementById('class-name').value;
                                    const level = document.getElementById('class-level').value;
                                    const capacity = document.getElementById('class-capacity').value;
                                    
                                    try {
                                        await updateDoc(doc(db, 'classes', classId), {
                                            name,
                                            level,
                                            capacity: parseInt(capacity),
                                            updatedAt: serverTimestamp()
                                        });
                                        
                                        showAlert('Classe secondaire modifiée avec succès !', 'success');
                                        document.getElementById('class-form').reset();
                                        submitBtn.textContent = 'Ajouter';
                                        submitBtn.onclick = null;
                                        loadClassesList();
                                        loadClassesIntoSelects();
                                        loadTeacherClasses();
                                    } catch (error) {
                                        showAlert('Erreur lors de la modification: ' + error.message, 'error');
                                    }
                                };
                            } else if (classType === 'primary') {
                                document.getElementById('primary-class-name').value = data.name;
                                document.getElementById('primary-class-level').value = data.level;
                                document.getElementById('primary-class-capacity').value = data.capacity;
                                
                                // Mettre à jour le bouton pour modification
                                const submitBtn = document.querySelector('#primary-class-form button[type="submit"]');
                                submitBtn.textContent = 'Modifier la Classe';
                                submitBtn.onclick = async (e) => {
                                    e.preventDefault();
                                    const name = document.getElementById('primary-class-name').value;
                                    const level = document.getElementById('primary-class-level').value;
                                    const capacity = document.getElementById('primary-class-capacity').value;
                                    
                                    try {
                                        await updateDoc(doc(db, 'primary_classes', classId), {
                                            name,
                                            level,
                                            capacity: parseInt(capacity),
                                            updatedAt: serverTimestamp()
                                        });
                                        
                                        showAlert('Classe primaire modifiée avec succès !', 'success');
                                        document.getElementById('primary-class-form').reset();
                                        submitBtn.textContent = 'Ajouter';
                                        submitBtn.onclick = null;
                                        loadPrimaryClassesList();
                                        loadClassesIntoSelects();
                                        loadPrimaryTeacherClasses();
                                    } catch (error) {
                                        showAlert('Erreur lors de la modification: ' + error.message, 'error');
                                    }
                                };
                            } else {
                                document.getElementById('kindergarten-class-name').value = data.name;
                                document.getElementById('kindergarten-class-level').value = data.level;
                                document.getElementById('kindergarten-class-capacity').value = data.capacity;
                                
                                // Mettre à jour le bouton pour modification
                                const submitBtn = document.querySelector('#kindergarten-class-form button[type="submit"]');
                                submitBtn.textContent = 'Modifier la Classe';
                                submitBtn.onclick = async (e) => {
                                    e.preventDefault();
                                    const name = document.getElementById('kindergarten-class-name').value;
                                    const level = document.getElementById('kindergarten-class-level').value;
                                    const capacity = document.getElementById('kindergarten-class-capacity').value;
                                    
                                    try {
                                        await updateDoc(doc(db, 'kindergarten_classes', classId), {
                                            name,
                                            level,
                                            capacity: parseInt(capacity),
                                            updatedAt: serverTimestamp()
                                        });
                                        
                                        showAlert('Classe maternelle modifiée avec succès !', 'success');
                                        document.getElementById('kindergarten-class-form').reset();
                                        submitBtn.textContent = 'Ajouter';
                                        submitBtn.onclick = null;
                                        loadKindergartenClassesList();
                                        loadClassesIntoSelects();
                                        loadKindergartenTeacherClasses();
                                    } catch (error) {
                                        showAlert('Erreur lors de la modification: ' + error.message, 'error');
                                    }
                                };
                            }
                            
                        } catch (error) {
                            showAlert('Erreur: ' + error.message, 'error');
                        }
                    };

                    // FONCTION DE SUPPRESSION DES CLASSES
                    window.deleteClass = async (classId, classType) => {
                        if (confirm('Êtes-vous sûr de vouloir supprimer cette classe ? Cette action est irréversible.')) {
                            try {
                                let classDoc, collectionName, studentCollection;
                                if (classType === 'secondary') {
                                    classDoc = await getDoc(doc(db, 'classes', classId));
                                    collectionName = 'classes';
                                    studentCollection = 'students';
                                } else if (classType === 'primary') {
                                    classDoc = await getDoc(doc(db, 'primary_classes', classId));
                                    collectionName = 'primary_classes';
                                    studentCollection = 'primary_students';
                                } else {
                                    classDoc = await getDoc(doc(db, 'kindergarten_classes', classId));
                                    collectionName = 'kindergarten_classes';
                                    studentCollection = 'kindergarten_students';
                                }
                                
                                if (!classDoc.exists()) {
                                    showAlert('Classe non trouvée.', 'error');
                                    return;
                                }
                                
                                const classData = classDoc.data();
                                
                                // Vérifier si des étudiants sont dans cette classe
                                const studentsInClass = await getDocs(query(collection(db, studentCollection), where('class', '==', classData.name)));
                                
                                if (!studentsInClass.empty) {
                                    showAlert(`Impossible de supprimer cette classe. ${studentsInClass.size} élève(s) sont encore inscrits dans cette classe.`, 'error');
                                    return;
                                }
                                
                                await deleteDoc(doc(db, collectionName, classId));
                                showAlert('Classe supprimée avec succès', 'success');
                                
                                if (classType === 'secondary') {
                                    loadClassesList();
                                } else if (classType === 'primary') {
                                    loadPrimaryClassesList();
                                } else {
                                    loadKindergartenClassesList();
                                }
                                
                                loadClassesIntoSelects();
                                loadTeacherClasses();
                                loadPrimaryTeacherClasses();
                                loadKindergartenTeacherClasses();
                            } catch (error) {
                                console.error('Erreur suppression classe:', error);
                                showAlert('Erreur lors de la suppression: ' + error.message, 'error');
                            }
                        }
                    };

                    // FONCTION DE SUPPRESSION DES ÉLÈVES (COMPLÈTE)
                    window.deleteStudent = async (studentMatricule, studentType) => {
                        if (confirm('Êtes-vous sûr de vouloir supprimer cet élève ? Cette action est irréversible.')) {
                            try {
                                let studentDoc, collectionName;
                                if (studentType === 'secondary') {
                                    studentDoc = await getDoc(doc(db, 'students', studentMatricule));
                                    collectionName = 'students';
                                } else if (studentType === 'primary') {
                                    studentDoc = await getDoc(doc(db, 'primary_students', studentMatricule));
                                    collectionName = 'primary_students';
                                } else {
                                    studentDoc = await getDoc(doc(db, 'kindergarten_students', studentMatricule));
                                    collectionName = 'kindergarten_students';
                                }
                                
                                if (!studentDoc.exists()) {
                                    showAlert('Élève non trouvé.', 'error');
                                    return;
                                }
                                
                                const studentData = studentDoc.data();
                                
                                // Marquer comme supprimé dans Firestore
                                await updateDoc(doc(db, collectionName, studentMatricule), {
                                    status: 'deleted',
                                    deletedAt: serverTimestamp(),
                                    deletedBy: currentSecretary.uid
                                });
                                
                                showAlert('Élève marqué comme supprimé', 'success');
                                loadStudentsList();
                                loadDashboardStats();
                            } catch (error) {
                                console.error('Erreur suppression élève:', error);
                                showAlert('Erreur lors de la suppression: ' + error.message, 'error');
                            }
                        }
                    };

                    // FONCTION DE SUPPRESSION DES ENSEIGNANTS (COMPLÈTE)
                    window.deleteTeacher = async (teacherMatricule, teacherType) => {
                        if (confirm('Êtes-vous sûr de vouloir supprimer cet enseignant ? Cette action est irréversible.')) {
                            try {
                                let teacherDoc, collectionName;
                                if (teacherType === 'secondary') {
                                    teacherDoc = await getDoc(doc(db, 'teachers', teacherMatricule));
                                    collectionName = 'teachers';
                                } else if (teacherType === 'primary') {
                                    teacherDoc = await getDoc(doc(db, 'primary_teachers', teacherMatricule));
                                    collectionName = 'primary_teachers';
                                } else {
                                    teacherDoc = await getDoc(doc(db, 'kindergarten_teachers', teacherMatricule));
                                    collectionName = 'kindergarten_teachers';
                                }
                                
                                if (!teacherDoc.exists()) {
                                    showAlert('Enseignant non trouvé.', 'error');
                                    return;
                                }
                                
                                const teacherData = teacherDoc.data();
                                
                                // Marquer comme supprimé dans Firestore
                                await updateDoc(doc(db, collectionName, teacherMatricule), {
                                    status: 'deleted',
                                    deletedAt: serverTimestamp(),
                                    deletedBy: currentSecretary.uid
                                });
                                
                                showAlert('Enseignant marqué comme supprimé', 'success');
                                loadTeachersList();
                                loadDashboardStats();
                            } catch (error) {
                                console.error('Erreur suppression enseignant:', error);
                                showAlert('Erreur lors de la suppression: ' + error.message, 'error');
                            }
                        }
                    };

                    window.validatePaymentByCode = async (paymentCode) => {
                        document.getElementById('payment-code-input').value = paymentCode;
                        document.getElementById('find-payment-btn').click();
                    };

                    // Gestion des formulaires de modification
                    document.getElementById('edit-student-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const studentId = document.getElementById('edit-student-id').value;
                        const fullName = document.getElementById('edit-student-name').value;
                        const birthdate = document.getElementById('edit-student-birthdate').value;
                        const birthplace = document.getElementById('edit-student-birthplace').value;
                        const gender = document.getElementById('edit-student-gender').value;
                        const address = document.getElementById('edit-student-address').value;
                        const phone = document.getElementById('edit-student-phone').value;
                        const studentClass = document.getElementById('edit-student-class').value;
                        const enrollmentFees = parseFloat(document.getElementById('edit-student-fees').value) || 0;
                        const parentName = document.getElementById('edit-parent-name').value;
                        const parentPhone = document.getElementById('edit-parent-phone').value;
                        const parentAddress = document.getElementById('edit-parent-address').value;
                        const status = document.getElementById('edit-student-status').value;
                        
                        // Déterminer le type d'élève et la collection
                        let collectionName = 'students';
                        const phoneField = document.getElementById('edit-student-phone').parentElement;
                        if (phoneField.style.display === 'none') {
                            if (phoneField.parentElement.querySelector('#edit-student-class option[value*="PS"]')) {
                                collectionName = 'kindergarten_students';
                            } else {
                                collectionName = 'primary_students';
                            }
                        }
                        
                        try {
                            const updateData = {
                                fullName,
                                birthdate,
                                birthplace,
                                gender,
                                address,
                                class: studentClass,
                                enrollmentFees,
                                parentName,
                                parentPhone,
                                parentAddress,
                                status,
                                updatedAt: serverTimestamp()
                            };
                            
                            // Ajouter le téléphone seulement pour les élèves secondaires
                            if (collectionName === 'students') {
                                updateData.phone = phone;
                            }
                            
                            await updateDoc(doc(db, collectionName, studentId), updateData);
                            
                            showAlert('Élève modifié avec succès !', 'success');
                            document.getElementById('edit-student-modal').classList.add('hidden');
                            loadStudentsList();
                        } catch (error) {
                            showAlert('Erreur lors de la modification: ' + error.message, 'error');
                        }
                    });

                    document.getElementById('edit-teacher-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const teacherId = document.getElementById('edit-teacher-id').value;
                        const fullName = document.getElementById('edit-teacher-name').value;
                        const birthdate = document.getElementById('edit-teacher-birthdate').value;
                        const birthplace = document.getElementById('edit-teacher-birthplace').value;
                        const gender = document.getElementById('edit-teacher-gender').value;
                        const address = document.getElementById('edit-teacher-address').value;
                        const phone = document.getElementById('edit-teacher-phone').value;
                        const subjects = document.getElementById('edit-teacher-subjects').value.split(',').map(s => s.trim());
                        const status = document.getElementById('edit-teacher-status').value;
                        
                        // Déterminer le type d'enseignant et la collection
                        let collectionName = 'teachers';
                        const subjectsField = document.getElementById('edit-teacher-subjects').parentElement;
                        if (subjectsField.style.display === 'none') {
                            if (subjectsField.parentElement.querySelector('#edit-teacher-classes-container label[for*="kindergarten"]')) {
                                collectionName = 'kindergarten_teachers';
                            } else {
                                collectionName = 'primary_teachers';
                            }
                        }
                        
                        // Récupérer les classes sélectionnées
                        const selectedClasses = [];
                        document.querySelectorAll('#edit-teacher-classes-container input[type="checkbox"]:checked').forEach(checkbox => {
                            selectedClasses.push(checkbox.value);
                        });
                        
                        try {
                            const updateData = {
                                fullName,
                                birthdate,
                                birthplace,
                                gender,
                                address,
                                phone,
                                classes: selectedClasses,
                                status,
                                updatedAt: serverTimestamp()
                            };
                            
                            // Ajouter les matières seulement pour les enseignants secondaires
                            if (collectionName === 'teachers') {
                                updateData.subjects = subjects;
                            }
                            
                            await updateDoc(doc(db, collectionName, teacherId), updateData);
                            
                            showAlert('Enseignant modifié avec succès !', 'success');
                            document.getElementById('edit-teacher-modal').classList.add('hidden');
                            loadTeachersList();
                        } catch (error) {
                            showAlert('Erreur lors de la modification: ' + error.message, 'error');
                        }
                    });

                    // Génération de reçu
                    async function generateReceipt(studentName, months, amount, paymentCode, studentClass, paymentType) {
                        const receiptContent = document.getElementById('receipt-content');
                        
                        const receiptHTML = `
                            <div class="receipt">
                                <div class="receipt-header">
                                    <div class="receipt-logo">
                                        <img src="R.png" alt="Logo CS la Colombe" style="max-width: 150px;">
                                    </div>
                                    <div class="receipt-title">REÇU DE PAIEMENT</div>
                                    <div>Complexe Scolaire la Colombe</div>
                                    <div>Code: ${paymentCode}</div>
                                </div>
                                
                                <div class="receipt-details">
                                    <div class="receipt-row">
                                        <span>Élève:</span>
                                        <span>${studentName}</span>
                                    </div>
                                    <div class="receipt-row">
                                        <span>Classe:</span>
                                        <span>${studentClass}</span>
                                    </div>
                                    <div class="receipt-row">
                                        <span>Type de frais:</span>
                                        <span>${paymentType || 'Frais scolaires'}</span>
                                    </div>
                                    <div class="receipt-row">
                                        <span>Mois:</span>
                                        <span>${months.join(', ')}</span>
                                    </div>
                                    <div class="receipt-row">
                                        <span>Montant:</span>
                                        <span class="currency-display">$${amount.toFixed(2)}</span>
                                    </div>
                                    <div class="receipt-divider"></div>
                                    <div class="receipt-row">
                                        <span>Date:</span>
                                        <span>${new Date().toLocaleDateString('fr-FR')}</span>
                                    </div>
                                    <div class="receipt-row">
                                        <span>Validé par:</span>
                                        <span>${currentSecretary.fullName}</span>
                                    </div>
                                </div>
                                
                                <div class="signature-area">
                                    <div class="signature-box">
                                        <p>Le Secrétaire</p>
                                        <div class="signature-line"></div>
                                    </div>
                                    <div class="signature-box">
                                        <p>Le Directeur</p>
                                        <div class="signature-line"></div>
                                    </div>
                                </div>
                                
                                <div class="receipt-footer">
                                    <p>Merci pour votre confiance</p>
                                    <p>Complexe Scolaire la Colombe</p>
                                </div>
                            </div>
                        `;
                        
                        receiptContent.innerHTML = receiptHTML;
                        document.getElementById('receipt-modal').classList.remove('hidden');
                    }

                    // Impression du reçu
                    document.getElementById('print-receipt-btn').addEventListener('click', () => {
                        const receiptContent = document.getElementById('receipt-content').innerHTML;
                        const printWindow = window.open('', '_blank');
                        
                        const printHTML = `
                            <!DOCTYPE html>
                            <html>
                                <head>
                                    <title>Reçu de paiement - CS la Colombe</title>
                                    <style>
                                        body { 
                                            font-family: Arial, sans-serif; 
                                            margin: 20px; 
                                            font-size: 12px;
                                        }
                                        .receipt { 
                                            max-width: 600px; 
                                            margin: 0 auto; 
                                            border: 1px solid #ddd; 
                                            padding: 20px; 
                                        }
                                        .receipt-header { 
                                            text-align: center; 
                                            margin-bottom: 20px; 
                                            border-bottom: 2px solid #3498db; 
                                            padding-bottom: 1rem; 
                                        }
                                        .receipt-title { 
                                            font-size: 18px; 
                                            font-weight: bold; 
                                            margin: 10px 0; 
                                            color: #3498db; 
                                        }
                                        .receipt-row { 
                                            display: flex; 
                                            justify-content: space-between; 
                                            margin-bottom: 8px; 
                                        }
                                        .receipt-divider { 
                                            border-top: 1px solid #ddd; 
                                            margin: 15px 0; 
                                        }
                                        .signature-area { 
                                            margin-top: 3rem; 
                                            display: flex; 
                                            justify-content: space-between; 
                                        }
                                        .signature-box { 
                                            text-align: center; 
                                            width: 45%; 
                                        }
                                        .signature-line { 
                                            border-top: 1px solid #000; 
                                            margin-top: 3rem; 
                                        }
                                        .receipt-footer { 
                                            text-align: center; 
                                            margin-top: 20px; 
                                            font-size: 11px; 
                                            color: #666; 
                                            border-top: 1px solid #eee; 
                                            padding-top: 1rem; 
                                        }
                                        .currency-display { 
                                            font-weight: bold; 
                                            color: #27ae60; 
                                        }
                                        @media print {
                                            body { 
                                                margin: 0; 
                                                padding: 10px;
                                            }
                                            .receipt { 
                                                border: none; 
                                                box-shadow: none; 
                                            }
                                            .no-print {
                                                display: none !important;
                                            }
                                        }
                                    </style>
                                </head>
                                <body>
                                    ${receiptContent}
                                    <script>
                                        window.onload = function() {
                                            window.print();
                                            setTimeout(function() {
                                                window.close();
                                            }, 1000);
                                        }
                                    <\/script>
                                </body>
                            </html>
                        `;
                        
                        printWindow.document.write(printHTML);
                        printWindow.document.close();
                    });

                    // Impression du bordereau d'inscription
                    window.printEnrollmentForm = async (studentType) => {
                        try {
                            if (!lastEnrolledStudent) {
                                showAlert("Aucun élève n'a été inscrit récemment.", "error");
                                return;
                            }
                            
                            const studentData = lastEnrolledStudent;
                            const enrollmentSlipContent = document.getElementById('enrollment-slip-content');
                            
                            const studentTypeText = studentType === 'secondary' ? 'Secondaire' : 
                                                  studentType === 'primary' ? 'Primaire' : 'Maternelle';
                            
                            const enrollmentSlipHTML = `
                                <div class="receipt">
                                    <div class="receipt-header">
                                        <div class="receipt-logo">
                                            <img src="R.png" alt="Logo CS la Colombe" style="max-width: 150px;">
                                        </div>
                                        <div class="receipt-title">BORDEREAU D'INSCRIPTION</div>
                                        <div>Complexe Scolaire la Colombe</div>
                                        <div>Année scolaire: ${new Date().getFullYear()}-${new Date().getFullYear() + 1}</div>
                                    </div>
                                    
                                    <div class="receipt-details">
                                        <div class="receipt-row">
                                            <span>Matricule:</span>
                                            <span><strong>${studentData.matricule}</strong></span>
                                        </div>
                                        <div class="receipt-row">
                                            <span>Nom complet:</span>
                                            <span>${studentData.fullName}</span>
                                        </div>
                                        <div class="receipt-row">
                                            <span>Type:</span>
                                            <span>${studentTypeText}</span>
                                        </div>
                                        <div class="receipt-row">
                                            <span>Classe:</span>
                                            <span>${studentData.class}</span>
                                        </div>
                                        <div class="receipt-row">
                                            <span>Date de naissance:</span>
                                            <span>${studentData.birthdate}</span>
                                        </div>
                                        <div class="receipt-row">
                                            <span>Lieu de naissance:</span>
                                            <span>${studentData.birthplace || 'Non spécifié'}</span>
                                        </div>
                                        <div class="receipt-row">
                                            <span>Sexe:</span>
                                            <span>${studentData.gender === 'M' ? 'Masculin' : 'Féminin'}</span>
                                        </div>
                                        <div class="receipt-row">
                                            <span>Adresse:</span>
                                            <span>${studentData.address}</span>
                                        </div>
                                        ${studentType === 'secondary' ? `
                                        <div class="receipt-row">
                                            <span>Téléphone:</span>
                                            <span>${studentData.phone || 'Non spécifié'}</span>
                                        </div>` : ''}
                                        <div class="receipt-divider"></div>
                                        <div class="receipt-row">
                                            <span>Nom du parent:</span>
                                            <span>${studentData.parentName}</span>
                                        </div>
                                        <div class="receipt-row">
                                            <span>Téléphone du parent:</span>
                                            <span>${studentData.parentPhone}</span>
                                        </div>
                                        <div class="receipt-row">
                                            <span>Adresse du parent:</span>
                                            <span>${studentData.parentAddress || 'Non spécifié'}</span>
                                        </div>
                                        <div class="receipt-divider"></div>
                                        <div class="receipt-row">
                                            <span>Frais d'inscription:</span>
                                            <span class="currency-display"><strong>$${(studentData.enrollmentFees || 0).toFixed(2)}</strong></span>
                                        </div>
                                        <div class="receipt-row">
                                            <span>Date d'inscription:</span>
                                            <span>${new Date().toLocaleDateString('fr-FR')}</span>
                                        </div>
                                        <div class="receipt-row">
                                            <span>Inscrit par:</span>
                                            <span>${currentSecretary.fullName}</span>
                                        </div>
                                    </div>
                                    
                                    <div class="signature-area">
                                        <div class="signature-box">
                                            <p>Le Secrétaire</p>
                                            <div class="signature-line"></div>
                                        </div>
                                        <div class="signature-box">
                                            <p>Le Directeur</p>
                                            <div class="signature-line"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="receipt-footer">
                                        <p><strong>Important:</strong> Conservez ce bordereau pour toute référence future.</p>
                                        <p>Merci pour votre confiance - Complexe Scolaire la Colombe</p>
                                    </div>
                                </div>
                            `;
                            
                            enrollmentSlipContent.innerHTML = enrollmentSlipHTML;
                            document.getElementById('enrollment-slip-modal').classList.remove('hidden');
                            
                        } catch (error) {
                            console.error("Erreur génération bordereau:", error);
                            showAlert("Erreur lors de la génération du bordereau", "error");
                        }
                    };

                    // Bouton impression du bordereau
                    document.getElementById('print-enrollment-slip-btn').addEventListener('click', () => {
                        const enrollmentSlipContent = document.getElementById('enrollment-slip-content').innerHTML;
                        const printWindow = window.open('', '_blank');
                        
                        const printHTML = `
                            <!DOCTYPE html>
                            <html>
                                <head>
                                    <title>Bordereau d'inscription - CS la Colombe</title>
                                    <style>
                                        body { 
                                            font-family: Arial, sans-serif; 
                                            margin: 20px; 
                                            font-size: 12px;
                                        }
                                        .receipt { 
                                            max-width: 600px; 
                                            margin: 0 auto; 
                                            border: 1px solid #ddd; 
                                            padding: 20px; 
                                        }
                                        .receipt-header { 
                                            text-align: center; 
                                            margin-bottom: 20px; 
                                            border-bottom: 2px solid #3498db; 
                                            padding-bottom: 1rem; 
                                        }
                                        .receipt-title { 
                                            font-size: 18px; 
                                            font-weight: bold; 
                                            margin: 10px 0; 
                                            color: #3498db; 
                                        }
                                        .receipt-row { 
                                            display: flex; 
                                            justify-content: space-between; 
                                            margin-bottom: 8px; 
                                        }
                                        .receipt-divider { 
                                            border-top: 1px solid #ddd; 
                                            margin: 15px 0; 
                                        }
                                        .signature-area { 
                                            margin-top: 3rem; 
                                            display: flex; 
                                            justify-content: space-between; 
                                        }
                                        .signature-box { 
                                            text-align: center; 
                                            width: 45%; 
                                        }
                                        .signature-line { 
                                            border-top: 1px solid #000; 
                                            margin-top: 3rem; 
                                        }
                                        .receipt-footer { 
                                            text-align: center; 
                                            margin-top: 20px; 
                                            font-size: 11px; 
                                            color: #666; 
                                            border-top: 1px solid #eee; 
                                            padding-top: 1rem; 
                                        }
                                        .currency-display { 
                                            font-weight: bold; 
                                            color: #27ae60; 
                                        }
                                        @media print {
                                            body { 
                                                margin: 0; 
                                                padding: 10px;
                                            }
                                            .receipt { 
                                                border: none; 
                                                box-shadow: none; 
                                            }
                                            .no-print {
                                                display: none !important;
                                            }
                                        }
                                    </style>
                                </head>
                                <body>
                                    ${enrollmentSlipContent}
                                    <script>
                                        window.onload = function() {
                                            window.print();
                                            setTimeout(function() {
                                                window.close();
                                            }, 1000);
                                        }
                                    <\/script>
                                </body>
                            </html>
                        `;
                        
                        printWindow.document.write(printHTML);
                        printWindow.document.close();
                    });

                    // Bouton retour pour le bordereau
                    document.getElementById('back-enrollment-slip-btn').addEventListener('click', () => {
                        document.getElementById('enrollment-slip-modal').classList.add('hidden');
                    });

                    // Bouton retour pour le reçu
                    document.getElementById('back-receipt-btn').addEventListener('click', () => {
                        document.getElementById('receipt-modal').classList.add('hidden');
                    });

                    // Export functions
                    document.getElementById('export-students-btn').addEventListener('click', async () => {
                        try {
                            let csvContent = "Matricule,Nom,Type,Classe,Frais d'inscription,Date d'inscription,Statut\n";
                            
                            // Élèves secondaires
                            const studentsSnap = await getDocs(query(collection(db, 'students'), where('status', '!=', 'deleted')));
                            studentsSnap.forEach(doc => {
                                const data = doc.data();
                                csvContent += `"${data.matricule}","${data.fullName}","Secondaire","${data.class}","${data.enrollmentFees || 0}","${formatDate(data.createdAt?.toDate())}","${data.status}"\n`;
                            });
                            
                            // Élèves primaires
                            const primaryStudentsSnap = await getDocs(query(collection(db, 'primary_students'), where('status', '!=', 'deleted')));
                            primaryStudentsSnap.forEach(doc => {
                                const data = doc.data();
                                csvContent += `"${data.matricule}","${data.fullName}","Primaire","${data.class}","${data.enrollmentFees || 0}","${formatDate(data.createdAt?.toDate())}","${data.status}"\n`;
                            });
                            
                            // Élèves maternelles
                            const kindergartenStudentsSnap = await getDocs(query(collection(db, 'kindergarten_students'), where('status', '!=', 'deleted')));
                            kindergartenStudentsSnap.forEach(doc => {
                                const data = doc.data();
                                csvContent += `"${data.matricule}","${data.fullName}","Maternelle","${data.class}","${data.enrollmentFees || 0}","${formatDate(data.createdAt?.toDate())}","${data.status}"\n`;
                            });
                            
                            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                            const link = document.createElement('a');
                            const url = URL.createObjectURL(blob);
                            link.setAttribute('href', url);
                            link.setAttribute('download', `eleves_cs_lacolombe_${new Date().toISOString().split('T')[0]}.csv`);
                            link.style.visibility = 'hidden';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            
                            showAlert('Liste des élèves téléchargée avec succès', 'success');
                        } catch (error) {
                            showAlert('Erreur lors du téléchargement: ' + error.message, 'error');
                        }
                    });

                    document.getElementById('export-teachers-btn').addEventListener('click', async () => {
                        try {
                            let csvContent = "Matricule,Nom,Type,Téléphone,Matières,Classes,Date d'inscription,Statut\n";
                            
                            // Enseignants secondaires
                            const teachersSnap = await getDocs(query(collection(db, 'teachers'), where('status', '!=', 'deleted')));
                            teachersSnap.forEach(doc => {
                                const data = doc.data();
                                csvContent += `"${data.matricule}","${data.fullName}","Secondaire","${data.phone || ''}","${data.subjects.join(', ')}","${data.classes ? data.classes.join(', ') : ''}","${formatDate(data.createdAt?.toDate())}","${data.status}"\n`;
                            });
                            
                            // Enseignants primaires
                            const primaryTeachersSnap = await getDocs(query(collection(db, 'primary_teachers'), where('status', '!=', 'deleted')));
                            primaryTeachersSnap.forEach(doc => {
                                const data = doc.data();
                                csvContent += `"${data.matricule}","${data.fullName}","Primaire","${data.phone || ''}","Toutes matières","${data.classes ? data.classes.join(', ') : ''}","${formatDate(data.createdAt?.toDate())}","${data.status}"\n`;
                            });
                            
                            // Enseignants maternelles
                            const kindergartenTeachersSnap = await getDocs(query(collection(db, 'kindergarten_teachers'), where('status', '!=', 'deleted')));
                            kindergartenTeachersSnap.forEach(doc => {
                                const data = doc.data();
                                csvContent += `"${data.matricule}","${data.fullName}","Maternelle","${data.phone || ''}","Toutes matières","${data.classes ? data.classes.join(', ') : ''}","${formatDate(data.createdAt?.toDate())}","${data.status}"\n`;
                            });
                            
                            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                            const link = document.createElement('a');
                            const url = URL.createObjectURL(blob);
                            link.setAttribute('href', url);
                            link.setAttribute('download', `enseignants_cs_lacolombe_${new Date().toISOString().split('T')[0]}.csv`);
                            link.style.visibility = 'hidden';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            
                            showAlert('Liste des enseignants téléchargée avec succès', 'success');
                        } catch (error) {
                            showAlert('Erreur lors du téléchargement: ' + error.message, 'error');
                        }
                    });

                    // Fermer les modals
                    document.querySelectorAll('.close-modal').forEach(btn => {
                        btn.addEventListener('click', () => {
                            document.querySelectorAll('.modal').forEach(modal => modal.classList.add('hidden'));
                        });
                    });

                    // Fermer les modals en cliquant à l'extérieur
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.addEventListener('click', (e) => {
                            if (e.target === modal) {
                                modal.classList.add('hidden');
                            }
                        });
                    });

                    // Gestion du menu burger
                    document.getElementById('menu-toggle').addEventListener('click', () => {
                        document.querySelector('.sidebar').classList.toggle('collapsed');
                    });

                    // Fermer le menu en cliquant à l'extérieur sur mobile
                    document.addEventListener('click', (e) => {
                        const sidebar = document.querySelector('.sidebar');
                        const menuToggle = document.getElementById('menu-toggle');
                        
                        if (window.innerWidth <= 768 && 
                            !sidebar.contains(e.target) && 
                            !menuToggle.contains(e.target) &&
                            !sidebar.classList.contains('collapsed')) {
                            sidebar.classList.add('collapsed');
                        }
                    });
                   </script>
</body>
</html>
